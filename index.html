<html>
	<head>
		<link href="style.css" rel="stylesheet" type="text/css">
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	</head>
	<body>


  

    

    

    
      <div id="lesson-content">
  <h2 id="finally">Finally</h2>
<p>We've discussed most of the things you need to know about managing time-series data with Meteor and MongoDB. First, we talked about how to accept high-velocity data with Meteor and send them to MongoDB. After that we talked about how to model the database for storing time-series data. Finally, we talked about managing time zones.</p>
<p>With this knowledge you can build a pretty decent back-end for high-velocity time-series data. If you start to receive a lot of data, you may need to add more servers and add some other components in between. But, now you've a solid foundation for getting started quickly while minimizing a lot of the issues.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Searching is a core functionality in most of the apps. In this lesson, we're going to discuss how we can use MongoDB to search documents. We can use two different methods:</p>
<ol>
<li>Regular Expression Search</li>
<li>Full Text Search</li>
</ol>
<p>Each of methods has its own pros and cons,  and we're going discuss most of them. That should help you decide which method to use with your app.</p>
<p>Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>We’re working with a sample app to try out both Regular Expression Search and Full Text Search. This app is a very simple phonebook. It lists both the name and the phone number.</p>
<p>There’s a search box on the top, which allows you to search names and list them</p>
<p><img src="img/jv8s3LZQyF.png" alt="My Phone Book"></p>
<p>Clone the following repo:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-mongo-search.git</span>
</code></pre><p>Try to run the cloned app. Were you able to search any names?</p>

  

  <div class="radio">
    <label>
      
        <input value="Yes" id="lesson-answer" name="lesson-answer" type="radio">
      
      Yes
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <input value="No" id="lesson-answer" name="lesson-answer" type="radio">
      
      No
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="regular-expression-searching">Regular Expression Searching</h2>
<p>Our phonebook app's search system isn’t working. That's because we haven’t implemented it yet! Here's the current publication that sends phonebook entries to the client.</p>
<pre><code class="hljs javascript"><span class="hljs-comment">// location: /server/app.js</span>

Meteor.publish(<span class="hljs-string">'getEntries'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText)</span> </span>{
  <span class="hljs-keyword">return</span> Entries.find({}, {sort: {name: <span class="hljs-number">1</span>}, limit:<span class="hljs-number">20</span>});
});
</code></pre><p>Here’s a sample phonebook entry:</p>
<pre><code class="hljs css"><span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> <span class="hljs-string">"random-id"</span>, name: <span class="hljs-string">"Arunoda Susiripala"</span>, phoneNo: <span class="hljs-string">"0094778446623"</span></span></span></span>}
</code></pre><p>Now, we’re going to use Regular Expression Search to enable searching in our app. It's very easy: we only need to query the <code>name</code> field with a regular expression. Here's the modified version of the <code>getEntries</code> publication with Regular Expression Search code:</p>
<pre><code class="hljs javascript">Meteor.publish(<span class="hljs-string">'getEntries'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText)</span> </span>{
  <span class="hljs-comment">// second paramter 'i' indicates that we want our regular expression to be case-insensitive.</span>
  <span class="hljs-keyword">var</span> filter = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(searchText, <span class="hljs-string">'i'</span>);
  <span class="hljs-keyword">return</span> Entries.find({name: filter}, {sort: {name: <span class="hljs-number">1</span>}, limit:<span class="hljs-number">20</span>});
});
</code></pre><p>With the above publication, you'll be able to search entries from the UI.</p>
<p>Now it's your turn. From the list below, select the option that is <strong>not</strong> satisfied with Regular Expression searching:</p>
<blockquote>
<p>If you need to add new phonebook entries, you can do it by invoking <code>AddEntry("Name", "PhoneNo")</code> in the browser console.</p>
</blockquote>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Regular Expression Search is real-time
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Regular Expression Search can match partial words
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Regular Expression Search is very efficient
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Regular Expression Search does not support wildcard searches
    </label>
  </div>
  

  
    <p>
      Correct answer is : Regular Expression Search is very efficient
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="regular-expression-search-with-indexes">Regular Expression Search with Indexes</h2>
<p>As you've already experienced, Regular Expression Search is real-time, and it can match partial words. But our current implementation is <strong>inefficient</strong>. That's because it needs to read all documents from the disk and evaluate the regular expression command against them.</p>
<p>Also, applying regular expressions is an expensive operation. We're going to talk about that in a moment. For now, let's try to improve Regular Expression Search by adding an index.</p>
<p>First of all, open another terminal and visit the app directory. Next, invoke <code>meteor mongo</code> and connect to the MongoDB instance of your app. Then apply the following query and get the "explain()" report:</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.find</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> new <span class="hljs-function">RegExp</span>(<span class="hljs-string">"Tom"</span>)</span></span></span>})<span class="hljs-class">.explain</span>()
</code></pre><p>You'll get something like the following:</p>
<blockquote>
<p>Your numbers can be slightly different.</p>
</blockquote>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">cursor</span>" : <span class="hljs-value"><span class="hljs-string">"BasicCursor"</span></span>,
  "<span class="hljs-attribute">isMultiKey</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">n</span>" : <span class="hljs-value"><span class="hljs-number">6</span></span>,
  "<span class="hljs-attribute">nscannedObjects</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">nscanned</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">nscannedObjectsAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">nscannedAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">scanAndOrder</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">indexOnly</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">nYields</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">nChunkSkips</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">millis</span>" : <span class="hljs-value"><span class="hljs-number">12</span></span>,
  "<span class="hljs-attribute">indexBounds</span>" : <span class="hljs-value">{

  }</span>,
  "<span class="hljs-attribute">server</span>" : <span class="hljs-value"><span class="hljs-string">"Arunodas-Mac:8001"</span>
</span>}
</code></pre><p>First of all, let's review a few important fields in the above document:</p>
<ul>
<li>cursor – Cursor type and the index used for the query (BasicCursor is the default)</li>
<li>n – Number of documents that match the query</li>
<li>nscannedObjects – Total number of documents scanned from the disk (or memory, if documents are cached)</li>
<li>nscanned – Total number of index entries scanned (this is the same as <code>nscannedObjects</code> if no index is applied for the query)</li>
</ul>
<p>So it's clear that the above query doesn't have an index, and it needs to scan <code>10000</code> objects to return six matching documents. We can improve the following numbers by simply adding an index as shown below:</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.ensureIndex</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"><span class="hljs-number">1</span></span></span></span>})
</code></pre><p>Now, take another "explain" report and select the correct statement from the list below:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      "nscanned" and "n" numbers are equal
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "nscannedObjects" and "n" numbers are equal
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "nscannedObjects" and "nscanned" numbers are equal
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      value for cursor is "BtreeCursor"
    </label>
  </div>
  

  
    <p>
      Correct answer is : "nscannedObjects" and "n" numbers are equal
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>After adding an index, we get an "explain" report as follows:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">cursor</span>" : <span class="hljs-value"><span class="hljs-string">"BtreeCursor name_1 multi"</span></span>,
"<span class="hljs-attribute">isMultiKey</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">n</span>" : <span class="hljs-value"><span class="hljs-number">6</span></span>,
  "<span class="hljs-attribute">nscannedObjects</span>" : <span class="hljs-value"><span class="hljs-number">6</span></span>,
  "<span class="hljs-attribute">nscanned</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">nscannedObjectsAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">6</span></span>,
  "<span class="hljs-attribute">nscannedAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">10000</span></span>,
  "<span class="hljs-attribute">scanAndOrder</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">indexOnly</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">nYields</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">nChunkSkips</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">millis</span>" : <span class="hljs-value"><span class="hljs-number">2</span></span>,
  "<span class="hljs-attribute">server</span>" : <span class="hljs-value"><span class="hljs-string">"Arunodas-Mac:5006"</span>
</span>}
</code></pre><p>According to the "explain" report, only six actual documents have been scanned—which is a great improvement. But still, we had to scan 10,000 indexes to find those six matching documents — which is not a good sign.</p>
<h2 id="using-a-prefix-expression">Using a Prefix Expression</h2>
<p>We can further optimize our Regular Expression Search by using a prefix expression. This means that if the Regular Expression starts to search fields from the very beginning of the index, then it can do a better job. This is what's meant by that:</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.find</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> new <span class="hljs-function">RegExp</span>(<span class="hljs-string">"^Tom"</span>)</span></span></span>})<span class="hljs-class">.explain</span>()
</code></pre><p>This query is very fast, and we can see it from the "explain" report:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">cursor</span>" : <span class="hljs-value"><span class="hljs-string">"BtreeCursor name_1 multi"</span></span>,
  "<span class="hljs-attribute">isMultiKey</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">n</span>" : <span class="hljs-value"><span class="hljs-number">5</span></span>,
  "<span class="hljs-attribute">nscannedObjects</span>" : <span class="hljs-value"><span class="hljs-number">5</span></span>,
  "<span class="hljs-attribute">nscanned</span>" : <span class="hljs-value"><span class="hljs-number">5</span></span>,
  "<span class="hljs-attribute">nscannedObjectsAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">5</span></span>,
  "<span class="hljs-attribute">nscannedAllPlans</span>" : <span class="hljs-value"><span class="hljs-number">5</span></span>,
  "<span class="hljs-attribute">scanAndOrder</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">indexOnly</span>" : <span class="hljs-value"><span class="hljs-literal">false</span></span>,
  "<span class="hljs-attribute">nYields</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">nChunkSkips</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">millis</span>" : <span class="hljs-value"><span class="hljs-number">0</span></span>,
  "<span class="hljs-attribute">indexBounds</span>" : <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>" : <span class="hljs-value">[
      [
        <span class="hljs-string">"Tom"</span>,
        <span class="hljs-string">"Ton"</span>
      ],
      [
        /^Tom/,
        /^Tom/
      ]
    ]
  </span>}</span>,
  "<span class="hljs-attribute">server</span>" : <span class="hljs-value"><span class="hljs-string">"Arunodas-Mac:8001"</span>
</span>}
</code></pre><p>Now, you can see that the values for "n", "nscannedObjects", and "nscanned" are the same.</p>
<p>But if you added the "i" option when initializing the regular expression, as shown below, performance will be downgraded.</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.find</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> new <span class="hljs-function">RegExp</span>(<span class="hljs-string">"^Tom"</span>, <span class="hljs-string">"i"</span>)</span></span></span>})<span class="hljs-class">.explain</span>()
</code></pre><p>Therefore, the performance of the query will vary according to the way you write your regular expression. Here’s MongoDB documentation about that: <a target="_blank" href="http://docs.mongodb.org/manual/reference/operator/query/regex/#index-use">Regular Expressions and indexes</a></p>
<blockquote>
<p>Normally, it isn’t possible to use "prefix expressions" in a typical application, because:</p>
<ul>
<li>It can't search texts in the middle of a sentence</li>
<li>It can't use case-insensitive flags</li>
</ul>
</blockquote>
<p>Now, it's time for a question.</p>
<p>From the following regular expressions, which solution would perform better than the others? (try to get "explain” reports if you need them):</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      new Regular Expression('John', 'i')
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      new Regular Expression('^John', 'i')
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      new Regular Expression('John$')
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      new Regular Expression('^John')
    </label>
  </div>
  

  
    <p>
      Correct answer is : new Regular Expression('^John')
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="full-text-search">Full Text Search</h2>
<p>We've identified that Regular Expression Search is very easy to use, and it supports real-time queries with Meteor out of the box. But it's inefficient if you need to search a lot of documents even with an index.</p>
<p>This is a known problem in the MongoDB community, so they introduced experimental Full Text Search support with MongoDB 2.4. They removed the experimental flag with MongoDB 2.6, and it's enabled by default. </p>
<h3 id="what-is-full-text-search-">What is Full Text Search?</h3>
<p>With Full Text Search you can search a text document very easily and quickly. You can specify a language for the search, and then it knows how to search effectively. For example, if you search for the term "dependency", Full Text Search is smart enough to search documents with the term "dependencies" as well. </p>
<p>There are many functionalities in Full Text Search, so it will get vary depending on the implementation. <a target="_blank" href="http://docs.mongodb.org/manual/core/index-text/">MongoDB's Full Text Search</a> support is decent, and you can learn more about it <a target="_blank" href="http://docs.mongodb.org/manual/core/index-text/#supported-languages-and-stop-words">here</a>.</p>
<p>Let's see how we can use MongoDB Full Text Search with Meteor.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up-for-full-text-search">Setting Up for Full Text Search</h2>
<blockquote>
<p>You need MongoDB 2.6 for full text search support. Meteor 1.1 comes with MongoDB 2.6 by default. So, you can try locally very easily. <br><br>When you are deploying into production, make sure your production database is MongoDB 2.6.</p>
</blockquote>
<h3 id="start-our-app">Start Our App</h3>
<p>Check out the <code>full-text-search</code> branch of our demo app:</p>
<pre><code class="hljs nginx"><span class="hljs-comment"># clear local changes</span>
<span class="hljs-title">git</span> checkout .
<span class="hljs-comment"># checkout the branch</span>
git checkout full-text-search
</code></pre><p>Next, start our app:</p>
<pre><code class="hljs ruby"><span class="hljs-prompt">meteor -p &lt;any port you wish&gt;</span>
</code></pre><p>Our app will start, and it's using the <code>search</code> database as previously.</p>
<p>Now, our phonebook app uses MongoDB Full Text Search support to power its search. Play around with the app. You'll have an experience like <a target="_blank" href="img/hM_7HhUQO0.gif">this</a>.</p>
<p>Now it's question time!</p>
<p>After you've tried the new search functionality, select the statement that applies  from the list below:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Search does not work
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      I have to type the complete word to search
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      I can quickly search partial words
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Search works, but is incorrect
    </label>
  </div>
  

  
    <p>
      Correct answer is : I have to type the complete word to search
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>With MongoDB Full Text Search, you need to enter the whole word to search it. It does not support partial words, as seems to work with regular expressions.</p>
<h3 id="using-full-text-search">Using Full Text Search</h3>
<p>Using Full Text Search is very simple. First you need to select a <strong>field</strong> that contains the texts to be searched. Then you can create an index for it, as shown below using the mongo shell:</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.ensureIndex</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> <span class="hljs-string">"text"</span></span></span></span>});
</code></pre><p>That's how we can add a text index for the <code>name</code> field of the entries collection. </p>
<blockquote>
<p>You are allowed to create <strong>only one</strong> text index per collection.</p>
</blockquote>
<p>You can also create the index using Meteor. Check <code>lib/collection.js</code> on our cloned app for that.</p>
<h3 id="querying">Querying</h3>
<p>Querying is very simple. You can simply create a cursor like the following to use our text search.</p>
<pre><code class="hljs css"><span class="hljs-tag">Entries</span><span class="hljs-class">.find</span>(<span class="hljs-rules">{<span class="hljs-rule">$<span class="hljs-attribute">text</span>:<span class="hljs-value"> {$search: searchText</span></span></span>}});
</code></pre><p>You don't need to install any special package for this—it just works with Meteor. Our cloned app's search-related code is available under <code>server/app.js</code>.</p>
<p>We can also write some advanced queries with our text index, as shown below:</p>
<pre><code class="hljs css"><span class="hljs-tag">Entries</span><span class="hljs-class">.find</span>(<span class="hljs-rules">{<span class="hljs-rule">$<span class="hljs-attribute">text</span>:<span class="hljs-value"> {$search: searchText</span></span></span>}, <span class="hljs-tag">age</span>: <span class="hljs-rules">{<span class="hljs-rule">$<span class="hljs-attribute">gt</span>:<span class="hljs-value"> <span class="hljs-number">25</span></span></span></span>}});
</code></pre><p>It will use the text index. But you can optimize the index even more by using a separate index like the following:</p>
<pre><code class="hljs css"><span class="hljs-tag">db</span><span class="hljs-class">.entries</span><span class="hljs-class">.ensureIndex</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> <span class="hljs-string">"text"</span>, age: <span class="hljs-number">1</span></span></span></span>});
</code></pre><p>Nevertheless, you can only specify one text index per collection.</p>
<h3 id="oplog-support">Oplog Support</h3>
<p>Our search query(cursor) does not support oplog tailing. Do you want to know why? If so, you can use Kadira. Refer to this <a target="_blank" href="https://kadira.io/academy/optimize-your-app-for-oplog/">article</a>.</p>
<p>Can you select the reason why full text is not supported by oplog?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      a limit specified without a sort
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      $text command is not supported by meteor oplog tailing
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      oplog support is not enabled for this app
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      MongoDB 2.6 does not support oplog tailing with Meteor
    </label>
  </div>
  

  
    <p>
      Correct answer is : $text command is not supported by meteor oplog tailing
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Meteor's oplog tailing support heavily depends on <a target="_blank" href="https://atmospherejs.com/meteor/minimongo">MiniMongo</a>. It uses some of the functionalities of MiniMongo inside the server, but MiniMongo does not support <code>$text</code> command or full text search. </p>
<p>That's why we can't use Meteor's oplog tailing with MongoDB Full Text Search.</p>
<p>Check out the following Kadira trace, which demonstrates the problem we've just discussed.</p>
<p><img src="img/R-VeCCG5dd.png" alt="MongoDB Full Text Search is not supported by Meteor's oplog tailing"></p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with MongoDB</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-mongodb/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-mongodb/5">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-mongodb/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-mongodb/8">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-mongodb/9">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="regular-expression-search-vs-full-text-search">Regular Expression Search vs. Full Text Search</h2>
<p>This is a very interesting and important topic. Actually, neither of these solutions is 100% perfect. That's why we need to choose one over the other for different use cases.</p>
<h3 id="when-to-use-regular-expression-search">When to Use Regular Expression Search</h3>
<p>Here are some of the places you can use Regular Expression Search:</p>
<ul>
<li>If you need real-time searching capabilities</li>
<li>If your dataset size is not more than few thousand documents</li>
<li>If you need partial word matching</li>
<li>If you need to save disk space</li>
</ul>
<h3 id="when-to-use-full-text-search">When to Use Full Text Search</h3>
<ul>
<li>If your dataset is big, and you need high-performance search results</li>
<li>If you can afford more disk space</li>
<li>If you need language-specific search requirements</li>
<li>If you don't need real-time search (actually, real-time updates)</li>
</ul>
<blockquote>
<p>It is very important <strong>not</strong> to create publications contain Full Text Search–related queries. Since it does not support oplog tailing, Meteor will poll the db for changes. This could be very costly for both Meteor and MongoDB.</p>
<p>So if you’re going with Full Text Search, always get data from a method rather than by using a publication.</p>
</blockquote>
<p>If you’re going to use Full Text Search, you need to allocate enough space and memory for your MongoDB instance. You can learn about this in detail <a target="_blank" href="http://docs.mongodb.org/manual/core/index-text/#storage-requirements-and-performance-costs">here</a>.</p>
<h3 id="other-options">Other Options</h3>
<p>It's clear that both of the above solutions are very limited in functionality and have some issues. That's why MongoDB is not a good solution for searching. Therefore, you may need to use some other solutions. Here are two of the best:</p>
<ul>
<li><a target="_blank" href="http://www.elasticsearch.org/">Elastic Search</a>—One of best open source search solutions</li>
<li><a target="_blank" href="https://www.algolia.com/">Algolia</a>—A cloud-based solution</li>
</ul>
<p>In an upcoming lesson, we'll talk about how to use Elastic Search with Meteor. You may also have had some good search experiences. If so, please share those with us in the comments section.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the <a href="/database-modeling/searching-with-mongodb">previous lesson</a>, we studied how we can use MongoDB to implement search functionality for a Meteor app. There we studied both regular expression search and full text search. They provide decent searching functionality, but they have their own issues and limitations.</p>
<p>Sometimes we need a better search solution with the following characteristics:</p>
<ul>
<li>Fast search results</li>
<li>Prefix matching</li>
<li>Phrase matching</li>
<li>Fuzzy search</li>
<li>Give a score to search result items (so we can sort them)</li>
</ul>
<p>There is a tool that does a better job at searching: <a href="https://www.elastic.co/products/elasticsearch">Elastic Search</a>. It's one of the best searching solutions and is used by many high-profile companies. Just to give you an example, <a href="http://www.elasticsearch.org/case-study/github/">GitHub uses</a> Elastic Search to power its search.</p>
<p>In this lesson, you'll learn enough to get started with Elastic Search and how to use it with Meteor (you don't need to have any prior experience with Elastic Search). </p>
<p>Elastic Search itself is a very complex tool, which you can customize for your needs. We can't cover all of its functionality, but we'll give you some pointers so you can discover more. But what you'll learn here will be more than enough to build a powerful search system for your app.</p>
<p>After you've completed this lesson, you can look at <a href="/database-modeling/building-a-real-world-search-app-meteor-package-search">another lesson</a> on searching where we build a very fast app for searching Meteor packages. For that, we'll use some complex Elastic Search queries.</p>
<p>Without further ado, let's get started.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up-elastic-search">Setting Up Elastic Search</h2>
<p>Elastic Search is built using Java. So, you need to install the latest version of Java in your development environment. Let's do that now:</p>
<h3 id="installing-java-8">Installing Java 8</h3>
<ul>
<li>If you are using Ubuntu, follow this <a target="_blank" href="http://tecadmin.net/install-oracle-java-8-jdk-8-ubuntu-via-ppa/">guide</a> to install Java on your system.</li>
<li>If you are using OSX, you can download the official JDK from this <a target="_blank" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">link</a> and install it. </li>
</ul>
<p>Once you've installed Java, you can verify it by running the following command on the terminal:</p>
<pre><code class="hljs nginx"><span class="hljs-title">java</span> -version
</code></pre><p>Then you'll see something similar to this:</p>
<pre><code class="hljs cs">java version <span class="hljs-string">"1.8.0_25"</span>
Java(TM) <span class="hljs-function">SE Runtime <span class="hljs-title">Environment</span> <span class="hljs-params">(build <span class="hljs-number">1.8</span><span class="hljs-number">.0</span>_25-b17)</span>
Java <span class="hljs-title">HotSpot</span><span class="hljs-params">(TM)</span> 64-Bit Server <span class="hljs-title">VM</span> <span class="hljs-params">(build <span class="hljs-number">25.25</span>-b02, mixed mode)</span>
</span></code></pre><h3 id="installing-elastic-search">Installing Elastic Search</h3>
<p>Installing Elastic Search is easy. Just <a target="_blank" href="https://www.elastic.co/downloads/elasticsearch">download</a> the tarball (tar.gz file), extract it and copy the files into a permanent location on your machine.</p>
<h3 id="running-elastic-search">Running Elastic Search</h3>
<p>Go to the extracted Elastic Search directory and apply the following command to start it:</p>
<pre><code class="hljs nginx"><span class="hljs-title">sh</span> bin/elasticsearch
</code></pre><p>Then you'll get a screen like this:</p>
<p><img src="img/hnERx-8Uti.png" alt="Elastic Search Startup Screen"></p>
<p>Elastic Search will bind its HTTP API to port 9200 of your local IP. You can open the URL <a target="_blank" href="http://localhost:9200">http://localhost:9200</a> in a browser to see some information about your Elastic Search instance.</p>
<p>When you open the above URL, it'll show you a JSON document. From that, find the value for the <code>cluster_name</code> field:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      main
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      cluster0
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      index0
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      elasticsearch
    </label>
  </div>
  

  
    <p>
      Correct answer is : elasticsearch
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="basic-concepts">Basic Concepts</h2>
<p>Now you've a running instance of Elastic Search. Before we start working with Elastic Search, we first need to understand some basic concepts.</p>
<h3 id="document-storage">Document Storage</h3>
<p>Just like MongoDB, you can store documents inside Elastic Search. But unlike MongoDB, those documents are indexed by default and you can search any field in those documents very efficiently. </p>
<p>Elastic Search logically organizes documents in a way very similar to MongoDB:</p>
<ul>
<li>An <strong>index</strong> is very similar to a database in MongoDB. You can specify settings at the index level, which applies to all objects.</li>
<li>A <strong>type</strong> is very similar to a collection in MongoDB.</li>
<li>A <strong>document</strong> is very similar to a document in MongoDB. JSON documents are accepted.</li>
</ul>
<h3 id="mappings">Mappings</h3>
<p>When Elastic Search stores a document, it needs to know the types of field in the document. That way it can do the indexing very efficiently. This type assignment is know as <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping.html">mapping</a>.</p>
<p>However, we don't need to define the mapping before using Elastic Search. It'll <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-dynamic-mapping.html">dynamically</a> assign a mapping based on the types of documents it receives. But if we need to, we can <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-conf-mappings.html">define</a> our own mappings as well.</p>
<p>It supports most <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-types.html">types</a>, including JSON types, IP addresses, geo types, attachments and <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html">dates</a>.</p>
<h3 id="clustering">Clustering</h3>
<p>Elastic Search is designed to run as a cluster, so you can run it as a group of instances. Currently in this example, we are not running it as a cluster but if you are running a production deployment, you should use a cluster.</p>
<p>By clustering Elastic Search, we'll get two main benefits:</p>
<ol>
<li>Sharding - distribute documents across multiple instance for horizontal scaling</li>
<li>Replication - make copies of the same documents for redundancy</li>
</ol>
<p>If you run a cluster, by default Elastic Search groups your documents inside an index for five groups and stores them in different instances. A single such group is known as a <strong>shard</strong>. One shard is stored inside a single instance and one instance can contain many shards.</p>
<p>Elastic Search runs with one replica by default, which means it will keep a copy of each document in one other instance.</p>
<p>Most importantly, it has no concept of master and slave. Every instance is a master and you can write and read from any instance.</p>
<h3 id="rest-api">REST API</h3>
<p>The Elastic Search API is a REST API over HTTP. And there is no native protocol to connect with it. Simply send REST API requests to place data and search them. </p>
<p>Elastic Search also does not have a built-in authentication mechanism. So, you need to configure your firewalls accordingly or use a reverse proxy like <a target="_blank" href="http://www.elasticsearch.org/blog/playing-http-tricks-nginx/">nginx</a> to authenticate HTTP requests. </p>
<p>Now we have enough knowledge about Elastic Search and we can start to play around with it.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="playing-around-with-elastic-search">Playing around with Elastic Search</h2>
<p>We will now invoke some HTTP requests in to Elastic Search. Therefore, we need a HTTP client to interact with it. I recommend using the <a target="_blank" href="https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?hl=en">Postman REST client</a>, which is available as a Chrome extension. If you are familiar with another tool like <code>curl</code> you can use that instead.</p>
<p>In the following examples, we are going to add phone entries into Elastic Search. This is the format of a single document:</p>
<pre><code class="hljs css"><span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> <span class="hljs-string">"arunoda"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Arunoda Susiripala"</span>,
  <span class="hljs-string">"desc"</span>: <span class="hljs-string">"The founder of Kadira and MeteorHacks"</span>,
  <span class="hljs-string">"phone"</span>: <span class="hljs-string">"0094774884467"</span>
</span></span></span>}
</code></pre><h3 id="inserting-a-document">Inserting a Document</h3>
<p>To insert a document, simply send a <code>PUT</code> request to Elastic Search as follows:</p>
<ul>
<li>method: PUT</li>
<li>URL: <code>http://localhost:9200/&lt;index name&gt;/&lt;type name&gt;/&lt;document id&gt;</code></li>
<li>content: JSON document </li>
</ul>
<p>Let's add our first phonebook as shown below using Postman:</p>
<p>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/arunoda">http://localhost:9200/mydb/phonebook/arunoda</a><br>content: </p>
<pre><code class="hljs css"><span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> <span class="hljs-string">"arunoda"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Arunoda Susiripala"</span>,
  <span class="hljs-string">"desc"</span>: <span class="hljs-string">"The founder of Kadira and MeteorHacks"</span>,
  <span class="hljs-string">"phone"</span>: <span class="hljs-string">"0094774884467"</span>
</span></span></span>}
</code></pre><p>This is how we can do it with Postman: <a target="_blank" href="http://recordit.co/dPTVj0ZYiJ">http://recordit.co/dPTVj0ZYiJ</a>.</p>
<h3 id="retrieving-a-document">Retrieving a Document</h3>
<p>Simply send a ‘GET’ request to the following URL to retrieve the document:</p>
<ul>
<li>method: GET</li>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/arunoda">http://localhost:9200/mydb/phonebook/arunoda</a></li>
</ul>
<p>This is how to do it with Postman: <a target="_blank" href="http://recordit.co/ECXxHYBLxe">http://recordit.co/ECXxHYBLxe</a></p>
<h3 id="updating-a-document">Updating a Document</h3>
<p>To update a document, simply send another ‘PUT’ request, which will replace the previous document with the new document. We can also partially update documents.</p>
<p>Let's change the ‘desc’ field of the above document to this: ‘This guy never sleeps!’</p>
<p>To do this, we need to send a ‘POST’ request like below (notice the <code>/_update</code> at the end): </p>
<ul>
<li>method: POST</li>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/arunoda/_update">http://localhost:9200/mydb/phonebook/arunoda/_update</a></li>
<li>JSON content:<pre><code class="hljs json">{
  "<span class="hljs-attribute">doc</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">desc</span>": <span class="hljs-value"><span class="hljs-string">"This guy never sleeps!"</span>
  </span>}
</span>}
</code></pre></li>
</ul>
<p>This is how to do this with Postman: <a target="_blank" href="http://recordit.co/ipV94mX2OL">http://recordit.co/ipV94mX2OL</a></p>
<p>We can also do more stuff with partial updates using scripts. Check out the documentation on <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/partial-updates.html#_using_scripts_to_make_partial_updates">partial updates</a>.</p>
<h3 id="deleting-a-document">Deleting a Document</h3>
<p>Deleting a document is also very similar to what we did above. We simply need to send a ‘DELETE’ request to the following URL:</p>
<ul>
<li>method: DELETE</li>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/arunoda">http://localhost:9200/mydb/phonebook/arunoda</a></li>
</ul>
<p>This is how to do this with Postman: <a target="_blank" href="http://recordit.co/d6viP7OvOH">http://recordit.co/d6viP7OvOH</a></p>
<hr>
<p>These are the basic CRUD operations we can invoke with Elastic Search. But there is much more stuff you can do with Elastic Search. Read the <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/data-in-data-out.html">official documentation</a> to see how.</p>
<p>Now we've a little question for you.</p>
<p>Let's imagine we've indexed another document with _id "tom" of the "phonebook" type in the "anotherdb" index. Now we need to update its "phone" field to "0094887884467". How can we do it?</p>
<h4 id="option-1">Option 1</h4>
<p>method: POST<br>URL: <a target="_blank" href="http://localhost:9200/anotherdb/phonebook/tom/_update">http://localhost:9200/anotherdb/phonebook/tom/_update</a><br>JSON content:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">doc</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">phone</span>": <span class="hljs-value"><span class="hljs-string">"0094887884467"</span>
  </span>}
</span>}
</code></pre><h4 id="option-2">Option 2</h4>
<p>method: POST<br>URL: <a target="_blank" href="http://localhost:9200/anotherdb/phonebook/tom/">http://localhost:9200/anotherdb/phonebook/tom/</a><br>JSON content:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">doc</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">phone</span>": <span class="hljs-value"><span class="hljs-string">"0094887884467"</span>
  </span>}
</span>}
</code></pre><h4 id="option-3">Option 3</h4>
<p>method: POST<br>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/tom/_update">http://localhost:9200/mydb/phonebook/tom/_update</a><br>JSON content:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">doc</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">phone</span>": <span class="hljs-value"><span class="hljs-string">"0094887884467"</span>
  </span>}
</span>}
</code></pre><h4 id="option-4">Option 4</h4>
<p>method: POST<br>URL: <a target="_blank" href="http://localhost:9200/anotherdb/phonebook/tom/_update">http://localhost:9200/anotherdb/phonebook/tom/_update</a><br>JSON content:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">phone</span>": <span class="hljs-value"><span class="hljs-string">"0094887884467"</span>
</span>}
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-ok text-success"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="searching-with-elastic-search">Searching with Elastic Search</h2>
<p>Even though we've played a bit with Elastic Search, we didn't try to search any documents. Let's do it. Again we are going to use Postman, but you can use <code>curl</code> or any other tool you prefer.</p>
<p>Elastic Search has a few ways to search data. There are two main types: URI Search and Query DSL.  </p>
<h3 id="uri-search">URI Search</h3>
<p><a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-uri-request.html">URI search</a> is a very easy way to search across your data. You simply invoke a ‘GET’ request and get the results. This is how to search phonebook entries:</p>
<ul>
<li>method: GET</li>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/_search?q=arunoda">http://localhost:9200/mydb/phonebook/_search?q=arunoda</a></li>
</ul>
<p>A URI Search will search all the fields in the document to match the query. Even though there are <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-uri-request.html">options</a> you can use to customize the search behavior, a URI search is not recommended for production. It's a debugging tool for quickly searching through documents and filtering documents.</p>
<h3 id="query-dsl">Query DSL</h3>
<p>Query DSL is the recommended way to query a document inside Elastic Search. It's JSON based and we can do many customizations. This is how you do a simple query with Query DSL:</p>
<ul>
<li>method: POST</li>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/_search">http://localhost:9200/mydb/phonebook/_search</a></li>
<li>JSON content:</li>
</ul>
<pre><code class="hljs json">  {
    "<span class="hljs-attribute">query</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">match</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"arunoda"</span>
      </span>}
    </span>}
  </span>}
</code></pre><p>When invoked, we'll get a result like this:</p>
<pre><code class="hljs json">{
    "<span class="hljs-attribute">took</span>": <span class="hljs-value"><span class="hljs-number">11</span></span>,
    "<span class="hljs-attribute">timed_out</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>,
    "<span class="hljs-attribute">_shards</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">total</span>": <span class="hljs-value"><span class="hljs-number">5</span></span>,
        "<span class="hljs-attribute">successful</span>": <span class="hljs-value"><span class="hljs-number">5</span></span>,
        "<span class="hljs-attribute">failed</span>": <span class="hljs-value"><span class="hljs-number">0</span>
    </span>}</span>,
    "<span class="hljs-attribute">hits</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">total</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
        "<span class="hljs-attribute">max_score</span>": <span class="hljs-value"><span class="hljs-number">0.19178301</span></span>,
        "<span class="hljs-attribute">hits</span>": <span class="hljs-value">[
            {
                "<span class="hljs-attribute">_index</span>": <span class="hljs-value"><span class="hljs-string">"mydb"</span></span>,
                "<span class="hljs-attribute">_type</span>": <span class="hljs-value"><span class="hljs-string">"phonebook"</span></span>,
                "<span class="hljs-attribute">_id</span>": <span class="hljs-value"><span class="hljs-string">"arunoda"</span></span>,
                "<span class="hljs-attribute">_score</span>": <span class="hljs-value"><span class="hljs-number">0.19178301</span></span>,
                "<span class="hljs-attribute">_source</span>": <span class="hljs-value">{
                    "<span class="hljs-attribute">_id</span>": <span class="hljs-value"><span class="hljs-string">"arunoda"</span></span>,
                    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"Arunoda Susiripala"</span></span>,
                    "<span class="hljs-attribute">desc</span>": <span class="hljs-value"><span class="hljs-string">"This guy never sleeps :)"</span></span>,
                    "<span class="hljs-attribute">phone</span>": <span class="hljs-value"><span class="hljs-string">"0094774884467"</span>
                </span>}
            </span>}
        ]
    </span>}
</span>}
</code></pre><p>We’ll tell you something about this result document:</p>
<ul>
<li><code>took</code> contains the number of milliseconds used to execute this query.</li>
<li><code>hits.total</code> shows the number of results matched in this query.</li>
<li><code>hits.hits</code> contains the matched data set.</li>
<li><code>hits.hits._source</code> is the actual document.</li>
<li><code>hits.hits._score</code> is the <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/relevance-intro.html">relevance</a> value for this document relative to the search query.</li>
</ul>
<h4 id="pagination">Pagination</h4>
<p>Elastic Search has built-in support for pagination. You can easily append a few query strings to the search URL and paginate the results:</p>
<ul>
<li>URL: <a target="_blank" href="http://localhost:9200/mydb/phonebook/_search?size=5&amp;from=0">http://localhost:9200/mydb/phonebook/_search?size=5&amp;from=0</a></li>
</ul>
<p>This will limit the number of results for each request to 5 and it will start collecting results from the 0th result. </p>
<p>Learn more by reading the documentation on <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/pagination.html">paginations</a>.</p>
<h4 id="query-types">Query Types</h4>
<p>In the above example, we used a query type called <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"><code>match</code></a>. There are many other query types available with Elastic Search and you can mix and match them. </p>
<p>Learning about query types is beyond the scope of this lesson but look at this <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-queries.html">documentation</a> if you want to learn more about them.</p>
<h4 id="filters">Filters</h4>
<p>You can filter a subset of documents and then search them. This functionality is similar to the MongoDB selectors. Just like query types, there are a lot of <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-filters.html">filters</a> you can use. Filters are very useful since we can use them to speed up search queries. Here's the reason.</p>
<p><em>When a search is in progress, it will calculate a score based on the search query for each document. That takes time. But a filter does not calculate a score. It narrows down the documents to be searched. That's where the speed gain comes from.</em></p>
<p>Let’s imagine that in our phonebook entry we also have a <code>category</code> field. Then this is how we filter our search query to limit entries from the ‘friends’ category.</p>
<pre><code class="hljs javascript">{
    <span class="hljs-string">"query"</span>: {
      <span class="hljs-string">"filtered"</span>: {
        <span class="hljs-string">"query"</span>: {
          <span class="hljs-string">"match"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"arunoda"</span>
          }
        },

        <span class="hljs-string">"filter"</span>: {
          <span class="hljs-string">"term"</span>: {<span class="hljs-string">"category"</span>: <span class="hljs-string">"friends"</span>}
        }
      }
    }
  }
}
</code></pre><p>To use a filter we need to use another query type called <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-filtered-query.html"><code>filtered</code></a>. We used the filter type called <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-term-filter.html"><code>term</code></a> in the above query.</p>
<hr>
<p>Now you know enough about Elastic Search and how to interact with it. Let's use it with Meteor. Before we start, try to answer the following question.</p>
<p>From the following list, select the item which is not an Elastic Search query type:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      fuzzy
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      match_prefix
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      bool
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      match_phrase_prefix
    </label>
  </div>
  

  
    <p>
      Correct answer is : match_prefix
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="using-elastic-search-with-meteor">Using Elastic Search with Meteor</h2>
<p>Now we're going to use Elastic Search with Meteor. We'll use the same app we used for MongoDB searching. It's a phonebook with search functionality.</p>
<p>You can clone it from here:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-es-search.git</span>
</code></pre><p>By default, it uses MongoDB regular expression searching. We will convert it to use Elastic Search in this lesson.</p>
<p><img src="img/DvAiLi8cX3.png" alt="Phonebook Search App"></p>
<h3 id="add-elastic-search-support">Add Elastic Search Support</h3>
<p>First, we need to find some way to interact with Elastic Search. We can simply use Meteor's HTTP API. But we are going to use the official npm package <a target="_blank" href="https://www.npmjs.com/package/elasticsearch"><code>elasticsearch</code></a>. It has some cool features like automatic cluster discovery.</p>
<p>This app is already using <code>meteorhacks:npm,</code> so we can add <code>elasticsearch</code> very easily. Simply add the following to the <code>packages.json</code> file in the root of the app:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">elasticsearch</span>" : <span class="hljs-value"><span class="hljs-string">"3.0.2"</span>
</span>}
</code></pre><blockquote>
<p>There is already an entry in packages.json, so keep that as well.</p>
</blockquote>
<p>Now you need to paste the following code into the top of <code>server/app.js</code>. This will create an Elastic Search client that can work with our local database.</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// loading the npm module</span>
ElasticSearch = Meteor.npmRequire(<span class="hljs-string">'elasticsearch'</span>);

<span class="hljs-comment">// create the client</span>
EsClientSource = <span class="hljs-keyword">new</span> ElasticSearch.Client({
  host: <span class="hljs-string">'localhost:9200'</span>
});

<span class="hljs-comment">// make it fiber aware </span>
EsClient = Async.wrap(EsClientSource, [<span class="hljs-string">'index'</span>, <span class="hljs-string">'search'</span>]);
</code></pre>
<p>This code will create an Elastic Search client we can use to search and create documents. Currently, we are going to use the <code>index</code> and <code>search</code> APIs only. If you are going to use <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/client/javascript-api/current/api-reference.html">others</a>, you need to add the APIs to the array in <code>Async.wrap</code>.</p>
<h3 id="insert-documents">Insert Documents</h3>
<p>Now we are going to add a copy of our data to Elastic Search. There are a couple of ways we can do this. </p>
<h4 id="1-with-rivers">1. With Rivers</h4>
<p>Rivers will listen to the MongoDB oplog and send data to Elastic Search. We still can do filtering, projecting and transformations with the data we send to Elastic Search from MongoDB.</p>
<p>This is one of the well-maintained <a target="_blank" href="https://github.com/richardwilly98/elasticsearch-river-mongodb">MongoDB river plugins</a> for Elastic Search.</p>
<h4 id="2-inside-the-application-level">2. Inside the Application Level</h4>
<p>We can use a package like <a target="_blank" href="https://github.com/matb33/meteor-collection-hooks">collection-hooks</a> to listen out for every write operation inside the app and send changes to Elastic Search. This is very similar to rivers, but this solution works inside your app.</p>
<h4 id="3-insert-along-with-the-data">3. Insert Along with the Data</h4>
<p>We can also create documents in Elastic Search while we are adding them to MongoDB. With this solution, you simply add Elastic Search code for creating, updating and deleting documents inside your application.</p>
<p>For this app, we prefer to use the <strong>third</strong> option. We only need to index a single collection and it's straightforward to do so alongside MongoDB.</p>
<p>We need to modify our <code>addEntry</code> method to create documents in Elastic Search as well. Replace the current implementation in <code>server/app.js</code> with the following:</p>
<pre><code class="hljs javascript">
Meteor.methods({
  addEntry: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, phoneNo)</span> </span>{
    <span class="hljs-keyword">var</span> id = Entries.insert({name: name, phoneNo: phoneNo});

    <span class="hljs-comment">// create a document index Elastic Search</span>
    EsClient.index({
      index: <span class="hljs-string">"myindex"</span>,
      type: <span class="hljs-string">"phonebook"</span>,
      id: id,
      body: {
        name: name,
        phoneNo: phoneNo
      }
    });
  }
});
</code></pre><p>Here we've added an entry to Elastic Search with the id of the MongoDB document. </p>
<h3 id="adding-an-initial-set-of-data">Adding an Initial Set of Data</h3>
<p>Now we need to add an initial set of data to Elastic Search. Stop the Meteor application and type <code>meteor reset</code>. This will wipe the app from the current MongoDB database. </p>
<p>When we start the app again, any new data will be sent to Elastic Search as well.</p>
<p>So, start your app and you'll see something like this:</p>
<p><img src="img/jFxvBpaYcR.png" alt="Adding Documents"></p>
<p>You can verify this by sending a ‘GET’ request to the following URL:</p>
<pre><code class="hljs ruby"><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/localhost:9200/myindex</span><span class="hljs-regexp">/phonebook/</span>_search?q=*
</code></pre><p>This is how it can be done with Postman: <a target="_blank" href="http://recordit.co/lJLgRs3v8Y">http://recordit.co/lJLgRs3v8Y</a></p>
<h3 id="searching-data">Searching Data</h3>
<p>Now we've put our app's phonebook data inside the app. Let’s do a search. Simply replace our <code>getEntries</code> method with the following:</p>
<pre><code class="hljs javascript">Meteor.methods({
  getEntries: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText)</span> </span>{
    <span class="hljs-comment">// the the result from Elastic Search</span>
    <span class="hljs-keyword">var</span> result =  EsClient.search({
      index: <span class="hljs-string">"myindex"</span>,
      type: <span class="hljs-string">"phonebook"</span>,
      body: {
        query: {
          match: {
            name: searchText
          }
        }
      }
    });

    <span class="hljs-comment">// pick actual set of data we need to send</span>
    <span class="hljs-keyword">return</span> result.hits.hits.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{
      <span class="hljs-keyword">return</span> doc._source;
    });
  }
});
</code></pre><p>Now our app is fully powered by Elastic Search. But there is a small issue compared with the previous version. What is it?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      The search is not working.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The search result does not have any phone numbers.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      This app does not do partial matching.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The search does not return the name.
    </label>
  </div>
  

  
    <p>
      Correct answer is : This app does not do partial matching.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="improve-the-searching">Improve the Searching</h2>
<p>Our current search implementation does not support partial matching of words. That's because we've used a very basic search query. We can do better.</p>
<p>Use the following <code>getEntry</code> method instead of the current one:</p>
<pre><code class="hljs javascript">Meteor.methods({
  getEntries: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText)</span> </span>{
    <span class="hljs-keyword">var</span> lastWord = searchText.trim().split(<span class="hljs-string">" "</span>).splice(-<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">var</span> query = {
      <span class="hljs-string">"bool"</span>: {
        <span class="hljs-string">"must"</span>: [
          {
            <span class="hljs-string">"bool"</span>: {
              <span class="hljs-string">"should"</span>: [
                {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"name"</span>: {<span class="hljs-string">"query"</span>: searchText}}},
                {<span class="hljs-string">"prefix"</span>: {<span class="hljs-string">"name"</span>: lastWord}}
              ]
            }
          }
        ],
        <span class="hljs-string">"should"</span>: [
          {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"name"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}}
        ]
      }
    };

    <span class="hljs-keyword">var</span> result =  EsClient.search({
      index: <span class="hljs-string">"myindex"</span>,
      type: <span class="hljs-string">"phonebook"</span>,
      body: {
        query: query
      }
    });

    <span class="hljs-keyword">return</span> result.hits.hits.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{
      <span class="hljs-keyword">return</span> doc._source;
    });
  }
});
</code></pre><p>When we type "tom dool", we get "Tom Dooley" on the top of the result. At the same time, we also get results for "Tom" and "Dooley" separately at the bottom. This is the power of Elastic Search and its scoring system.</p>
<h3 id="the-search-query">The Search Query</h3>
<p>We are using this search query for a few different reasons:</p>
<ul>
<li>To support partial matching.</li>
<li>To match individual words.</li>
<li>To match phrases and give them a better score.</li>
<li>To improve performance.</li>
</ul>
<p>We used a few different query types, such as ‘bool’, ‘match’, ‘prefix’ and ‘match_phrase_prefix’.</p>
<p>With the ‘bool’ query, we can implement logic inside the search query. For example, in the above query, we can make sure the result contains documents matching individual words of the search text (at least one of them).</p>
<p>Then, it will start matching for the phrase with the prefix. If there is a match, those documents will have a higher score and be shown on the top of the result. </p>
<p>This ‘bool’ query helps us to improve performance as well. Normally, phrase matching is more costly than simple matching. Now we've filtered out a subset of documents to be matched with the <code>match_phrase_prefix</code>. That gives us a faster search result.</p>
<p>This is just the basics of Elastic Search. With more experience, you can build really great search applications.</p>
<p>Now it's time for a question.</p>
<p>Let's say we've removed <code>{"prefix": {"name": lastWord}}</code> from our query and now it looks something like this:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> query = {
      <span class="hljs-string">"bool"</span>: {
        <span class="hljs-string">"must"</span>: [
          {
            <span class="hljs-string">"bool"</span>: {
              <span class="hljs-string">"should"</span>: [
                {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"name"</span>: {<span class="hljs-string">"query"</span>: searchText}}}
              ]
            }
          }
        ],
        <span class="hljs-string">"should"</span>: [
          {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"name"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}}
        ]
      }
    };
</code></pre><p>What would happen?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      The search does not work.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The search gives the wrong results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Partial matching does not work.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Partial matching does not work until you specify the first word.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Partial matching does not work until you specify the first word.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="production-deployments">Production Deployments</h2>
<p>So far we've used Elastic Search locally with a sample app. When you are using it with a production app, there are some decisions you should make. The following information will help you to make those decisions easily.</p>
<h3 id="sending-data-to-elastic-search">Sending Data to Elastic Search</h3>
<p>As we discussed earlier, we can use a few different strategies to send data to Elastic Search. They are:</p>
<ol>
<li>Using dedicated rivers</li>
<li>Using collection-hooks and a river inside the app</li>
<li>Using it directly in the application logic</li>
</ol>
<p>If you choose to use a dedicated river, you need to manage another process or plugin. If you don't want to, simply use the second option. This will add some overhead to your app but you can very easily manage it.</p>
<p>If you only need to search a tiny part of the application, then send documents to Elastic Search along with the application logic, which is what we did with this phonebook app.</p>
<h3 id="why-do-we-keep-another-copy-in-mongodb-">Why do we keep another copy in MongoDB?</h3>
<p>You might ask, why do we still need to keep a copy of our documents in MongoDB. In this example, we haven't done anything with the phonebook entries stored in MongoDB. But in a real app, you will have other related entities and you'll have many views for displaying the data. So, we must keep a copy in MongoDB.</p>
<p>Searching is an expensive task. So, Elastic Search will use disk space and run computations to make searching faster. Writing to Elastic Search is normally more costly than writing to MongoDB. So, it's better to send only the fields we need to search. That's another reason that you still need to keep MongoDB.</p>
<p>Finally Elastic Search is a search solution and it's not a DB. And it's even very hard to implement a real-time driver with Elastic Search's concurrency model and APIs. So, we still need to store documents in MongoDB to make our app work in real time.</p>
<h3 id="sending-other-related-data">Sending Other Related Data</h3>
<p>Sometimes you need to send other related data along with the search result. Always try not to do so. For example, you may need to show a description along with the search result. Show it when the user clicks on an item in the result list.</p>
<p>If you still need to send some additional data, query them inside the search method and merge them with the search result. Try to avoid publications along with the search. They do not scale well with the current pub/sub implementation and you need to work hard to manage them.</p>
<h3 id="deployment">Deployment</h3>
<p>If you decide to host Elastic Search yourself,  use a cluster of Elastic Search nodes. And make sure to put them behind a firewall or a reverse proxy like <a target="_blank" href="https://www.elastic.co/blog/playing-http-tricks-nginx">nginx</a>, which will add the necessary authentication. </p>
<p>And read the Elastic Search guide on <a target="_blank" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/administration.html">production deployment</a>.</p>
<h3 id="cloud-hosting">Cloud Hosting</h3>
<p>If you are going for a cloud-hosting solution, there are a few players who do Elastic Search hosting. Here are some of them:</p>
<ul>
<li><a target="_blank" href="https://qbox.io/pricing">qbox.io</a> - offers hosting in multiple cloud services,</li>
<li><a target="_blank" href="https://www.compose.io/elasticsearch/">compose.io</a> - we know them with their great MongoDB hosting,</li>
<li><a target="_blank" href="https://bonsai.io/">bonsai.io</a> - cheap hosting solution,</li>
<li><a target="_blank" href="https://www.found.no">found.no</a>.</li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Searching with Elastic Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/searching-with-elastic-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/1">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/searching-with-elastic-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/searching-with-elastic-search/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/searching-with-elastic-search/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="finally">Finally</h2>
<p>Now you've learned enough to get started with Elastic Search. We have talked about the basics, how to integrate it with Meteor and how to use some of its advanced features.</p>
<p>You will learn even more once you start to integrate it with an app. We think Elastic Search gives better search results compared with MongoDB. You should use it if you really need a good search solution.</p>
<p>There are also some Elastic Search related <a target="_blank" href="https://atmospherejs.com/?q=elastic">packages</a> developed by the Meteor community. Try them out and see if any are what you are looking for. </p>
<p>Additionally, we've another lesson on searching, which shows how to build a real search app including the client side part. With that, we show how to sync data between the server and the client and run the search on the client.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the <a href="/database-modeling/searching-with-elastic-search">previous lesson</a>, we worked with <a href="http://www.elasticsearch.org/">Elastic Search</a> and implemented a simple search application, but we need to do more work if we are implementing a search solution for a real app. Before we discuss this further, take a look at this app:</p>
<iframe src="https://www.youtube.com/embed/ZyteGi36g7o" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<p>It's an app to search Meteor packages. It was built using Meteor and Elastic Search. It can search very quickly and gives you instant results, but implementing it was not so easy. Here's why.</p>
<h2 id="syncing-data-between-client-and-server">Syncing Data between Client and Server</h2>
<p>When we are implementing something like an instant search, we need to allow users to search locally while fetching data from the server. Open-source projects like <a href="https://twitter.github.io/typeahead.js/">Typehead</a> do some of the hard work for you, but if you need to build a custom search solution, Typehead is not a good option.</p>
<p>Because of this issue, we've created a project called <a href="https://github.com/meteorhacks/search-source">Search Source</a>, and it'll take care of managing data and searching in the client. You can get its reactive data source and display it any way you like. It also knows how to fetch data from the server and merge them with the existing client data. We'll show you how to integrate it into a real app with this lesson.</p>
<h2 id="relevance">Relevance</h2>
<p>Elastic Search is a superb tool for search documents, but it doesn't know anything about our data model. Look at the following example:</p>
<p>If you search for "Iron Router" in Elastic Search, how does it know the difference between "iron:router" and "multiply:iron-router-progress"? Actually, it doesn't. Thus, it's possible for Elastic Search to rank "iron:router" lower than "multiply:iron-router-progress." </p>
<p>So, we need to force Elastic Search to rank "iron:router" correctly. This involves some advanced usage of Elastic Search, and we're going to do it in this course.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>This lesson requires prior knowledge of Elastic Search, so we recommend that you to follow our <a target="_blank" href="/database-modeling/searching-with-elastic-search">previous lesson</a> on Elastic Search if you haven't done so already.</p>
<p>Let's clone our Meteor Package search app:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-package-search.git</span>
</code></pre><p>It's a functioning app and implemented as a solution that is very similar to what we did during the previous lesson on Elastic Search.</p>
<p>Before you run the app, you need to start your Elastic Search instance. After that, export the Elastic Search URL with <code>ES_URL</code> environment variables and run the Meteor app as shown below:</p>
<pre><code class="hljs javascript">ES_URL=http:<span class="hljs-comment">//localhost:9200 meteor</span>
</code></pre><p>Then you cansearch the packages as shown <a target="_blank" href="http://recordit.co/r7baHCN74j">here</a>.</p>
<h3 id="search-query">Search Query</h3>
<p>We've changed the search query slightly from the previous lesson to work with this app. Here it is: (located in <code>server/app.js</code>)</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> query = {
  <span class="hljs-string">"bool"</span>: {
    <span class="hljs-string">"must"</span>: [
      {
        <span class="hljs-string">"bool"</span>: {
          <span class="hljs-string">"should"</span>: [
            {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"packageName"</span>: {<span class="hljs-string">"query"</span>: searchText}}},
            {<span class="hljs-string">"prefix"</span>: {<span class="hljs-string">"packageName"</span>: lastWord}},
            {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"description"</span>: {<span class="hljs-string">"query"</span>: searchText}}},
            {<span class="hljs-string">"prefix"</span>: {<span class="hljs-string">"description"</span>: lastWord}}
          ]
        }
      }
    ],
    <span class="hljs-string">"should"</span>: [
      {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"packageName"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}},
      {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"description"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}},
    ]
  }
};
</code></pre><p>Now we are searching for two fields: <code>packageName</code> and <code>description</code>. That's the only change.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="using-the-search-source">Using the Search Source</h2>
<p>Now our app works well, but the search results and how it handles the search in the client are not very smooth. That's because we've fetched the data from the server via a Meteor method and then tried to re-render all the content. (see <code>client/app.js</code>)</p>
<p>Since we have a set of data on the client, we can show some filtered results to the user until new results come from the server. We can also highlight searched words to give a better look.</p>
<p>You can start doing it manually, but we've created a simple solution for this. It's <a target="_blank" href="https://github.com/meteorhacks/search-source"><code>meteorhacks:search-source</code></a>. It's a reactive data source for search. Let's see what it can do. Watch the following videos:</p>
<ul>
<li>With Search Source: <a target="_blank" href="http://recordit.co/pNdsIblhGL">http://recordit.co/pNdsIblhGL</a></li>
<li>Without Search Source: <a target="_blank" href="http://recordit.co/r7baHCN74j">http://recordit.co/r7baHCN74j</a></li>
</ul>
<p>I think that you can see the difference very clearly.</p>
<h3 id="adding-search-source-support">Adding Search Source Support</h3>
<p>First, you need to add Search Source to your app. This is how you can add it:</p>
<pre><code class="hljs css"><span class="hljs-tag">meteor</span> <span class="hljs-tag">add</span> <span class="hljs-tag">meteorhacks</span><span class="hljs-pseudo">:search-source</span>
</code></pre><p>Then you need to change the content inside your <code>client/app.js</code> with the following content:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> options = {
  keepHistory: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
  localSearch: <span class="hljs-literal">true</span>
};
<span class="hljs-keyword">var</span> fields = [<span class="hljs-string">'packageName'</span>, <span class="hljs-string">'description'</span>];

<span class="hljs-comment">// creating a source with the name "packages" and  ask to search</span>
<span class="hljs-comment">// 'packageName' and 'description' fields locally.</span>
PackageSearch = <span class="hljs-keyword">new</span> SearchSource(<span class="hljs-string">'packages'</span>, fields, options);

Template.searchResult.helpers({
  getPackages: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// get data from the source - this return a reactive data source</span>
    <span class="hljs-keyword">return</span> PackageSearch.getData({
      <span class="hljs-comment">// transform and highlight searched words</span>
      <span class="hljs-comment">// all regExp matching has done for you</span>
      <span class="hljs-comment">// you only have to do the word replacement only (to bold searching words)</span>
      transform: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(matchText, regExp)</span> </span>{
        <span class="hljs-keyword">return</span> matchText.replace(regExp, <span class="hljs-string">"&lt;b&gt;$&amp;&lt;/b&gt;"</span>)
      },
      sort: {_score: -<span class="hljs-number">1</span>}
    });
  },

  isLoading: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> PackageSearch.getStatus().loading;
  }
});

Template.searchResult.rendered = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  PackageSearch.search(<span class="hljs-string">''</span>);
};

Template.searchBox.events({
  <span class="hljs-string">"keyup #search-box"</span>: _.throttle(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">var</span> text = $(e.target).val().trim();
    <span class="hljs-comment">// sending search request to the server</span>
    PackageSearch.search(text);
  }, <span class="hljs-number">200</span>)
});
</code></pre><p>If you follow the code with comments, adding Search Source is not a big task. We simply created a new Search Source and got data from it. Then we asked to search when the user enters the search query in the text box.</p>
<p>The next step is to get data from the server. That's easy, too. </p>
<p>In the above code, we've created a Search Source named <code>packages</code>. Then, we need to define a data source on the server as shown below:</p>
<pre><code class="hljs javascript">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// simply do the query and return the result</span>
});
</code></pre><p>The above will define a data source in the server named <code>packages</code>, and it will be responsible for sending data to the client. If you look at it carefully, this is very similar to a method call. </p>
<p>Now try to migrate our existing code in <code>server/app.js</code> as a data source named "packages."</p>
<p>Were you able to invoke search queries and get results after the change?</p>

  

  <div class="radio">
    <label>
      
        <input value="Yes" id="lesson-answer" name="lesson-answer" type="radio">
      
      Yes
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <input value="No" id="lesson-answer" name="lesson-answer" type="radio">
      
      No
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As you've done the previous step correctly, here's the content for <code>server/app.js</code>.</p>
<pre><code class="hljs php">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  Meteor._sleepForMs(<span class="hljs-number">1000</span>);
  <span class="hljs-keyword">var</span> words = searchText.trim().split(<span class="hljs-string">" "</span>);
  <span class="hljs-keyword">var</span> lastWord = words[words.length -<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> query = {
    <span class="hljs-string">"bool"</span>: {
      <span class="hljs-string">"must"</span>: [
        {
          <span class="hljs-string">"bool"</span>: {
            <span class="hljs-string">"should"</span>: [
              {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"packageName"</span>: {<span class="hljs-string">"query"</span>: searchText}}},
              {<span class="hljs-string">"prefix"</span>: {<span class="hljs-string">"packageName"</span>: lastWord}},
              {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"description"</span>: {<span class="hljs-string">"query"</span>: searchText}}},
              {<span class="hljs-string">"prefix"</span>: {<span class="hljs-string">"description"</span>: lastWord}}
            ]
          }
        }
      ],
      <span class="hljs-string">"should"</span>: [
        {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"packageName"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}},
        {<span class="hljs-string">"match_phrase_prefix"</span>: {<span class="hljs-string">"description"</span>: {<span class="hljs-string">"query"</span>: searchText, slop: <span class="hljs-number">5</span>}}},
      ]
    }
  };

  <span class="hljs-keyword">var</span> result =  EsClient.search({
    index: <span class="hljs-string">"meteor"</span>,
    type: <span class="hljs-string">"packages"</span>,
    body: {
      query: query
    }
  });

  <span class="hljs-keyword">var</span> data = result.hits.hits.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{
    <span class="hljs-keyword">var</span> source = _.<span class="hljs-keyword">clone</span>(doc._source);
    source._score = doc._score;
    <span class="hljs-keyword">return</span> source;
  });

  <span class="hljs-keyword">return</span> data;
});
</code></pre>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="handling-meta-data">Handling Meta Data</h2>
<p>If you closely watched the video I showed you <a target="_blank" href="http://recordit.co/pNdsIblhGL">previously</a>, you might have noticed that there are some metadata along with the search results. See the following image:</p>
<p><img src="img/rOIiK6hW-N.png" alt="Search Metadata"></p>
<p>It's a set of metadata for the search results. This is similar to what Google shows after search results. Let's try to implement it.</p>
<h3 id="client-side-code">Client-Side Code</h3>
<p>Our client-side template <code>seachResult</code> already contains the HTML for displaying metadata. See below (this is in <code>client/app.html</code>):</p>
<pre><code class="hljs coffeescript">&lt;div id=<span class="hljs-string">"search-meta"</span>&gt;
  {{<span class="hljs-comment">#if isLoading}}</span>
    searching ...
  {{<span class="hljs-keyword">else</span>}}
    {{<span class="hljs-comment">#with metadata}}</span>
    About {{total}} results ({{took}} milliseconds)
    {{/<span class="hljs-reserved">with</span>}}
  {{/<span class="hljs-keyword">if</span>}}
&lt;/div&gt;
</code></pre><p>Now, we need to send values for <code>total</code> and <code>took</code> along with the search results. Fortunately, Elastic Search tracks this for us, and we can get the values very easily. Then we can send them along with the our Search Source data as shown below:</p>
<p>(Apply the above code accordingly into the <code>packages</code> Search Source definition in <code>server/app.js</code>.)</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> data = result.hits.hits.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(doc)</span> </span>{
  <span class="hljs-keyword">var</span> source = _.clone(doc._source);
  source._score = doc._score;
  <span class="hljs-keyword">return</span> source;
});

<span class="hljs-comment">// getting the metadata</span>
<span class="hljs-keyword">var</span> metadata = {
  total: result.hits.total,
  took: result.took
};

<span class="hljs-comment">// return both data and metadata</span>
<span class="hljs-keyword">return</span> {
  data: data,
  metadata: metadata
};
</code></pre>
<p>Earlier, we only returned the <code>data</code> from the Search Source. Now we are sending both <code>data</code> and <code>metadata</code> wrapped inside an object.</p>
<h3 id="getting-metadata-from-the-client">Getting Metadata from the Client</h3>
<p>From the client, you can simply get metadata with this API:</p>
<pre><code class="hljs">PackageSearch.getMetadata()
</code></pre><p>It's also a reactive data source, so, using above API, we can create the <code>metadata</code> helper on the <code>searchResult</code> template and render the metadata. </p>
<p>Now, create the helper function. You'll be able to see the metadata just above the search results with that change. </p>
<p>These are all the changes we are trying to make on the client side. We hope that you can now see the smoothness in the search.</p>
<p>Before we move to the next step, try to answer the following question. </p>
<p>Open the app and enter "iron router" in the search box. Can you see <code>iron:router</code> project on top of the list?</p>

  

  <div class="radio">
    <label>
      
        <input value="Yes" id="lesson-answer" name="lesson-answer" type="radio">
      
      Yes
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <input value="No" id="lesson-answer" name="lesson-answer" type="radio">
      
      No
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="adding-a-custom-analyzer">Adding a Custom Analyzer</h2>
<p>Interestingly, our search app does not list <code>iron:router</code> when we search for "iron router," but if you enter <code>iron:router</code>, you'll be able to see it. However, users rarely type like that. </p>
<p>Why does such behavior occur? Have we done something wrong?</p>
<p>Actually, we didn't do anything wrong. This is an issue with Elastic Search's default configurations. Let's try to understand it and fix it.</p>
<h3 id="analyzers">Analyzers</h3>
<p>Elastic Search uses a subsystem called <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/analysis-analyzers.html">Analyzers</a> to analyze incoming values and tokenize them into a form where Elastic Search can search easily. </p>
<p>We can test how Elastic Search tokenizes input values by sending an HTTP request like the one below:</p>
<ul>
<li>method: GET</li>
<li>url: <code>http://localhost:9200/meteor/_analyze?text=input text</code></li>
</ul>
<p>This explains how it can be done with Postman: <a target="_blank" href="http://recordit.co/oy8m4qILGQ">http://recordit.co/oy8m4qILGQ</a></p>
<p>The default analyzer tokenizes the input into alpha-numeric text. </p>
<p>Now try to analyze <code>iron:router</code> with the above REST endpoint, and you'll see that the analyzer won't break it into two words. That's the reason we had some issues with <code>iron:router</code>.</p>
<h3 id="creating-a-custom-analyzer">Creating a Custom Analyzer</h3>
<p>Now we need to create a custom analyzer to support our use case. We’re going to use a regular expression based-analyzer that breaks words at ":", "_", "-", or a space.</p>
<p>Unfortunately, we need to <strong>delete</strong> the index before creating an analyzer. Let's delete our index with the following REST endpoint. (We'll re-index the data in a moment.)</p>
<ul>
<li>method: DELETE</li>
<li>url: <a target="_blank" href="http://localhost:9200/meteor">http://localhost:9200/meteor</a></li>
</ul>
<p>This is how we can create the new analyzer. We name it <code>meteor_packages</code>. Send the following PUT request.</p>
<ul>
<li>method: PUT</li>
<li>url: <a target="_blank" href="http://localhost:9200/meteor">http://localhost:9200/meteor</a></li>
<li>JSON content:</li>
</ul>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">settings</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">analysis</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">analyzer</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">meteor_packages</span>": <span class="hljs-value">{
          "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"pattern"</span></span>,
          "<span class="hljs-attribute">pattern</span>": <span class="hljs-value"><span class="hljs-string">"[\\:\\-_ ]+"</span>
        </span>} 
      </span>}
    </span>}
  </span>} 
</span>}
</code></pre><p>Now you can send a GET request to the following URL and verify that the new analyzer can tokenize <code>iron:router</code> correctly.</p>
<ul>
<li>method: GET</li>
<li>url: <code>http://localhost:9200/meteor/_analyze?text=iron:router&amp;analyzer=meteor_packages</code></li>
</ul>
<h3 id="create-some-mappings">Create Some Mappings</h3>
<p>Just creating the analyzer won't fix our issue. We need to configure the mapping as well. What is this "mapping"?</p>
<p>If you remember, we talked about this in the previous lesson when we talked about the <a target="_blank" href="/database-modeling/searching-with-elastic-search/2">concepts behind Elastic Search</a>. Let me mention it again. </p>
<p>Although we can store JSON content, Elastic Search needs to know the type of each field in our JSON document. That's how it can effectively index the JSON document. Elastic Search dynamically builds the mapping when we index documents. If we need to tokenize fields using a custom analyzer, we need to mention it explicitly in the mapping. That's what we are going to do now.</p>
<p>Send the following PUT request:</p>
<ul>
<li>method: PUT</li>
<li>url: <a target="_blank" href="http://localhost:9200/meteor/packages/_mapping">http://localhost:9200/meteor/packages/_mapping</a></li>
<li>JSON Content:</li>
</ul>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">packages</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">properties</span>": <span class="hljs-value">{
          "<span class="hljs-attribute">packageName</span>": <span class="hljs-value">{
              "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"string"</span></span>,
              "<span class="hljs-attribute">analyzer</span>": <span class="hljs-value"><span class="hljs-string">"meteor_packages"</span>
          </span>}
      </span>}
  </span>}
</span>}
</code></pre><p>With the above PUT request, we've explicitly asked Elastic Search to analyze the <code>packageName</code> field using our custom analyzer <code>meteor_packages</code>.</p>
<h3 id="let-s-re-index">Let's Re-Index</h3>
<p>Now everything is ready. We can re-index the data set now. There is no automatic way to do it. We need to send data to Elastic Search again. In our app, a bootstrapping logic exists in <code>server/bootstrap.js</code>. To trigger it, we need to reset the MongoDB database. </p>
<p>To do that, let's reset our Meteor project. Simply stop the app and visit the app directory. Apply the following command:</p>
<pre><code class="hljs sql">meteor <span class="hljs-operator"><span class="hljs-keyword">reset</span>
</span></code></pre><p>Then start the app again, and you'll be able see that new data is being sent to Elastic Search. After it has been completed, search for "iron router" with the following REST endpoint.</p>
<ul>
<li>method: POST</li>
<li>url: <a target="_blank" href="http://localhost:9200/meteor/packages/_search">http://localhost:9200/meteor/packages/_search</a></li>
<li>JSON Content:</li>
</ul>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">query</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">match</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">packageName</span>": <span class="hljs-value"><span class="hljs-string">"iron router"</span>
    </span>}
  </span>}
</span>}
</code></pre><p>Then you'll be able to get Iron Router at the top of the results. See <a target="_blank" href="http://recordit.co/CiTBCFRu2m">http://recordit.co/CiTBCFRu2m</a>.</p>
<p>However, if you try to search for "iron router" with our app, you still won't be able to get it at the top. But, we know that it's in the DB, and Elastic Search can search that.</p>
<p>Why doesn’t our search app show "iron:router" at the top?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      `Iron:router` is not in the DB.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Our search query is incorrect.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The relevance score for `iron:router` is too low with our search query and the query input.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We forgot to configure the app for the new `meteor_packages` analyzer.
    </label>
  </div>
  

  
    <p>
      Correct answer is : The relevance score for `iron:router` is too low with our search query and the query input.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="building-a-custom-score">Building a Custom Score</h2>
<p>Our app still can't search 'iron:router' correctly. It’s not an issue with Elastic Search or our configurations. Before we understand the reason behind it, we need to learn about a concept called <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/relevance-intro.html">"Relevance"</a>.</p>
<h3 id="what-is-relevance-">What Is Relevance?</h3>
<p>Elastic Search can search text very effectively. While doing it's search, it will give a score to every search result. This is an indicator that shows the relevance of each particular document against the search query term. We can access that value for each document with the <code>_score</code> field in the search results.</p>
<p>How Elastic Search calculates that value is a bit complex, but the value for <code>_score</code> will depend on the type and number of query types that we're using in the final query. If you’d like to learn more about relevance, there is a separate <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/controlling-relevance.html">chapter for Relevance</a> in the Elastic Search documentation.</p>
<h3 id="controlling-relevance">Controlling Relevance</h3>
<p>Relevance seems like a good thing, but why does it cause problems for us? Actually, we can't rely 100% on the Elastic Search relevance score itself. That's because it gives us the result just by looking at the text content, but in practice, there are some other factors that influence the relevance. </p>
<p>In our case, the number of downloads, GitHub stars, last updated date, and many other parameters influence the relevance.</p>
<p>We need to tell Elastic Search about these parameters, and then it'll do the job correctly. Technically, we are going to define our own relevance value (<code>_score</code>) based on external factors.</p>
<h3 id="custom-_score-value">Custom _score Value</h3>
<p>This is the hardest part. There is no way that we can build a better <code>_score</code> value at once. We need to do some trial and error and find something relevant for us. In this case, we've generated another score called <code>isoScore</code> for each package. We created it by utilizing GitHub stars, the number of versions published, and the last published date. </p>
<p>Now we are going use that value with Elastic Search's native _score to create our custom _score value. For that, we are using another Elastic Search query type called <code>function_score</code>. Here it is:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> boostQuery = {
  <span class="hljs-string">"function_score"</span>: {
    <span class="hljs-string">"query"</span>: query,
    <span class="hljs-string">"functions"</span>: [
      {
        <span class="hljs-string">"script_score"</span>: {
          <span class="hljs-string">"script"</span>: <span class="hljs-string">"doc['isoScore'].value * _score"</span>
        }
      }
    ]
  }
}

<span class="hljs-keyword">var</span> result =  EsClient.search({
  index: <span class="hljs-string">"meteor"</span>,
  type: <span class="hljs-string">"packages"</span>,
  body: {
    query: boostQuery
  }
});
</code></pre><p>We call this new query boostQuery, and it wraps around our original query. Inside boostQuery, it will calculate a new <code>_score</code> value based on the multiplication of both <code>isoScore</code> and <code>_score</code>. This gives us the correct relevance, and we can get the relevant results for our searches.</p>
<p>You can look at the <a target="_blank" href="https://github.com/bulletproof-meteor/bullet-package-search/blob/solution/server/app.js">complete code with the above query</a> on the server-side query definition (on <code>server/app.js</code>):</p>
<p>Check now! We can see <code>iron:router</code> lists on the top even we searched for "router".</p>
<hr>
<p>Here's the final question in this lesson.</p>
<p>You can implement our custom relavancy algorithm using a <a target="_blank" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-sort.html#_script_based_sorting">sort</a> rather than using the <code>function_score</code> query type. Try to follow this documentation and implement it with our app.</p>
<p>What can you tell about the search results for both implementations (via <code>function_score</code> and via sort)?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      `function_score` gives more accurate results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Sort gives more accurate results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Both are the same.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Both are okay, but `function_score` gives better results.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Both are the same.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Building a Real-World Search App – Meteor Package Search</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/1">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/3">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/5">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/database-modeling/building-a-real-world-search-app-meteor-package-search/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="finally">Finally</h2>
<p>We've built a quite advanced search system in this lesson. Give yourself a hand!</p>
<p>Our relevance score works fine, but it might not be perfect for all cases. To get a perfect result, we need to test with different <code>_score</code> calculation algorithms. We also need to experiment with different query types in the search query as well. Give it a try, and try to optimize the results if you can. Don't forget to share your experience with us.</p>
<p>Even though this seems like a complex search app, we are just skimming through the power of Elastic Search. See below for some pointers that you can explore further:</p>
<ul>
<li>Learn more about <a target="_blank" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-queries.html">query types</a></li>
<li>Learn more about <a target="_blank" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-filters.html">filters</a></li>
<li>Learn more about <a target="_blank" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/controlling-relevance.html">relevance score</a> and controlling it</li>
<li><a target="_blank" href="http://exploringelasticsearch.com/">Exploring Elastic Search</a> - Some code samples are outdated, but still content is really good.</li>
</ul>
<p>We hope that, with this knowledge, you'll build a great search solution for your app.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Configuration Management is very important when we are building an app and working with different environments like "production", "staging" and "dev". Here are few configurations we need to deal with:</p>
<ul>
<li>MONGO_URL, MAIL_URL, and other important framework configurations</li>
<li>Stripe tokens, Kadira credentials, and other keys provided to the server</li>
<li>Google Analytics and MixPanel keys exposed to the client</li>
<li>Application-specific configurations</li>
</ul>
<p>This is not directly related to the subject of this course. But configuration management is an important topic, so  it's included in this course.</p>
<p>We're going to discuss how Meteor helps us to manage these configurations and how we can maintain configurations between different environments.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>We need a sample app to practice the things we'll be learning here. You can clone this app via:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-config.git</span>
</code></pre><p>Our app will try to connect with Stripe on the server side and initialize MixPanel on the client side. Check <code>server/app.js</code> and <code>client/app.js</code> respectively.</p>
<p>Once you successfully connected to Stripe you'll see something like below:<br><img src="img/H9mfr18DQc.png" alt="Connected with Stripe"></p>
<p>For Mixpanel on the client it will be something like this:</p>
<p><img src="img/ofpW5wikz2.png" alt="Connected to MixPanel"></p>
<p>These settings are currently hard coded.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="environment-variables">Environment Variables</h2>
<p>Using Environments Variables is the most common way to manage configuration for the server side. It's an universal solution that works with any app, regardless of where it is hosted and which language/framework it uses.</p>
<p>Your hosting provider typically provides some kind of UI to expose environment variables to your app. But locally, we can prefix them before we start our app. This is how we can start a Meteor app with environment variables:</p>
<pre><code class="hljs makefile"><span class="hljs-constant">APPID</span>=myId APPSECRET=mySecret meteor
</code></pre><p>Then you can access these values with Meteor as follows:</p>
<pre><code class="hljs javascript"><span class="hljs-built_in">console</span>.log(process.env.APPID);
<span class="hljs-built_in">console</span>.log(process.env.APPSECRET);
</code></pre><p>So, here's your task. Currently our Stripe configurations are hardcoded in <code>server/app.js</code> as follows:</p>
<pre><code class="hljs perl">Stripe.<span class="hljs-keyword">connect</span>(<span class="hljs-string">'sk_live_vb7uiw3iuk9XiDpKY'</span>, <span class="hljs-string">'pk_live_K6eoaP93bhbbAbXGt'</span>);
</code></pre><p>How do you expose those keys (secretKey and publishKey) via environment variables? Select from the following options:</p>
<h4 id="option-1">Option 1</h4>
<pre><code class="hljs sql">// <span class="hljs-operator"><span class="hljs-keyword">start</span> app <span class="hljs-keyword">with</span>
SECRET_KEY= sk_live_vb7uiw3iuk9XiDpKY PUBLISH_KEY= pk_live_K6eoaP93bhbbAbXGt meteor

// <span class="hljs-keyword">in</span> the app
Stripe.<span class="hljs-keyword">connect</span>(process.env.SECRET_KEY, process.env.PUBLISH_KEY);</span>
</code></pre><h4 id="option-2">Option 2</h4>
<pre><code class="hljs sql">// <span class="hljs-operator"><span class="hljs-keyword">start</span> app <span class="hljs-keyword">with</span>
SECRET_KEY = sk_live_vb7uiw3iuk9XiDpKY PUBLISH_KEY = pk_live_K6eoaP93bhbbAbXGt meteor

// <span class="hljs-keyword">in</span> the app
Stripe.<span class="hljs-keyword">connect</span>(process.env.SECRET_KEY, process.env.PUBLISH_KEY);</span>
</code></pre><h4 id="option-3">Option 3</h4>
<pre><code class="hljs sql">// <span class="hljs-operator"><span class="hljs-keyword">start</span> app <span class="hljs-keyword">with</span>
SECRET_KEY=sk_live_vb7uiw3iuk9XiDpKY PUBLISH_KEY=pk_live_K6eoaP93bhbbAbXGt meteor

// <span class="hljs-keyword">in</span> the app
Stripe.<span class="hljs-keyword">connect</span>(process.env.SECRET_KEY, process.env.PUBLISH_KEY);</span>
</code></pre><h4 id="option-4">Option 4</h4>
<pre><code class="hljs sql">// <span class="hljs-operator"><span class="hljs-keyword">start</span> app <span class="hljs-keyword">with</span>
SECRET_KEY=sk_live_vb7uiw3iuk9XiDpKY PUBLISH_KEY=pk_live_K6eoaP93bhbbAbXGt meteor

// <span class="hljs-keyword">in</span> the app
Stripe.<span class="hljs-keyword">connect</span>(process.env.PUBLISH_KEY, process.env.SECRET_KEY);</span>
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
    <p>
      Correct answer is : Option 3
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="meteor-settings">Meteor Settings</h2>
<p>Meteor allows us to manage configurations through <a target="_blank" href="http://docs.meteor.com/#/full/meteor_settings">Meteor Settings</a>. You might ask, what's the issue with environment variables? You're right: there is no issue with environment variables. But with Meteor, you can't use environment variables to configure client side keys. It's possible with other frameworks that normally generate the html on the server, but it's not possible for Meteor.</p>
<p>With Meteor Settings, you can expose settings (aka configurations) via a JSON file. All the configurations in the "public" object will be exposed to the client. This is an example of a <code>settings.json</code> file. (you can name the file as you want):</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">secretKey</span>": <span class="hljs-value"><span class="hljs-string">"a server secret"</span></span>,
  "<span class="hljs-attribute">public</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">appId</span>": <span class="hljs-value"><span class="hljs-string">"my appId"</span>
  </span>}
</span>}
</code></pre>
<p>When you are running the app, you can provide settings.json file with the following syntax:</p>
<pre><code class="hljs sql">meteor <span class="hljs-comment">--settings settings.json</span>
</code></pre><blockquote>
<p>You can also use the <code>--settings</code> flag when you are deploying using <code>meteor deploy</code>.</p>
</blockquote>
<p>Then you can access these via <code>Meteor.settings</code> in Meteor, while  in the client, only the content inside "public" will be available for use.</p>
<p>Now, it's your turn. You're going to expose a Mixpanel token (in <code>client/app.js</code>) via Meteor.settings.</p>
<p>Create a <code>settings.json</code> file with the MixPanel token, as shown below:</p>
<pre><code class="hljs json">{
  "<span class="hljs-attribute">public</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">mixpanel</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">token</span>": <span class="hljs-value"><span class="hljs-string">"h6831893b1f732j6dsdsd73fe2e7644"</span>
    </span>} 
  </span>}
</span>}
</code></pre><p>What's the correct way to get this value on the client? Choose from the following options:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Mixpanel.init(Meteor.settings.mixpanel.token);
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Mixpanel.init(Meteor.settings.public.token);
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Mixpanel.init(Meteor.public.mixpanel.token);
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Mixpanel.init(Meteor.settings.public.mixpanel.token);
    </label>
  </div>
  

  
    <p>
      Correct answer is : Mixpanel.init(Meteor.settings.public.mixpanel.token);
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="meteor-settings-with-hosting-providers">Meteor Settings with Hosting Providers</h2>
<p>At this point it might seem that Meteor Settings only works locally and with apps deployed with meteor deploy. Yes, that's somewhat true. But there is way you can use Meteor Settings with all other hosting providers. But it's not as straightforward as simply exposing the settings file via the <code>--settings</code> flag.</p>
<p>If you expose the JSON string of the settings file by following the environment variable, Meteor settings will work everywhere.</p>
<pre><code class="hljs ini"><span class="hljs-setting">METEOR_SETTINGS=<span class="hljs-value">'{<span class="hljs-string">"appSecret"</span>: <span class="hljs-string">"mySecret"</span>}'</span></span>
</code></pre><h3 id="meteor-up">Meteor Up</h3>
<p>If you are using <a target="_blank" href="https://github.com/arunoda/meteor-up">Meteor Up</a> to deploy your Meteor app, you can provide settings via its <code>settings.json</code> file and it will do the above step for you.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Configuration Management</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/configuration-management">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/configuration-management/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/configuration-management/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/configuration-management/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/configuration-management/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/configuration-management/5">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="different-environments">Different Environments</h2>
<p>Normally, we run the same application in different environments, like production, staging, and dev. There are a lot of ways to manage them. This is something we do at MeteorHacks.</p>
<h3 id="instance-dev-run">Instance Dev Run</h3>
<p>We believe that developers shouldn't have to worry about configurations. So, once the developer checks out the project from the git, it should be able to run without doing any setup or configurations. </p>
<p>In our Kadira UI, we need to manage different configurations like Stripe keys, Meteor Developer Account Info, and so on. Those development configurations are stored in the source code. We run our app like this:</p>
<pre><code class="hljs nginx"><span class="hljs-title">sh</span> .devrun
</code></pre><p>.devrun is a simple bash script that looks something like this:</p>
<pre><code class="hljs bash"><span class="hljs-shebang">#!/bin/bash
</span>
MONGO_URL=mongodb://localhost/apm \
MONGO_OPLOG_URL=mongodb://localhost/local \
MONGO_METRICS_URL=mongodb://localhost/apm \
AWS_ACCESS_KEY_ID=HDHD7777HDDD8II \
AWS_SECRET_ACCESS_KEY=KHDTVD63232DD6673353GG \
STRIPE_API_KEY=sk_test_88dYsdsdsdjs89222 \
STRIPE_PUBLISHABLE_KEY=pk_test_iik88833Hhhd777 \
meteor --settings ./settings.json <span class="hljs-variable">$@</span>
</code></pre><p>We also have a settings.json file with some other configurations. </p>
<h3 id="storing-configurations-in-git">Storing configurations in git</h3>
<p>We use Meteor Up for deploying, and all the production configurations are stored in the source code under <code>.deploy</code> directory. We use different branches for different environments. </p>
<p>Since our project is private and we have a smaller team, it's completely OK to store production configurations in git. That helps us to deploy quickly. </p>
<blockquote>
<p>Actually, we use <a target="_blank" href="https://codeship.com/projects">Codeship</a> to build and deploy our apps. Storing configurations in the git repo makes things simple.</p>
</blockquote>
<h3 id="storing-configurations-in-dropbox-or-similar-cloud-sharing-sites">Storing configurations in Dropbox or similar cloud sharing sites</h3>
<p>If you have a large team and you worry about security, storing configurations in git is not a good idea. Instead, you need to store them in separately from the source code. One option is to use something like Dropbox.</p>
<p>If you'd like to learn more about how other people manage their configurations, refer to this <a target="_blank" href="https://hub.kadira.io/posts/eE64Yc9TKuYj66oNM">discussion</a>.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Scaling beyond one instance is very important when it comes to a production app. For Meteor, scaling is a bit tricky compared with other apps written with NodeJS, Ruby, and so on.</p>
<p>But most of the techniques we used with other frameworks can be easily applied for Meteor. In this lesson we're going to learn about scaling challenges you will face, whether you've decided to host yourself or use a cloud hosting service. Then you can decide yourself which is the best for your app.</p>
<p>After that we're going to talk about some commonly used techniques for scaling Meteor apps.</p>
<p>There's a lot to cover. Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="what-is-scaling-">What is Scaling?</h2>
<p>First, we need to talk a little bit about scaling. It's not about how many instances you have or what technologies you use. It's about meeting the demand of your users. If you can serve thousands (or more) users at the same level of performance as you did when you had a handful of users, that's successful scaling. It's an art.</p>
<p>Basically, there are two types of scaling.</p>
<h3 id="1-vertical-scaling">1. Vertical Scaling</h3>
<p>With this, we simply improve the performance of a single server. For an example, increasing RAM or the number of CPU cores can be consider as Vertical Scaling.</p>
<p>Vertical Scaling is the easiest way to scale something. But after one point, we can't scale beyond that. Then, it became inefficient and costly to scale.</p>
<h3 id="2-horizontal-scaling">2. Horizontal Scaling</h3>
<p>With this, we try to increase the number of servers rather than increase the performance of a single server. For an example, if we need to serve more we can add more servers and meet the demand. This approach is very popular these days and it's cheap in the long run.</p>
<p>But, this method requires special co-ordination between servers and managing them. So, it's not easy as adding many servers.</p>
<p>Okay, now we know what is scaling and we can proceed. Let's start with the components you need to focus on when it comes to scaling a Meteor app.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="components">Components</h2>
<p>If you are trying to scale a Meteor app, you need to focus on a few key components:</p>
<ul>
<li>MongoDB</li>
<li>Meteor App</li>
<li>Routing</li>
<li>Static content</li>
<li>Background workers</li>
</ul>
<h3 id="mongodb">MongoDB</h3>
<p>MongoDB is a core dependency of most of the Meteor apps, so you need to manage your MongoDB instance first. Having an oplog enabled database is a must. That will improve the performance of your Meteor app a lot.</p>
<p>Most importantly, it will help you to scale horizontally. If there is no oplog support, Meteor needs to poll for data changes every 10 seconds. Then if you make a write operation, it will take up to 10 seconds to propagate into other servers, which kills your app's claim to operate in real time.</p>
<h4 id="replica-set">Replica Set</h4>
<p>It's also very important to run your MongoDB as a replica set. That gives high availability, and your app will work even if one of your replicas is failed (which is not a rare occurrence).</p>
<h4 id="sharding">Sharding</h4>
<p>MongoDB can handle terabytes of data using a single instance. But, scaling horizontally gives more performance since we can distribute the load and data among multiple instances. Horizontal scaling of MongoDB is commonly known as MongoDB sharding.</p>
<blockquote>
<p>Even though a single instance can holds terabytes of data, it's hard to shard a collection larger than 256GB. <a target="_blank" href="https://groups.google.com/forum/#!topic/mongodb-user/6W1VhKouaTo">See why?</a></p>
</blockquote>
<p>At the moment, Meteor does not support MongoDB sharding. But it's on the roadmap.</p>
<h3 id="meteor-app-ddp-server">Meteor App – DDP Server</h3>
<p>The Meteor app's job is to process all your methods and subscriptions. It accepts WebSockets and SockJS connections. It can also process arbitrary HTTP requests and serve static files.</p>
<h4 id="websockets">WebSockets</h4>
<p>The Meteor client always tries to use WebSockets to connect with the Meteor DDP Server. Sometimes, for many different reasons, WebSockets is not available. Here are some of those reasons:</p>
<ul>
<li>Browser compatibility. But almost every modern web browser <a target="_blank" href="http://caniuse.com/#feat=websockets">supports</a> WebSockets.</li>
<li>Transparent proxies. ISPs use this kind of proxies and sometimes they <a target="_blank" href="http://blog.hekkers.net/2012/12/09/websockets-and-mobile-network-operators/">lack</a> WebSockets support.</li>
<li>Firewalls - Some firewalls <a target="_blank" href="https://github.com/Automattic/socket.io/wiki/Socket.IO-and-firewall-software">block</a> WebSocket traffic.</li>
</ul>
<p>If WebSockets is not available, the Meteor client needs to use <a target="_blank" href="https://github.com/sockjs/sockjs-client">SockJS</a>. It uses several different tricks to emulate a WebSocket-like connection.</p>
<h4 id="resource-usage">Resource Usage</h4>
<p>Suppose you need to scale your app because it needs more resources. Here are the two main resources you will be looking at:</p>
<ul>
<li>RAM</li>
<li>CPU</li>
</ul>
<p>Meteor runs as a single process. Currently it does not have a built-in way to use multiple processes. So, when you are choosing instances (servers), follow this method:</p>
<ul>
<li>If your app needs more CPU, look for single core (or single cpu) instances which has the highest CPU power.</li>
<li>If your app needs more RAM, go for RAM. But be aware that you'll still only can use one CPU.</li>
<li>Once you hit the single CPU limit, then you can start scaling horizontally (using multiple instances).</li>
<li>If you are doing horizontal scaling, select similar kinds of instances (same CPU, RAM, data center)</li>
</ul>
<h3 id="routing">Routing</h3>
<p>Routing is a crucial component if you are using more than one Meteor app instance (when doing horizontal scaling). The router simply accepts incoming connections to your app and forwards them to one of your Meteor app instances. There are two common ways routing works:</p>
<ul>
<li>Round Robin based dispatch</li>
<li>Sticky Session based dispatch</li>
</ul>
<p>With Round Robin, the router simply forwards connections to random Meteor app instances. But with Sticky Session, all the connections coming from a single client go to the same Meteor app instance.</p>
<h4 id="meteor-s-sticky-session-usage">Meteor's Sticky Session Usage</h4>
<p>For WebSockets, it does not matter if your router uses Round Robin or not. That's because WebSockets connection is a single connection made between the client and the server.</p>
<p>But when using SockJS, it normally uses multiple XHR connections (or similar <a target="_blank" href="https://github.com/sockjs/sockjs-client#supported-transports-by-name">approaches</a>) to emulate a WebSocket like connection. Therefore it is very important to have Sticky Session based routing. Otherwise, those XHR connections for a single SockJS connection will be routed to difference servers.</p>
<h3 id="static-content">Static Content</h3>
<p>If your app needs to serve images, videos, or any other static content, try to delegate that task to some other service which is good at it, like S3, Google Cloud Storage, or CouchDB.</p>
<blockquote>
<p>We're <strong>not</strong> talking about a few images and css files that your app may use. If that's the case, it's totally OK to serve them via Meteor.</p>
</blockquote>
<p>The reason is simple. Meteor's DDP implementation is not good at serving binary content. So, you should <strong>not</strong> use DDP to download or upload static content.</p>
<p>On the other hand, NodeJS (which Meteor runs on top of) is also not good at serving static content.</p>
<blockquote>
<p>There's another lesson dedicated to the proper way to handle file uploads with Meteor and we'll talk more about static content there.</p>
</blockquote>
<h3 id="background-jobs">Background Jobs</h3>
<p>Meteor runs on a single process and it's a single threaded app. So, if you need to do some CPU-heavy operations, always try to delegate that part to some other background worker. </p>
<blockquote>
<p>We are also not going to discuss this further here; we'll talk more about it in a separate lesson.</p>
</blockquote>
<p>Now you have a pretty good understanding of the core components to consider when you're scaling a Meteor app. </p>
<p>So, it's time for a simple question.</p>
<p>Let's say you're trying to scale a Meteor app into multiple instances. Which one of these factors should you <strong>not</strong> focus on?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Having an oplog enabled MongoDB server
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Sticky Sessions-supported routing layer
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Choosing servers with a maximum number of CPU cores
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Using Amazon S3 to upload and serve static content
    </label>
  </div>
  

  
    <p>
      Correct answer is : Choosing servers with a maximum number of CPU cores
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="cloud-based-setup">Cloud-based Setup</h2>
<p>Now we're going to discuss how to scale a Meteor app using only cloud services. This is the best way to scale Meteor if you don't have prior experience with scaling.</p>
<h3 id="compose-for-mongodb">Compose for MongoDB</h3>
<p><a target="_blank" href="https://www.compose.io/">Compose</a> provides high quality MongoDB servers, with affordable pricing. They are one of the few MongoDB hosting providers that allows you to access the oplog. </p>
<p>You will need a <code>MONGO_URL</code> and <code>MONGO_OPLOG_URL</code>. You can simply create them using their admin panel. Follow this <a target="_blank" href="https://blog.compose.io/meteor-the-oplog-and-elastic-deployment/">guide</a> to create these urls.</p>
<h3 id="modulus-io-for-meteor">Modulus.io for Meteor</h3>
<p><a target="_blank" href="https://modulus.io/">Modulus.io</a> is the only cloud hosting provider that supports Meteor deployments officially. That means you can simply deploy your Meteor app by invoking <code>modulus deploy</code>. Modulus also supports Sticky Sessions in its routing layer.</p>
<p>Creating a Modulus app is <a target="_blank" href="http://help.modulus.io/customer/portal/articles/1647770-using-meteor-with-modulus">simple</a>. If your app needs more RAM, you can choose from a few options, including 396MB, 512MB, and 1024MB instances.</p>
<p>If your app needs more CPU, try to select the 396MB instances(servos). Because the way Modulus allocates CPU resources per instance is not documented. This means that you can't be sure that you'll get more CPU power if you select an instance with 1024MB of memory instead 396MB.</p>
<blockquote>
<p>You need to choose instances of Modulus and Compose which are located in the same geographical zone. Otherwise you'll have to face latency issues.</p>
</blockquote>
<h3 id="environment-variables">Environment Variables</h3>
<p>After you've created the app, you can set environment variables for your app, including <code>MONGO_URL</code> and <code>MONGO_OPLOG_URL</code>, as follows:</p>
<pre><code class="hljs ruby"><span class="hljs-prompt">modulus env set MONGO_URL &lt;mongoUrl&gt;</span>
<span class="hljs-prompt">modulus env set MONGO_OPLOG_URL &lt;mongoOplogUrl&gt;</span>
</code></pre><h3 id="deployment">Deployment</h3>
<p>As I said before, the Modulus command line interface supports deploying Meteor apps. So you can simply invoke the following command to deploy your Meteor app:</p>
<pre><code class="hljs coffeescript"><span class="hljs-comment"># one in the first time</span>
<span class="hljs-built_in">npm</span> i -g modulus 

modulus deploy
</code></pre><p>Heroku is the most popular cloud hosting solution. But Heroku can't be used to scale Meteor apps. What do you think the reason for this is? (You may need to research this a little bit.)</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It is costly.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      They don't support Sticky Sessions.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      There is no way to deploy a Meteor app into Heroku.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can't use oplog enabled MongoDB with Heroku.
    </label>
  </div>
  

  
    <p>
      Correct answer is : They don't support Sticky Sessions.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="hybrid-approach">Hybrid Approach</h2>
<p>Now we are going to discuss how to use a hybrid approach to scale Meteor. Technically, we are going to use a mix of cloud services and self-hosted solutions.</p>
<h3 id="mongodb">MongoDB</h3>
<p>It is very hard to maintain a production quality MongoDB instance. It requires expertise, not only to deploy it but also to maintain it. So again, it's a good idea to use Compose or something similar for the oplog enabled MongoDB hosting.</p>
<blockquote>
<p>Try to select a data center for your MongoDB instance(s) in the same data center as your Meteor app servers. Compose offers MongoDB instances from almost every data centers from popular cloud services.</p>
</blockquote>
<h3 id="meteor-app">Meteor App</h3>
<p>This time, we'll use <a target="_blank" href="https://github.com/arunoda/meteor-up">Meteor Up</a> to manage our Meteor deployment. With Meteor Up you can turn any Ubuntu instance into a production grade Meteor deployment.</p>
<p>It supports multiple instances and you can deploy to all of them with a single command.</p>
<h3 id="server-selection">Server Selection</h3>
<p>You can select servers from any provider you like. Normally it doesn't matter whether it's from Digital Ocean, AWS, Linode, or something else. But, there are some factors you need to focus on:</p>
<ul>
<li>Choose identical instances.</li>
<li>If you are going after CPU, select only servers with a single CPU.</li>
<li>If you going after RAM, choose a RAM size that can be served using a single CPU.</li>
<li>Try to select instances from the single data center.</li>
</ul>
<h3 id="routing">Routing</h3>
<h4 id="self-maintained">Self-Maintained</h4>
<p>For routing you have few options. HaProxy and Nginx are equally efficient when it comes to routing and load balancing. You can find instructions on how to use both for Meteor in the following links:</p>
<ul>
<li><a target="_blank" href="https://meteorhacks.com/how-to-scale-meteor.html#configuring-the-load-balancer-haproxy">Haproxy</a></li>
<li><a target="_blank" href="http://stackoverflow.com/questions/18003689/recommended-nginx-configuration-for-meteor">Ngnix</a></li>
</ul>
<p>When selecting a server for Nginx or HaProxy, make sure those instances have enough CPU and memory to handle all your connections.</p>
<h4 id="amazon-elastic-load-balancer-aws-elb-">Amazon Elastic Load Balancer (AWS ELB)</h4>
<p>If you don't want to manage a load balancer and you are hosting your app with AWS, you can use <a target="_blank" href="http://aws.amazon.com/elasticloadbalancing/">AWS ELB</a> for the routing. It has an option that supports <a target="_blank" href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/US_StickySessions.html">Sticky Sessions</a>.</p>
<p>Be warned: once you turn on Sticky Sessions, AWS ELB won't be able to handle WebSockets. If you are OK with that, ELB is a really good option. </p>
<p>If you are using ELB, make sure to turn off WebSockets support from your app. You can do this by exposing the following environment variable:</p>
<pre><code class="hljs makefile"><span class="hljs-constant">DISABLE_WEBSOCKETS</span>=1
</code></pre><p>Now the Meteor client knows that WebSockets is disabled and it does not try to use WebSockets. This reduces initial connection time.</p>
<p>By following the above configurations, you can fire up a decent scalable Meteor setup yourself. </p>
<blockquote>
<p>If you don't have much experience, I highly recommend following the cloud-based solution discussed above. Later on, you can come back and try out this self-maintained approach.</p>
</blockquote>
<p>Now, here's a question for you.</p>
<p>Select the factor we don't need to consider when choosing instances for the Meteor app:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Try to find instances with single CPU core.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Use identical instances.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Select instances in the same data center,
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Select instances from different cloud providers,
    </label>
  </div>
  

  
    <p>
      Correct answer is : Select instances from different cloud providers,
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Scaling Techniques and Challenges</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/scaling-techniques-and-challenges">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/scaling-techniques-and-challenges/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/3">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/scaling-techniques-and-challenges/4">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/scaling-techniques-and-challenges/5">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="additional-resources">Additional Resources</h2>
<p>Scaling is a vast area and there are a lot more techniques we could discuss. We'll cover some of them later in the course. If you are keen to know more, here are some additional resources.</p>
<ul>
<li><a target="_blank" href="https://meteorhacks.com/pro-meteor/">Pro Meteor Guide</a></li>
<li><a target="_blank" href="https://xivilization.net/~marek/blog/2014/08/07/dockerizing-meteor/">Docker and Meteor</a></li>
<li><a target="_blank" href="https://github.com/phusion/passenger/wiki/Phusion-Passenger:-Meteor-tutorial">Using Phusion Passenger with Meteor</a></li>
<li><a target="_blank" href="https://github.com/ongoworks/launchdock">Launch Dock</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>When we are building an app, it's quite common to implement background jobs for certain tasks. It would be better if we could run separate workers for those instances. In this lesson, we're going to build a DDP-based job processing system from scratch.</p>
<p>This is what we are going to build: </p>
<iframe src="//www.youtube.com/embed/fqA0i2artVU" allowfullscreen="1" width="640" frameborder="0" height="480"><br></iframe>

<p>Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>We are going to implement what you just saw on the video. For that, we first need to clone this repo:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-ddb-job-server.git</span>
</code></pre><p>This repo has three Meteor apps located in <code>main</code>, <code>worker1</code>, and <code>worker2</code> directories. You need to start these apps in the following ports:</p>
<ul>
<li>main – port 8005</li>
<li>worker1 – port 7005</li>
<li>worker2 – port 7015</li>
</ul>
<p>As their names imply, the first one is the main app, which does scheduling, and the other two are the workers. Workers only contain a simple method that mimics some real work (like processing a video).</p>
<p>Start the above apps and open the main app in the browser. Then click the "Process Video" button. What's the output you see on the screen?</p>
<h4 id="option-1">Option 1</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">error</span> <span class="hljs-tag">processing</span>: <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[400]</span>
</code></pre><h4 id="option-2">Option 2</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[500]</span>
</code></pre><h4 id="option-3">Option 3</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">error</span> <span class="hljs-tag">processing</span>: <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[500]</span>
</code></pre><h4 id="option-4">Option 4</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span> <span class="hljs-tag">completed</span>!
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
    <p>
      Correct answer is : Option 3
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="what-s-inside-">What's Inside?</h2>
<p>Let's see what's inside these apps.</p>
<h3 id="workers">Workers</h3>
<p>Both of the workers are identical and contain the following code, which simulates a long-running task:</p>
<pre><code class="hljs javascript">Meteor.methods({
  <span class="hljs-string">"processVideo"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"processing video for 2 seconds"</span>);
    Meteor._sleepForMs(<span class="hljs-number">2000</span>);
    <span class="hljs-keyword">return</span> {done: <span class="hljs-literal">true</span>};
  }
});
</code></pre><h3 id="main-app">Main App</h3>
<p>The main app does the scheduling and has a very simple UI. We are only interested in code that lives inside the <code>server</code> directory.</p>
<p><code>server/main.js</code> has the content shown below, which initializes workers. It also accepts jobs via the <code>processVideo</code> method from the client, and invokes workers.</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> workerUrls = [
  <span class="hljs-string">"http://localhost:7005"</span>,
  <span class="hljs-string">"http://localhost:7015"</span>
];

<span class="hljs-keyword">var</span> workers = <span class="hljs-keyword">new</span> Workers(workerUrls);

Meteor.methods({
  processVideo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();
    <span class="hljs-keyword">return</span> workers.processVideo();
  }
});
</code></pre><p>Let's see what's inside the <code>Workers</code> class. It's located at <code>server/workers.js</code>.</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  <span class="hljs-comment">// You are going to implement the actual connection logic here</span>

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}

Workers.prototype.getNextWorker = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.workers.length == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._nextWorker &gt;= <span class="hljs-keyword">this</span>.workers.length) {
    <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">this</span>.workers[<span class="hljs-keyword">this</span>._nextWorker++];
  <span class="hljs-keyword">return</span> worker;
};

Workers.prototype.processVideo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  args = _.toArray(args);
  args.unshift(<span class="hljs-string">'processVideo'</span>);
  <span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">this</span>.getNextWorker();
  <span class="hljs-keyword">if</span> (worker) {
    <span class="hljs-keyword">return</span> worker.call.apply(worker, args);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">500</span>, <span class="hljs-string">"no worker to process"</span>);
  }
};
</code></pre><p>Inside the "Workers" class, we are going to make a DDP connection to each worker it's initialized with. The following two methods have been implemented for you:</p>
<ul>
<li><code>getNextWorker</code> method gets a worker from the <code>this.workers</code> array, if there are any.</li>
<li><code>processVideo</code> simply gets a worker and invokes the <code>processVideo</code> Meteor method on that worker.</li>
</ul>
<blockquote>
<p><code>this.workers</code> array contains the DDP connections of connected workers. Currently, it's an empty array.</p>
</blockquote>
<p>Previously, you got an error when trying to invoke "processVideo" from the client. How do you think you should fix it?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Make connections to workers.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Make connections to workers and add them to `this.workers`.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Invoke the `DDP.addWorker()` method for each worker.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Invoke the `DDP.createWorker()` method for each worker.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Make connections to workers and add them to `this.workers`.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="connecting-to-workers">Connecting to Workers</h2>
<p>First of all, make sure our two workers are running on ports 7005 and 7015, respectively.</p>
<p>We are going to use the <code>DDP.connect</code> API to connect to those workers. It's a very simple API with the following syntax:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> meteorAppUrl = <span class="hljs-string">"http://localhost:7005"</span>;
<span class="hljs-keyword">var</span> client = DDP.connect(meteorAppUrl);
</code></pre><p>The <code>client</code> object has all the familiar methods like <code>call</code> and<code>subscribe</code>. They behave in exactly the same way as  they behave in the browser. If you'd like to learn more, check out the <a target="_blank" href="http://docs.meteor.com/#/full/ddp_connect">official docs</a>.</p>
<p>So, your task is simple. Iterate over the <code>workers</code> argument of the constructor. Then connect to those workers and push them into the <code>this.workers</code> array.</p>
<p>After you've done that, try clicking "Process Video" again. What's the message you got?</p>
<h4 id="option-1">Option 1</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processed</span>
</code></pre><h4 id="option-2">Option 2</h4>
<pre><code class="hljs javascript">[jobId: <span class="hljs-number">1</span>] processing
[jobId: <span class="hljs-number">1</span>] processed: {<span class="hljs-string">"done"</span>:<span class="hljs-literal">true</span>}
</code></pre><h4 id="option-3">Option 3</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span> <span class="hljs-tag">completed</span>!
</code></pre><h4 id="option-4">Option 4</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">done</span>
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
    <p>
      Correct answer is : Option 2
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Great. Here's the actual implementation we are expecting. Compare it with yours.</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  workers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
    <span class="hljs-keyword">var</span> worker = DDP.connect(url);
    self.workers.push(worker);
  });

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}
</code></pre>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>This implementation works, but it does not handle connection status properly. You can try that yourself: close all the workers and click "Process Video". </p>
<p><em>You could able to submit jobs, but nothing happens.</em></p>
<p>In such situations, we need to pick disconnected workers and remove them from the <code>this.workers</code> array. For that, we are going to use the <code>client.status()</code> API. It will give us an object that contains the status of the connection. That object has a field called <code>connected</code>, which indicates the status of the connection.</p>
<pre><code class="hljs javascript"><span class="hljs-built_in">console</span>.log(client.status().connected) <span class="hljs-comment">// true -&gt;</span>
</code></pre><p>This APIs similar to the <code>Meteor.status</code> API. You can learn more about it <a target="_blank" href="http://docs.meteor.com/#/full/meteor_status">here</a>.</p>
<p>If you look at the docs properly, <code>client.status()</code> is a reactive API; we can watch the status with <code>Tracker.autorun()</code>. </p>
<p>Normally, we don't use the <code>Tracker</code> APIs in the server. But we can use Tracker inside the server for this particular purpose—there is nothing wrong with that. You can write something like the code below without any issues.</p>
<pre><code class="hljs javascript">Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(client.status().connected);
});
</code></pre><p>Now you are going to watch the status of each worker and remove any worker that gets disconnected from <code>this.workers</code>. Once  a worker comes back, add it to the <code>this.workers</code> array.</p>
<p>Do that now.</p>
<p>After you've done that, disconnect one worker and click "Process Video" a few times. What's your observation?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      None of them processed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Only half of them processed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      You got a "timeout error" message.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      All of them processed successfully.
    </label>
  </div>
  

  
    <p>
      Correct answer is : All of them processed successfully.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Ideally, This is the implementation you should have written:</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  workers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
    <span class="hljs-keyword">var</span> worker = DDP.connect(url);

    Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> status = worker.status();
      <span class="hljs-keyword">if</span> (status.connected) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"worker connected: "</span> + url);
        self.workers.push(worker);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> index = self.workers.indexOf(worker);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"worker disconnected: "</span> + url);
          self.workers.splice(index, <span class="hljs-number">1</span>);
        }
      }
    });
  });

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}
</code></pre>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="other-approaches-to-job-management">Other Approaches To Job Management</h2>
<p>In this lesson, we've build a Job Management system ourself. Our focus was not to build a perfect "Job Management" system, but to take the first step and learn about server to server DDP.</p>
<p>In the Meteor community there are couple of packages for managing distributed jobs. Let me show you few of them:</p>
<ul>
<li><a target="_blank" href="https://github.com/Differential/meteor-workers/">Workers</a> - This project is similar to what we've done here. It'll manages workers for you.</li>
<li><a target="_blank" href="https://github.com/percolatestudio/meteor-synced-cron">Synched Cron</a> - It's a distributed cron like job management system.</li>
<li><a target="_blank" href="https://github.com/vsivsi/meteor-job-collection">Job Collections</a> - It's another attempt to Job Scheduling for Meteor. It has a rich API compared with the simple API provided by Synched Cron.</li>
</ul>
<p>All of the above solutions are directly coupled with Meteor. But, you can always use dedicated queuing servers and cloud services for Job Management. Let me show you few of them:</p>
<ul>
<li><a target="_blank" href="https://www.rabbitmq.com/">RabbitMQ</a></li>
<li><a target="_blank" href="http://kafka.apache.org/">Kafka</a></li>
<li><a target="_blank" href="http://www.iron.io/mq">Iron MQ</a></li>
<li><a target="_blank" href="https://cloud.google.com/pubsub/docs">Google Cloud Pub/Sub</a></li>
<li><a target="_blank" href="http://aws.amazon.com/sqs/">AWS SQS</a></li>
</ul>
<p>You can easily use most of these with your Meteor app using their nodejs integrations.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="other-use-cases-for-server-to-server-ddp">Other Use Cases for Server To Server DDP</h2>
<p>A job scheduling system is one use case where a server-to server DDP comes in useful. But there are a lot of other things you can do with a server-to-server DDP. Here are some of them:</p>
<ul>
<li>Real-time monitoring endpoints</li>
<li>Building APIs</li>
<li>Gluing your backend systems</li>
<li>Providing a management console for some systems</li>
</ul>
<p>What else could we build with a server-to-server DDP? Do you have some previous experience with them? Share them with us in the comments section.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>When we are building an app, it's a good idea to build it as a set of modules. But up until the recent past, we put all these modules inside a single app. Those modules could include:</p>
<ul>
<li>Business logic processing</li>
<li>Email sending</li>
<li>Dealing with different data sources</li>
<li>Background jobs</li>
<li>User interfaces and user-facing components</li>
<li>APIs for mobile and other devices</li>
</ul>
<p>It's easy for us to put all these things in a single app at first, but that's not a good solution in the long run. You will start to see issues when your app goes into production. Let’s talk about a few of such issues:</p>
<ul>
<li>Scaling issues ‒ some modules of your app need more resources; others don’t, so when you are scaling, you need to scale the whole app, but not the parts that need to be scaled.</li>
<li>Code management issues ‒ there will be a lot of code, and it'll be harder to manage it.</li>
<li>Access control issues ‒ now everyone on your team has access to whole code base, so it's hard to do proper access control.</li>
</ul>
<h2 id="welcome-to-mircoservices">Welcome to Mircoservices</h2>
<p>A lot of people have tried different solutions. One such solution is microservices. With microservices, you can structure your app as a few different services. Each services runs independently.</p>
<p>These services communicate with each other using APIs (normally with HTTP APIs).  There are service discovery solutions to automatically identify these services, so you don't need to worry about keeping track of where those services deployed to.</p>
<p>By using microservices, we can get rid of most of the issues we've discussed earlier.</p>
<ul>
<li>Now you can scale only services which needs more resources</li>
<li>Code management and access control is simple since you can have separate repositories for each service</li>
</ul>
<p>As a result of this architecture your app will be transformed into a set of tiny services. We called it as cluster of services. All these services are very simple and easy to manage, so you can focus more on your business rather than worrying about the app itself.</p>
<h2 id="meteor-and-ddp-for-microservices">Meteor and DDP for Microservices</h2>
<p>Some people argue that Meteor is monolithic and hard to scale. But actually, as with any other platform, you can build apps monolithically with Meteor, too, so it's not a problem with the framework but with how we architect our app.</p>
<p>Meteor and DDP are a perfect match for microservices. Since DDP is a universal protocol, we can build services in different languages and let them communicate with each other.</p>
<p>In this lesson, we are going to transform a monolithic Meteor app into a distributed set of microservices. Let's get started.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As we discussed, we are going to convert a monolithic app into few different services, so we need an app.</p>
<p>Here it is. It's another version of our Meteor package search app. This time, it's slightly different from previous versions.</p>
<p>Let's have a look at it:</p>
<iframe src="//www.youtube.com/embed/ISVfaTuGafw" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<p>You can clone this app with:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-microservices.git</span>
</code></pre><p>Run this app locally and try to look at the codebase. We are going to work on this app in a moment.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="dividing-an-app-into-services">Dividing an App into Services</h2>
<p>Now our task is to divide our package search app into few different services. There is no right or wrong way to do this. For this app, let's try to divide the app into two services along with the main app:</p>
<ul>
<li>Search service ‒ handles the package search functionality</li>
<li>Logging service ‒ accepts logs and manages them</li>
<li>Main service (Web app) ‒ the main service responsible for the UI logic and integration</li>
</ul>
<blockquote>
<p>We are going to use the term "app" and "service" interchangeably to refer to a service that is a Meteor app.</p>
</blockquote>
<p>These three services are available in the <code>three-services</code> branch of our app. You can get them with:</p>
<pre><code class="hljs nginx"><span class="hljs-title">git</span> checkout three-services
</code></pre><p>All three of these services are Meteor apps running with their own DB. You can run them on any port you like, but if possible, try to run them on the following ports:</p>
<ul>
<li>main ‒ port 6001</li>
<li>search ‒ port 7001</li>
<li>logging ‒ port 8001</li>
</ul>
<p>Then try to access the main app via the browser. You'll get data for "Popular Packages," but you won't get any search results after you've entered the search text. That's because we've not yet integrated search and logging services into our main app.</p>
<p>This is our existing server-side logic in the <code>main</code> app: (server/app.js):</p>
<pre><code class="lang-js hljs javascript">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-keyword">return</span> [];
});

Meteor.publish(<span class="hljs-string">'topPackages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> options = {sort: {isoScore: -<span class="hljs-number">1</span>}, limit: <span class="hljs-number">20</span>};
  <span class="hljs-keyword">return</span> Packages.find({}, options);
});
</code></pre>
<h3 id="service-integration">Service Integration</h3>
<p>As we integrate these services, we don't need to worry much. If you look at the search and logging apps, they have exposed two Meteor methods from their apps, so we are going to connect with these services (via DDP) from the main app and call the methods.</p>
<p>Here are the two methods:</p>
<p><strong>From the search app (port 7001)</strong></p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// server/app.js</span>
Packages = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">'packages'</span>);

Meteor.methods({
  <span class="hljs-string">"getPackages"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
    ...
  }
});
</code></pre>
<p><strong>From the logging app (port 8001)</strong></p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// make this a capped collection to rotate logs</span>
<span class="hljs-keyword">var</span> Logs = <span class="hljs-keyword">new</span> Meteor.Collection(<span class="hljs-string">'logs'</span>);

Meteor.methods({
  <span class="hljs-string">"log"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source, message)</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();
    Logs.insert({ source: source, message: message, time: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"[%s] %s"</span>, source, message);
  }
});
</code></pre>
<p>Connecting to these services is very simple. We just need to make a new DDP connection and call particular methods. First, let's try to implement the logging functionality for the <strong>main</strong> app. This is how we can do it. Put the following content into <code>server/app.js</code> in the <strong>main</strong> app.</p>
<blockquote>
<p>For the searching, we are using a special package called <a target="_blank" href="https://github.com/meteorhacks/search-source">search-source</a>. The following code contains the data source definition for the search source. We talk more about this package in <a target="_blank" href="database-modeling/building-a-real-world-search-app-meteor-package-search">"Building a Real-World Search App"</a> lesson. You can also look for the <a target="_blank" href="https://github.com/meteorhacks/search-source">documentation</a> on GitHub as well.</p>
</blockquote>
<pre><code class="hljs javascript"><span class="hljs-comment">// connecting to the logging service</span>
<span class="hljs-keyword">var</span> logConn = DDP.connect(<span class="hljs-string">"http://localhost:8001"</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">var</span> searchResult = [];

  <span class="hljs-keyword">return</span> searchResult;
});
</code></pre><p>Now, when you are typing some keywords in the search box, some messages will be printed in our logging app. This means that our logging service is working pretty well.</p>
<p>Just like we did above, try to connect to the <code>search</code> service and invoke the <code>getPackages</code> method with <code>searchText</code> and <code>options</code> as the arguments. Then assign the output of the method call to <code>searchResults</code>. After that, you'll be able to search from the UI.</p>
<p>Now, we have a question for you:</p>
<p>Stop the search service (on port 7001) and then try to search some packages. After that, start the search service and try to search some packages. Select your observation from the list below:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      When stopped, the search result box shows "disconnected" text, and when it is restarted, I get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows "searching ..." text, and when it is restarted, I get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows "searching ..." text, and I had to restart the main app to get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows nothing, and when it is restarted, I get the search results.
    </label>
  </div>
  

  
    <p>
      Correct answer is : When stopped, the search result box shows "searching ..." text, and when it is restarted, I get the search results.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>As you've noticed, Meteor will automatically reconnect to a DDP endpoint once it's available again, which is nice.</p>
<hr>
<p>This is the our version of <code>server/app.js</code> in  the main app. It could be slightly different from your implementation.</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// connecting to the logging service</span>
<span class="hljs-keyword">var</span> logConn = DDP.connect(<span class="hljs-string">"http://localhost:8001"</span>);
<span class="hljs-comment">// connecting to the search service</span>
<span class="hljs-keyword">var</span> searchConn = DDP.connect(<span class="hljs-string">"http://localhost:7001"</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution and run in the next event loop</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">var</span> searchResult = searchConn.call(<span class="hljs-string">"getPackages"</span>, searchText, options);
  <span class="hljs-keyword">return</span> searchResult;
});
</code></pre>
<p>This version of the app has a little issue. This means that we need to explicitly mention the URLs of both the "search" and "logging" services inside the main app, so that's a kind of management issue. This gets worse when we are using a lot of microservices.</p>
<h2 id="service-discovery">Service Discovery</h2>
<p>This is where service discovery is going to help us, so what is service discovery? Although it's a fancy name, it does something very simple. Let’s explain this with an example:</p>
<ul>
<li>Let's say that our service discovery solution is called a "cluster."</li>
<li>After the search app is loaded, it registers itself as the "search" and sends its URL to the cluster.</li>
<li>Then, the logging app does the same.</li>
<li>Now, when the main app is loaded, it will ask the URLs of both search and logging apps from the cluster.</li>
<li>The cluster gives the logging apps, and the main app can connect with the services.</li>
</ul>
<p>This is the main idea behind service discovery, though it does a lot more than this. With this, none of the services needs to know about the others. They'll get to know each other through the cluster.</p>
<p><strong>Our issue has just been solved!</strong></p>
<p>Actually, Cluster is the name of a service discovery solution that is available for Meteor. Let's integrate it into our app.</p>
<h4 id="adding-cluster">Adding Cluster</h4>
<p>First, we need to install a package called <a target="_blank" href="https://github.com/meteorhacks/cluster"><code>meteorhacks:cluster</code></a> to all our apps.</p>
<pre><code class="hljs css"><span class="hljs-tag">meteor</span> <span class="hljs-tag">add</span> <span class="hljs-tag">meteorhacks</span><span class="hljs-pseudo">:cluster</span>
</code></pre><p>This cluster solution needs a central data repository. It uses MongoDB for that, so you need to connect to the cluster with a MONGO_URL. Therefore, you have to run your local MongoDB instance.</p>
<blockquote>
<p>If you've not installed MongoDB on your machine yet, use these <a target="_blank" href="http://docs.mongodb.org/manual/installation/">instructions</a>.</p>
</blockquote>
<p>This will be our Mongo URL for the cluster.</p>
<pre><code class="hljs javascript">mongodb:<span class="hljs-comment">//localhost:27017/discovery</span>
</code></pre><h4 id="registering-services">Registering Services</h4>
<p>Now we need to register two services (search and logging) and the main with with the cluster.</p>
<p>Let's see how we can do that for the <strong>search</strong> service.</p>
<p>Add the following code to the top of <code>server/app.js</code> in the <strong>search</strong> app.</p>
<pre><code class="lang-js hljs javascript">Cluster.connect(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"search"</span>);
</code></pre>
<p>Then you need to do the same for the logging service and the main app. For the logging service, register it as "logging". For the main app, register it as "web".</p>
<h4 id="discovering-connections">Discovering Connections</h4>
<p>Now, within the main app, we can simply discover connections by name. Let’s how we can do that:</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// connecting to the logging app</span>
Cluster.connect(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"web"</span>);
<span class="hljs-keyword">var</span> logConn = Cluster.discoverConnection(<span class="hljs-string">'logging'</span>);
<span class="hljs-keyword">var</span> searchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution and run in the next event loop</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});

<span class="hljs-comment">// there are some other code beyond this</span>
</code></pre>
<p>Now run these three Meteor apps and try to access the main app, and you'll be able to search packages, and logs will also be printed.</p>
<p>Visit <a target="_blank" href="http://localhost:6001">http://localhost:6001</a> and give it a try.</p>
<hr>
<p>Before we proceed to the next section, let's do an experiment.</p>
<p>Stop the search service. Try to search for some packages on the UI. Of course, you can't search them for sure. Then start our search app on another <strong>port</strong>. Can you search now?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      No. I had to restart the main app.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, but only after 1 minute when the new search service became active.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, but I had to restart the local MongoDB server.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Yes.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As you experienced just now, the beauty of <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> and service discovery is that it knows how to connect to a new service started on a completely different URL, so you don't need to worry about managing URLs anymore.</p>
<p>For high availability, you can also start multiple search service instances, and Cluster picks the next available instance if one instance goes down.</p>
<h2 id="how-cluster-works">How Cluster Works</h2>
<p>There is no magic. Let's explain what's going on here. Let's say that you register a service just like this one:</p>
<pre><code class="hljs perl">Cluster.<span class="hljs-keyword">connect</span>(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"search"</span>);
</code></pre><p>Cluster gets the URL of this app from the <code>ROOT_URL</code> env variable. You can also set a custom URL as follows:</p>
<pre><code class="hljs css"><span class="hljs-tag">Cluster</span><span class="hljs-class">.register</span>("<span class="hljs-tag">search</span>", <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">url</span>:<span class="hljs-value"> <span class="hljs-string">"http://some-other-url"</span> </span></span></span>});
</code></pre><p>Then it will update an entry on a MongoDB collection for every 15 seconds for this service. (The time may vary slightly in a real actual scenario). This will ensure that this service is live and can accept requests.</p>
<p>Then comes the discovery part.</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> searchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
</code></pre>
<p>When you are trying to discover a connection as shown above, it will first give you a proxy DDP connection that is not connected to anywhere. Then, behind the scenes, Cluster will query MongoDB and find a URL for the search service. After that, it creates a DDP connection to the URL and assigns it to the proxy connection.</p>
<p>If the DDP connection goes down, it will query again and try to see if there is a new URL for the service. If it finds a new one, Cluster creates a new connection for that URL and assigns it to the proxy connection.</p>
<p>If you've done any operations in between, they will be cached and applied to the new connection so there won't be any data losses.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="is-this-production-ready-">Is This Production Ready?</h2>
<p>We can't give you 100% guarantee on this, but we use cluster internally at Kadira and we are really happy with it. Kadira has a lot of services doing several tasks. Here are some of them:</p>
<ul>
<li>Data accepting</li>
<li>Data processing</li>
<li>Email scheduling</li>
<li>Alerts</li>
<li>Different background tasks</li>
<li>Analytic services</li>
</ul>
<p>Some of the above services run inside cloud infrastructure we manage. Some services runs on Heroku and Modulus. So, cluster is an universal solution works pretty well for us. So, this should be work for you as well.</p>
<blockquote>
<p>If you got any issues, don't forget to submit an <a target="_blank" href="https://github.com/meteorhacks/cluster/issues">issue</a>.</p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>Service discovery is a hot topic, and there are some other solutions out there. All these solutions have their own pros and cons. We'd like to explain why we decided to go with MongoDB and Cluster for Meteor.</p>
<h3 id="peer-to-peer-discovery-solutions">Peer-to-peer Discovery Solutions</h3>
<p>With these solutions, we don't have a central dependency like MongoDB. Individual services can communicate with each other. <a target="_blank" href="https://serfdom.io/">Serf</a> is one such solution.</p>
<p>But most of the time, these solutions are <a target="_blank" href="https://www.serfdom.io/docs/internals/gossip.html">eventually consistent</a>. This means that all the services in the cluster can know each other eventually, but we cannot guarantee when. Another issue is the bandwidth. Every node in the cluster will get all the messages, including heartbeats, so we'll have to face some issues with that.</p>
<h3 id="consul-etcd-and-zookeeper">Consul, Etcd, and ZooKeeper</h3>
<p>These are some great service discovery solutions. <a target="_blank" href="http://zookeeper.apache.org/">ZooKeeper</a> is the oldest and most famous solution (especially in the Java community), but it's very hard to use and access.</p>
<p>There are some new tools, such as <a target="_blank" href="http://www.consul.io/">Consul</a> and <a target="_blank" href="https://github.com/coreos/etcd">Etcd</a>. These two solutions are comparatively easy to run and access. Both these solutions have HTTP APIs.</p>
<p>With all these solutions, we can register a service, and other services can discover them. But unlike peer-to-peer solutions, we need to run a separate cluster of these solutions. For an example, let’s look at Etcd.</p>
<p>For a production Etcd deployment, we need to run a cluster of 5-9 Etcd nodes. We also need to make sure that a quorum (n/2 + 1) of instances is available every time. Otherwise, Etcd can't function well.</p>
<p>But with these solutions, we can be sure about the consistency. This means that, if you register a service, it will be available to others.</p>
<h3 id="cluster-and-mongodb">Cluster and MongoDB</h3>
<p><a target="_blank" href="https://github.com/meteorhacks/cluster">Cluster</a> is a different solution, and it'll manage DDP connections beyond service discovery. Yes, it’s also a Meteor-specific solution. We could've used a solution like Etcd for the back-end data source, but if we look at it closely, it's very similar to running a MongoDB ReplicaSet.</p>
<p>Since we have experience with MongoDB already, deploying a new ReplicaSet is not a big issue. Even services like <a target="_blank" href="https://www.compose.io/">Compose.io</a> can make it super simple and cheap. That's why we decided to go with MongoDB. But in the future, if we need to, we can easily implement connectors for Etcd and Consul.</p>
<p>Now we have a quick question for you.</p>
<p>What's the main difference between Cluster (with MongoDB) and Etcd.</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      We can use Etcd with Meteor, and it'll discover services for us.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Etcd has an eventual consistency property, and Cluster is fully consistent.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Cluster discovers and manages DDP connections for us. It's fully consistent, too.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Etcd is a peer-to-peer solution, and Cluster depends on MongoDB.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Cluster discovers and manages DDP connections for us. It's fully consistent, too.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="future-is-here">Future Is Here</h2>
<p>Microservices with DDP are the future of Meteor. We'll be able to write different services and we communicate with each other using DDP. We don't need to write all these services in JavaScript. We’ll be able to write them in any language we like, although we can't do it yet.</p>
<p>Discovery solutions like Cluster will help them to discover each other and make things smoother. We will be able connect to services like MailChimp, SendGrid, and MixPanel just using DDP.</p>
<p>Even though this is something fancy, it could be happened. We also think that this is the vision of the <a target="_blank" href="https://www.meteor.com/people">Meteor Development Group (MDG)</a>.</p>
<p>In the next lesson, we are going dive into microservices, and at the end, you'll be able to manage a production-quality cluster of microservices.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lesson, we learned about microservices and how to use them with Meteor.</p>
<p>But that's the basics. Now we will show you how you can use them in a real app. To summarize, here are the things we are going to cover.</p>
<ul>
<li>Connecting to a service from the client</li>
<li>Using subscriptions and collections with a service</li>
<li>Authenticating a service</li>
<li>Production deployments</li>
</ul>
<p>Let's get started!</p>

  </div>

</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>In this lesson, we are going to use the output from the previous lesson. We've added a few helping functionalities for this lesson. </p>
<p>Let’s clone the following repository:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-microservices-beyond-basics.git</span>
</code></pre><p>Inside the cloned repo, it has three meteor apps. They are <code>main</code>, <code>search</code>, and <code>logging</code>. Before you start them, you need to run your local mongodb instance. We assume that it's running on the default port, which is port 27017.</p>
<p>After that, simply start the apps in whatever ports you like. Yes, our <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> solution will take care of the communication between them.</p>
<p>Now, you can access the main app from the browser and search for Meteor packages.  :)</p>
<blockquote>
<p>This is a subset of Meteor packages as of January 2015, so it won't have all the packages.</p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="connecting-to-services-from-the-client">Connecting to Services from the Client</h2>
<p>In the current app, even though the search has its own service, we get the search results through our main app. But it'll be great if we could connect to the search service directly from the client and get the data. </p>
<p>Fortunately, Meteor allow us to connect to another DDP server from the client very easily. Here's the API for that. (It's very similar to the API available on the server.)</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> conn = DDP.connect(<span class="hljs-string">"http://another-server.com"</span>);
</code></pre><p>This connection is a DDP connection, and you can invoke all the familiar methods, such as <code>.call</code> and <code>subscribe</code>. If you want to learn more, see the official documentation on <a target="_blank" href="http://docs.meteor.com/#/full/ddp_connect">DDP.connect</a>.</p>
<p><strong>If that’s the case, do we need to keep track of the URLs of individual services?</strong></p>
<p>Yes. That's where our <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> package comes in. Just like you discover a connection on the server, you can do the same for the client as well. </p>
<p>However, by default, the cluster does not allow direct connections to services from the client. But you can explicitly allow them as shown below:</p>
<p>Go to the <strong>main</strong> app and apply the following code right after <code>Cluster.connect()</code> in the <code>server/app.js</code> file.</p>
<pre><code class="hljs javascript">Cluster.allowPublicAccess(<span class="hljs-string">'search'</span>);
</code></pre><p>Now you can create a connection to the search app directly from the client. To try it out, open the main app's browser console and type:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> conn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
</code></pre><p>Then you can check the connection status by invoking:</p>
<pre><code class="hljs">conn.status();
</code></pre><p>It should have a status indicating "connected." Now you can invoke methods and subscriptions against this connection. </p>
<p>Before we proceed, we've got a little task for you.</p>
<p>There is a method in the search app called <code>getTheMagicNumber</code>. Try to invoke it against the above connection to find the answer. Here's the code you need to apply:</p>
<pre><code class="hljs javascript">conn.call(<span class="hljs-string">'getTheMagicNumber'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, answer)</span> </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">arguments</span>);
});
</code></pre><p>What's the magic number?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      4769
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      3980
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      2760
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      1274
    </label>
  </div>
  

  
    <p>
      Correct answer is : 2760
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="using-client-side-connection">Using Client-Side Connection</h2>
<p>Now we know how to create a connection to a service. Let's learn how to use that connection to get data and invoke methods. (We've already done the method invocation part in the previous step.)</p>
<h3 id="subscribing-to-publications">Subscribing to Publications</h3>
<p>To demonstrate that, we are going to implement a new functionality for our search box. See the following image:</p>
<p><img src="img/CjCRqtMX0j.png" alt="Top Searches"></p>
<p>In this image, we can see the top searches just below the search box. We've already added UI components for this feature in the main app. (Check for the <code>topSearches</code> template.) Now, we need to get the data and create the template helper.</p>
<p>To do that, we first need to subscribe to the <code>topSearches</code> publication in the <code>search</code> service. After it is subscribed to, it sends a few documents to a collection called <code>top-searches</code>. This is one such document.</p>
<pre><code class="hljs css"><span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> <span class="hljs-string">"&lt;position based on popularity&gt;"</span>,
  text: <span class="hljs-string">"search term"</span>
</span></span></span>}
</code></pre><p>First, we need to make the connection and create the subscription. To do that, add the following code to <code>client/app.js</code> in the main app.</p>
<pre><code class="hljs javascript">SearchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
SearchConn.subscribe(<span class="hljs-string">'topSearches'</span>);
</code></pre><p>Now we need to create a collection to store the data we received. This is how you can do it. Add it to the file mentioned above.</p>
<pre><code class="hljs javascript">TopSearches = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">'top-searches'</span>, {connection: SearchConn});
</code></pre><p>Here, we created a collection named <code>top-searches</code>. Additionally, we provided the connection object as the second parameter for the <code>Mongo.Collection</code> constructor. Because we did that, this collection will get data from the <code>SearchConn</code> connection. Otherwise, it would default to the connection at <code>Meteor.connection</code>.</p>
<p>The next step is to create the template helper to get the data. To do that, simply paste the following into <code>client/topSearches.js</code> in the main app.</p>
<pre><code class="hljs javascript">Template.topSearches.helpers({
  <span class="hljs-string">"topSearches"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> TopSearches.find();
  }
});
</code></pre><p>Now, everything is ready. You can see the "top searches" as shown in the following image:</p>
<p><img src="img/CjCRqtMX0j.png" alt="Top Searches"></p>
<h3 id="invoking-methods">Invoking Methods</h3>
<p>Currently, our search functionality is still happening through the main app. We don't need to do it that way. We can use our client-side search connection for that. Currently, we are getting data from the search source definition created on the server side of the <strong>main</strong> app.</p>
<p>It's located at <code>server/app.js</code> in the main app. Here's the code:</p>
<pre><code class="hljs javascript">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});
</code></pre><p>Let's remove that. After that, you won't be able to search packages. You should get a console error.</p>
<p>We need to fix that. Apply the following code in the <code>client/search.js</code> file of the main app.</p>
<pre><code class="hljs javascript">PackageSearch.fetchData = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options, success)</span> </span>{
  SearchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
    success(err, data);
  });
};
</code></pre><p>Now we are using Search Source's client-side data definition API. Inside that, we simply call our search connection created on the client and forward the results to the search source.</p>
<p>With this, now you'll be able to search again. To search, now you simply send messages to the search service directly from the client. This is all we wanted.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="authentication-for-services">Authentication for Services</h2>
<p>If the service is only used within the cluster, you don't need to worry much about authentication because your services are not exposed to the public. But when you expose them to the public, you need to worry about it.</p>
<p>Our search service is exposed to the public, so we need to work on some sort of authentication. Right now, there is no built-in feature for this, but we can use Meteor's existing authentication system with a few modifications.</p>
<h3 id="meteor-s-current-authentication-system">Meteor's Current Authentication System</h3>
<p>Meteor basically authenticates its DDP connection at <code>Meteor.connection</code>, so when you are logging into the app, it will check the user credentials and authenticate the connected DDP connection. Just after a valid authentication request, it will add a localStorage entry with the key called <code>Meteor.loginToken</code>.</p>
<p>When you visit the app again sometime later, Meteor uses that local storage entry to authenticate the default DDP connection. With that, you don't have to enter the username and password again.</p>
<h3 id="authenticate-our-search-connection">Authenticate Our Search Connection</h3>
<p>We are trying to use the same loginToken used by the <strong>main</strong> app to authenticate the connection that we made to the <code>search</code> service. If you completed the previous section of this lesson, you can follow with the app you are already working on. Otherwise, check out the following branch.</p>
<pre><code class="hljs nginx"><span class="hljs-title">git</span> checkout client-search
</code></pre><p>This is what we are trying to do:</p>
<ul>
<li>Send the existing login token to the search service.</li>
<li>The search service has a connection to the Web service (to our main app), which does the authentication.</li>
<li>Once the search service receives the loginToken, it will get the <code>userId</code> related to the loginToken from the Web service (using the connection created above).</li>
<li>Then, the search service can indicate that the current DDP connection is authorized for that user ID.</li>
</ul>
<p>Let's implement that.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h3 id="create-a-user-account">Create a User Account</h3>
<p>Before we begin, create a user account in the main app. To do that, open the browser terminal and apply the following:<br>(You can change the user credential as you wish.)</p>
<pre><code class="hljs css"><span class="hljs-tag">Accounts</span><span class="hljs-class">.createUser</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">username</span>:<span class="hljs-value"> <span class="hljs-string">"user"</span>, password: <span class="hljs-string">"password"</span></span></span></span>});
</code></pre><p>You can check the login state by entering the following command:</p>
<pre><code class="hljs">Meteor.user()
</code></pre><h3 id="restrict-access">Restrict Access</h3>
<p>Then let's make our search available only for logged-in users. To do that, open <code>server/app.js</code> of the <strong>search</strong> app and apply the following logic.</p>
<pre><code class="hljs javascript">Meteor.methods({
  <span class="hljs-string">"getPackages"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();

    <span class="hljs-comment">// If that user is not logged in, he'll get an error</span>
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.userId) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">401</span>, <span class="hljs-string">"Unauthorized"</span>);
    }

    <span class="hljs-comment">// rest of the logic</span>
  }
})
</code></pre><p>Then, if you search locally, you won't be able to see anything.</p>
<h3 id="get-the-userid-for-a-given-logintoken">Get the UserId for a Given LoginToken</h3>
<p>Now, we need to add a special method to the main app that gives the <code>userId</code> if we call that method with the <code>loginToken</code>. Here's the method:</p>
<p>(You’ll need to add this method to the <strong>main</strong> app.)</p>
<pre><code class="lang-js hljs javascript">Meteor.methods({
  <span class="hljs-string">"getUserByToken"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(loginToken)</span> </span>{
    <span class="hljs-keyword">var</span> hashedToken = loginToken &amp;&amp; Accounts._hashLoginToken(loginToken);
    <span class="hljs-keyword">var</span> selector = {<span class="hljs-string">'services.resume.loginTokens.hashedToken'</span>: hashedToken};
    <span class="hljs-keyword">var</span> options = {fields: {_id: <span class="hljs-number">1</span>}};

    <span class="hljs-keyword">var</span> user = Meteor.users.findOne(selector, options);
    <span class="hljs-keyword">return</span> (user)? user._id : <span class="hljs-literal">null</span>;
  }
});
</code></pre>
<h3 id="accept-the-logintoken-and-authenticate">Accept the LoginToken and Authenticate</h3>
<p>Then, we need to create a method in the <strong>search</strong> service that accepts a loginToken and invoke the above method. Here it is:<br>(Add this method to <code>server/app.js</code> in your <strong>search</strong> app.)</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> webConn = Cluster.discoverConnection(<span class="hljs-string">'web'</span>);
Meteor.methods({
  <span class="hljs-string">"authenticate"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(loginToken)</span> </span>{
    <span class="hljs-keyword">var</span> userId = webConn.call(<span class="hljs-string">'getUserByToken'</span>, loginToken);
    <span class="hljs-keyword">this</span>.setUserId(userId);
    <span class="hljs-keyword">return</span> userId;
  }
});
</code></pre>
<p>After it gets the userId from the Web service, it will invoke a special method in the Meteor method context called <code>setUserId()</code> with the userId. This will mark the current DDP connection as authenticated for the given userId.</p>
<h3 id="pick-the-logintoken-from-the-local-storage">Pick the LoginToken from the Local Storage</h3>
<p>Let's do the final part, sending the loginToken after a user visit to the page. To do that, we can use the <code>onReconnect</code> hook in the DDP connection. This hook will be called when the DDP connection is connected or reconnected, so it's a good place to send the login token.</p>
<p>To do that, add the following code to <code>client/app.js</code> in the <strong>main</strong> app:</p>
<pre><code class="hljs javascript">SearchConn.onReconnect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> loginToken = Meteor._localStorage.getItem(<span class="hljs-string">'Meteor.loginToken'</span>);
  <span class="hljs-keyword">this</span>.call(<span class="hljs-string">'authenticate'</span>, loginToken);
};
</code></pre><p>This will get the token from local storage and call the <code>authenticate</code> Meteor method. That's all we have to do.</p>
<p>Then you'll be able to search packages again. Go check it out.</p>
<hr>
<p>Now you have to do a quick task.</p>
<p>Log out of the app by invoking <code>Meteor.logout()</code> from the browser console. After that, can you still search?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-ok text-success"></span>
      
      Yes
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      No
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Yes, you can still search. This is bad because, after you've logged out, the search function should not be functional. Here's the reason and the fix for this.</p>
<p>Even though you've logged out of the main app, you did  not log out of the search service. We can easily fix this by applying the following code to <code>/client/app.js</code> in the <strong>main</strong> app.</p>
<pre><code class="hljs javascript">Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  Meteor.userId();
  SearchConn.onReconnect();
});
</code></pre><p>Here, we watch for changes in <code>Meteor.userId()</code> and invoke the <code>onReconnect</code> function of the search connection. Which does triggers the authentication logic again.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="production-deployments">Production Deployments</h2>
<p>Now we've played with cluster and microservices a lot. We’ve covered almost everything. But it's a good idea to watch for cluster <a target="_blank" href="https://github.com/meteorhacks/cluster">documentation</a> as well.</p>
<p>It's time to look at production deployments. You don't need to do a lot, but you have to follow some basic steps.</p>
<h3 id="use-a-mongodb-replicaset">Use a MongoDB ReplicaSet</h3>
<p>We are using MongoDB for the service discovery. You specified a Mongo URL when invoking <code>Cluster.connect</code>. Since it's the heart of the cluster, you should use a MongoDB ReplicaSet. It's does <strong>not</strong> need to have support for oplog.</p>
<p>If you don't have the expertise to run a MongoDB ReplicaSet, try to use <a target="_blank" href="https://www.compose.io/">Compose.io</a>.</p>
<h3 id="use-environment-variables">Use Environment Variables</h3>
<p>In this lesson and the previous lesson, we've invoked cluster APIs inside the Meteor app. In a production deployment, that's a task for a system admin. Invoking Cluster APIs is not a task for the developer, and it should not be hardcoded into the app.</p>
<p>Cluster has a functionality called AutoConfig that allows you to invoke its API via environment variables. Let's see how to use AutoConfig:</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.connect(&lt;mongoUrl&gt;);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_DISCOVERY_URL=&lt;mongoUrl&gt;
</code></pre><pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.<span class="hljs-keyword">register</span>(<span class="hljs-string">"web"</span>);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_SERVICE=web
</code></pre><pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.allowPublicAccess([<span class="hljs-string">"search"</span>, <span class="hljs-string">"logging"</span>]);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_PUBLIC_SERVICES=<span class="hljs-string">"search, logging"</span>
</code></pre><h3 id="expose-endpoint-url">Expose Endpoint URL</h3>
<p>In this lesson, we have used only one instance of a given service. But in a production deployment, we may need to use more instances of a single service for high availability or for scaling purposes. If so, every service instance you start needs to have an environment variable called <code>CLUSTER_ENDPOINT_URL</code>.</p>
<pre><code class="hljs java"># <span class="hljs-function"><span class="hljs-keyword">this</span> is the direct URL to your <span class="hljs-title">server</span> <span class="hljs-params">(it could be a <span class="hljs-keyword">private</span> URL)</span>
export CLUSTER_ENDPOINT_URL</span>=http:<span class="hljs-comment">//ipaddress</span>
</code></pre><h3 id="using-multiple-balancers">Using Multiple Balancers</h3>
<p>Currently in this app, we've used only one instance for the <code>Web</code> service where users are going to access your app. It's also the entry point for your cluster, so having a single entry point is not a good idea since it will cause scalability and high availability issues.</p>
<p>Therefore, we need to run more Web service instances. Even though you are running multiple Web instances, all the connections still go through the instance linked to your domain (via DNS).</p>
<p>Cluster solves this issue with a special type of nodes called "balancers." Balancers can accept DDP connections and route them to a given service. They are exposed to the public. A balancer doesn't need to be a Web service, but using a Web service for that is a good choice.</p>
<p>Creating a balancer is easy. Simply use the following environment variable.</p>
<pre><code class="hljs cpp"><span class="hljs-keyword">export</span> CLUSTER_BALANCER_URL=http:<span class="hljs-comment">//domain-name.com</span>
</code></pre><p>This URL is public, and it should point to the correct balancer instance.</p>
<p>Since the balancer is the entry point for all your services, they should be configured with <code>CLUSTER_PUBLIC_SERVICES</code> as well.</p>
<hr>
<p>These are the things you need to focus on when you are doing a production cluster of microservices. In the next lesson, we'll show you how to setup a highly available Meteor deployment in detail, and then you can learn more about deployments.</p>
<p>Before we end this lesson, we'd like to ask you a question.</p>
<p>From the list below, select the <strong>incorrect</strong> statement.</p>
<hr>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It's a good idea to use a Mongo ReplicaSet for cluster discovery.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      If you are running multiple service instances, use `CLUSTER_ENDPOINT_URL`.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It's also a good idea to run the cluster with just one balancer.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Using AutoConfig APIs is a good choice over the JS APIs.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It's also a good idea to run the cluster with just one balancer.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Running a Meteor app is a pretty simple job. You can use <code>meteor deploy</code>, Meteor Up or Modulus.io to deploy your app. </p>
<p>But running an app with high availability is a different story. We should not confuse high availability with scaling or deployment. With high availability, we are trying to keep our service available to customers all the time. Making your app highly available is your job (or your team's job). You can't delegate that task to someone else; why would you want to? Let's discuss this. </p>
<p>There are many common reasons for applications to fail. Here are some examples:</p>
<ul>
<li>Issues with the deployment provider, </li>
<li>Issues with databases,</li>
<li>Issues with the app itself,</li>
<li>DNS failures, and </li>
<li>Attacks on your system.</li>
</ul>
<p>These issues can arise at any time. So, your job is to mitigate them in order  to make your app highly available. Otherwise you lose customers, and it's hard to get them back. That's why you can't delegate this task to someone else. </p>
<p>In this lesson, we will show you how to build a highly available Meteor cluster. Here are  some of the topics we will discuss:</p>
<ul>
<li>Highly available database setup,</li>
<li>Making your Meteor app highly available,</li>
<li>Configuring DNS,</li>
<li>Monitoring app performance, and</li>
<li>Things to do If something goes down.</li>
</ul>
<p>Let’s get started.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="overview">Overview</h2>
<p>In this lesson we are going to deploy a Meteor cluster with two services. It's a Meteor app that can be used to search packages. Each service is a Meteor app. Here are the two services:</p>
<ul>
<li>web - handles all the user interactions,</li>
<li>search - searches Meteor packages.</li>
</ul>
<p>You can clone the following repository to get the above two services.</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-high-availability.git</span>
</code></pre><p>This is the same application we used for the microservices lessons. To run this app, first start your local MongoDB instance. It's used for the service discovery.</p>
<p>Next, start two meteor services in whatever ports you like. Then you'll be able to search packages from the URL of the web service. To start the app, you need to use a special shell script we've provided. </p>
<p>To do that, navigate to the app from your terminal and apply the following command:</p>
<pre><code class="hljs xml">PORT=<span class="hljs-tag">&lt;<span class="hljs-title">port</span> <span class="hljs-attribute">number</span>&gt;</span> sh .devrun.sh
</code></pre><p>Unlike in other lessons, this time we'll be using a few cloud services for different solutions. There are many cloud services that can be used for any single solution, so it's totally okay if you decide to go with something different than the services we use for this lesson.</p>
<p>For example, we are using Digital Ocean for servers in this lesson. But, you might prefer to use AWS or Google Cloud instead.</p>
<p>You may need to purchase paid plans for some of these services. The experience you get is more valuable than the money you may spend on the services.</p>
<p>You will also need a domain name. I recommend that you purchase a new domain name. We are using <a target="_blank" href="https://www.godaddy.com/">GoDaddy</a> for that. We'll introduce you to other services as we proceed.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="highly-available-mongodb-setup">Highly Available MongoDB Setup</h2>
<p>MongoDB is the core part of our cluster. Since we are running two services, each of them requires a MongoDB database. Depending on your requirements, you could use different databases for each of them. But for our search and web apps, it's okay to use the same database.</p>
<p>We are using <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> to manage and scale our cluster. So, we need a database for that as well. For that, we highly recommend that you use a different database, since this is the core of our cluster.</p>
<h3 id="deploy-the-database">Deploy the database</h3>
<p>For high availability, we need to deploy a MongoDB ReplicaSet. You can deploy it yourself if you have the expertise. But we are not going to cover it in BulletProof Meteor since it's a whole different subject.</p>
<p>If you don't want to deploy MongoDB yourself, there are two main options available to you:</p>
<ol>
<li>Use a cloud service like <a target="_blank" href="https://www.compose.io/">Compose.io</a></li>
<li>Use <a target="_blank" href="https://mms.mongodb.com/">MMS Deployment</a> to deploy a replica set into infrastructure you like.</li>
</ol>
<p>For this lesson, we prefer to use Compose.io to create the replica set. It's very easy to deploy a ReplicaSet this way; you won't need any help at all.</p>
<p>However, we'll still demonstrate how to do it. Check out the following screencast.</p>
<iframe src="https://www.youtube.com/embed/vx6iAFHIUXY" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="making-your-meteor-app-highly-available">Making your Meteor App Highly Available</h2>
<p>Now we are trying to deploy our app. So, the first task is to select a hosting provider. We prefer to go with <a target="_blank" href="https://www.digitalocean.com/">Digital Ocean</a>. But, you can follow this lesson even if you select a provider which has Ubuntu Linux servers.</p>
<h2 id="data-center-selection">Data Center Selection</h2>
<p>For high availability, we need to run our services in multiple data centers. But, if we choose to run it in different data centers, we also need to worry about latency issues between the data centers. </p>
<p>So, we need to select two data centers which are close to each other. For this lesson, we are using instances from NY2 and NY3 data centers of Digital Ocean. If you are using AWS EC2, the servers are located in availability zones. So, choose servers from different availability zones of the same data center.</p>
<blockquote>
<p>It is also very important to use the same datacenter for your MongoDB ReplicaSet as well. Otherwise you will face latency issues. </p>
</blockquote>
<p>This is how we distribute servers between our two services.</p>
<p><strong>web</strong></p>
<ul>
<li>two servers from Ny2</li>
<li>one server from Ny3</li>
</ul>
<p><strong>search</strong></p>
<ul>
<li>one server from Ny2</li>
<li>one server from Ny3</li>
</ul>
<h2 id="server-selection">Server Selection</h2>
<p>It's also very important to select the best possible servers for your app. Meteor, by default, can use only one CPU core. So, it will be wise for you to select servers with only one CPU core.</p>
<p>For Meteor, RAM won't be an issue. It's always the CPU. But try to select an instance with RAM below 2 GB, because NodeJS, where Meteor is based, has issues with RAM over 2 GB.</p>
<h2 id="scaling-and-clustering">Scaling and Clustering</h2>
<p>We use <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> for scaling and managing our cluster. If you've followed the microservices lessons, you might be familiar with the cluster already. It's a way to manage your Meteor cluster and load balance it.</p>
<p>Cluster is a Meteor package and has a discovery backend. Currently, it uses MongoDB as the discovery backend. For that you need to use a separate MongoDB replica set. But it doesn't need to have oplog support and does not need to be in the same data center as the server it's being configured with.</p>
<p>In a cluster, there are special type of nodes called balancers. A balancer accepts requests from the public and delivers them to the correct service instance(Meteor app). So, the balancer acts as the entry point for your cluster. I recommend that you read the <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster documentation</a> for more infomation.</p>
<p>For this setup we are going to use two balancers. We don't need separate servers for that. We can use our existing Meteor services as balancers. This is how you select servers for the balancers:</p>
<ul>
<li>One web service instance from Ny2</li>
<li>One web service instance from Ny3</li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>We use <a target="_blank" href="https://github.com/arunoda/meteor-up">Meteor Up</a> to deploy the app. To do that, first we need to install Meteor Up into our development machine:</p>
<pre><code class="hljs sql">npm <span class="hljs-operator"><span class="hljs-keyword">install</span> -g mup
</span></code></pre><p>Next, create a directory in your machine to store configurations. Inside the directory, create two more directories to store configuration for both web and search services. </p>
<p>Visit each directory and invoke <code>mup init</code> and create the configuration script. Then <a target="_blank" href="https://github.com/arunoda/meteor-up">edit</a> those configuration as described in the section. (The set of video tutorials below demonstrate how to do this.)</p>
<p>The next step is to invoke <code>mup setup</code> to setup servers for each service. Then you can use <code>mup deploy</code> to deploy services.</p>
<p>We've created a set of videos to demonstrate this whole process. Here they are:</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=_Cwqi7KkH3o&amp;feature=youtu.be">Generating SSH keys and registering them with Digital Ocean</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=vNMbEVfTyCM&amp;feature=youtu.be">Creating servers</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=3W5vkXHitnY&amp;feature=youtu.be">Creating Meteor Up configuration files</a></li>
<li><a target="_blank" href="https://gist.github.com/arunoda/955e787534fca64d16a1">Sample configuration files</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=Az_Af6KAmoo&amp;feature=youtu.be">Deploying the cluster with Meteor Up</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="dns-configurations">DNS Configurations</h2>
<p>Now we have a running Meteor cluster and everything works pretty well. But, it's not ready for the public yet. That's because we haven't configured the DNS settings yet.</p>
<p>For this app, we are going to use a domain name called "isopacks.com." We also recommend that you purchase a domain name for the purpose of testing.</p>
<blockquote>
<p>You can use <a target="_blank" href="http://www.fatwallet.com/GoDaddy-coupons">FatWallet</a> to get a coupon for Godaddy. With that, you can purchase a domain for less than three dollars.</p>
</blockquote>
<h3 id="cloudflare">Cloudflare</h3>
<p>We are going to use Cloudflare as our DNS provider for this app. We also use Cloudflare as a CDN and to process SSL. Since we are using Cloudflare for SSL, we need to turn off WebSockets support. (Cloudflare currently supports WebSockets for its enterprise plans only.)</p>
<p>To turn off WebSockets support, you need to expose the following environment variable for both our services. You can add this to the mup.json of both services.</p>
<pre><code class="hljs javascript">{
  <span class="hljs-string">"env"</span>: {
    ... other env vars
    <span class="hljs-string">"DISABLE_WEBSOCKETS"</span>: <span class="hljs-string">"1"</span>
  }
}
</code></pre><h3 id="set-up-nameservers">Set Up Nameservers</h3>
<p>By default, Godaddy is hosting DNS for the domain. Now we need to transfer DNS handling to cloudflare. To do that, go to Cloudflare and add the domain. There will be a wizard to help you, and at end of the wizard it'll show you some nameservers, as shown below:</p>
<p><img src="img/F3m5Czs2Tq.png" alt="Cloudflare Nameservers"></p>
<p>Then you need to visit the GoDaddy domain console and add the above nameservers for your domain.</p>
<p><img src="img/Nez0hWYowr.png" alt="Godaddy Nameservers configuration"></p>
<p>It will take up to 24 hours to complete the setup. But, if you've moved your domain into Cloudflare's Pro plan, it'll be configured in minutes.</p>
<blockquote>
<p>In order to SSL to work properly, you need to change the Cloudflare SSL setting to flexible SSL. <a target="_blank" href="https://www.youtube.com/watch?v=zQMhYuoc6BQ&amp;feature=youtu.be">This is</a> how you can do it.</p>
</blockquote>
<h3 id="dns-setup">DNS Setup</h3>
<p>We need to make sure that our DNS setup is highly available too. That's why we chose Cloudflare. With Cloudflare, we can change our DNS in real time. So, if something goes wrong, we can fix it quickly. Let's setup our DNS.</p>
<p><strong>For Main Domain</strong></p>
<p>We can simply use an <a target="_blank" href="http://support.dnsimple.com/articles/a-record/">"A Record"</a> to point our domain name into an IP Address. Let's do that. In this case, we are using two such IP addresses for high availability. We can use the IP addresses of balancers for that.</p>
<p>If you are using multiple balancers, pick two balancers from different data centers. Since we are only using two balancers for this lesson, we can use both of them. </p>
<p>This is how you can add the A records:</p>
<iframe src="https://www.youtube.com/embed/kdmRx3uvCwI" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<p>Now, "isopacks.com" is our app's ROOT_URL. So, go to the "mup.json" of the web service and expose the <code>ROOT_URL</code> environment variable. You may also need to do <code>mup reconfig</code> to apply it the running app.</p>
<blockquote>
<p>Servers behind the IP address are only responsible for delivering static content and normal HTTP Requests. All the DDP traffic will go through balancers. As traffic to your app increases, you can simply add more balancers to meet the demand.</p>
<p>Cloudflare caches static resources, so your servers won't have issues serving static content.</p>
</blockquote>
<p><strong>Balancers</strong></p>
<p>Now we've set up our DNS for the main app. It's time to configure the DNS for our balancers. To do that, you can simply add two subdomains and point your balancer IP addresses as shown below:</p>
<ul>
<li>one.isopacks.com -&gt; balancer Ip-1</li>
<li>two.isopacks.com -&gt; balancer Ip-2</li>
</ul>
<p>Let's see how to do that:</p>
<iframe src="https://www.youtube.com/embed/7RuCpiVlSoE" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<hr>
<p>Now, our DNS setup is complete and we've just deployed and configured a highly available Meteor cluster. Give yourself a pat on the back! :)</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up-monitoring">Setting Up Monitoring</h2>
<p>Even though we've successfully deployed the cluster, we still have some other tasks to do. One such important task is monitoring. </p>
<p>Especially in the cloud environment, anything could go down at any time. Therefore we need to stay alert. Let us show you some ways to do that.</p>
<h3 id="app-monitoring">App Monitoring</h3>
<ul>
<li>Add <a target="_blank" href="https://kadira.io">Kadira</a> to both of your services and use <a target="_blank" href="https://kadira.io/blog/stay-alert-with-your-meteor-app/">Kadira Alerts</a> to check whether your app is running or not.</li>
<li>You can also use <a target="_blank" href="https://www.pingdom.com/">PingDom</a>-like services to see whether your app is accessible to users or not.</li>
</ul>
<h3 id="server-monitoring">Server Monitoring</h3>
<ul>
<li>Sometimes, there might be issues with your hosting service provider. For this reason, it's a good idea to subscribe to their status pages if such pages are available. </li>
<li>This is the status page of Digital Ocean - <a target="_blank" href="https://status.digitalocean.com/">https://status.digitalocean.com/</a>.</li>
<li>These providers are also very active on Twitter. So try follow their Twitter accounts as well.</li>
</ul>
<h3 id="cloudflare-monitoring">Cloudflare Monitoring</h3>
<ul>
<li>Sometimes Cloudflare also goes down and slows down your app. So, you need to watch  Cloudfare’s status pages as well.</li>
</ul>
<h3 id="database-monitoring">Database Monitoring</h3>
<ul>
<li>You can use Kadira to see if there is an issue with the database or not.</li>
<li>Sometimes a database may go down completely or queries might get slower.</li>
<li>It's a good idea to subscribe to the database provider's status page as well.</li>
</ul>
<blockquote>
<p><strong>Make sure not to skip this part when you are doing your actual deployment. Otherwise, you'll be in trouble if something goes wrong.</strong></p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="things-to-do-if-your-app-goes-down">Things to Do If Your App Goes Down</h2>
<p>Even though we've tried to deploy everything in a highly available manner, things will break. That's life. You'll learn about this from the previously discussed monitoring channels or from your users.</p>
<p>Let's see what we can do when things go down.</p>
<h3 id="notify-your-users">Notify Your Users</h3>
<p>The first thing you should do is to notify your users. You can do this in a couple of ways:</p>
<ol>
<li>Use your app's official Twitter account.</li>
<li>Use your status page, if you have one.</li>
<li>Email your customers directly.</li>
<li>Use Cloudflare's <a target="_blank" href="https://support.cloudflare.com/hc/en-us/articles/200172706-How-do-I-customize-CloudFlare-error-pages-">custom error pages</a>. In those error pages, if possible, try to get your users’ email addresses. Then, you can still do business with them.</li>
</ol>
<h3 id="if-a-server-goes-down">If a Server Goes Down</h3>
<p>If one of your servers goes down, the cluster will take care of that by routing users to a new server. In the meantime, you need to create a new server and add it to the cluster.</p>
<h3 id="if-a-balancer-goes-down">If a Balancer Goes Down</h3>
<p>If one of your balancers goes down, the cluster will take of that also. But you will need to add a new balancer immediately since, it'd be possible to handle all the traffic with other balancers. </p>
<h3 id="if-a-server-behind-an-a-record-goes-down">If a Server Behind an "A Record" Goes Down</h3>
<p>If a server behind a main domain's A records goes down, you need to react quickly. You can either remove that record or update it with another IP address. Cloudflare does not have a way to do health checks and reconfigure its DNS. So, your app will get routed to a non- functioning server in this situation.</p>
<p>AWS <a target="_blank" href="http://aws.amazon.com/route53/">Route 53</a> has a feature that will do health checks and route DNS traffic accordingly. If you decide to go with that, you need to set up SSL and caching yourself.</p>
<h3 id="if-you-had-a-bug-in-your-app">If You Had a Bug in Your App</h3>
<p>Your app might go down due to a bug in your app. If it does, rollback to a previous version while you fix the issue.</p>
<h3 id="if-your-database-goes-down">If Your Database Goes Down</h3>
<p>If your database goes down, your app won't work properly. If so, try to get a previously known backup from Compose.io and deploy a new database from some other provider.</p>
<p>Then use that DB with your app. It won't have the full state of your DB. Therefore, you might not want to use this approach. If so, using <a target="_blank" href="https://mms.mongodb.com/">MMS</a> to deploy your MongoDB Replica Set is the best approach.</p>
<p>MongoDB MMS also has a continuous backup feature, which allows you to back up every write operation in your DB.</p>
<h3 id="if-cloudflare-goes-down">If Cloudflare Goes Down</h3>
<p>If so, this is very bad. Try to have a backup plan to serve your app without using Cloudflare. Maybe you can transfer the name servers to another DNS provider and manage DNS with them.</p>
<p>You can't do this quickly since it might take some time to propagate DNS changes. But you don't need to worry too much about this. A lot of popular sites, such as Reddit and Meetup, are  served through Cloudflare. So, Cloudflare will do everything possible to bring their service back online.</p>
<p>But, it’s a good idea to have a backup plan.</p>
<h3 id="if-the-mongodb-for-the-cluster-goes-down">If the MongoDB for the Cluster Goes Down</h3>
<p>Then, you don't need worry too much. The cluster caches information about the servers available locally in the server. So, even without the connection to the DB, you app may still work for few hours.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="finally">Finally</h2>
<p>Now we know how to deploy a highly availablle Meteor cluster and what to do if something goes wrong. As we said earlier, you can't delegate this task to some other service or to someone else.</p>
<p>You need to manage it yourself or with your team. Now we think that you have a better understanding of how to do it. Let us know if you have any questions or need more information. (Use the following comments section for that.)</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Load and Stress Testing</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/load-and-stress-testing">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/load-and-stress-testing/1">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Once you've successfully deployed a Meteor app, next you will want to look at how many users it can handle. That's where load testing comes in. Some developers refer also refer to stress testing also as load testing. But it's different.</p>
<p>Stress testing tells us how our app works under a heavy load. But we don’t know in advance how many users it can handle with stress testing. We usually use stress testing for performance tuning.</p>
<p>Luckily, in most cases we can use the same tools for load and stress testing alike. In this lesson, we'll show you how to stress and load test your Meteor app in few different ways:</p>
<ol>
<li>Poor man's load/stress testing using just a browser</li>
<li>Load/stress testing using Meteor Down</li>
</ol>
<p>We'll also show you how to invoke these tests locally on your machine and how to run them for a running app on the cloud. We'll use Heroku to scale our tests in the cloud.</p>
<p>Contents</p>
<ul>
<li>Difference Between Load Testing and Stress Testing</li>
<li>Browser based Stress Testing</li>
<li>Browser based Load Testing</li>
<li>Stress Testing using Meteor Down</li>
<li>Load Testing using Meteor Down and Kadira</li>
<li>Authenticating users with Meteor Down</li>
<li>Scaling Load Tests</li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Load and Stress Testing</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/load-and-stress-testing">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/load-and-stress-testing/1">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="difference-between-load-testing-and-stress-testing">Difference Between Load Testing and Stress Testing</h2>
<p>Sometimes we talk about load testing and stress testing for the same thing and we are quite not sure about the different. Most of the time, we are using the same tool for both Stress and Load testing; that's the main reason for the confusion. It's very important to identify the difference. Otherwise, how we are doing the tests and it's result won't be the actual result we want. Let's have a look at it.</p>
<h3 id="stress-testing">Stress Testing</h3>
<p>As name implies, with stress testing we are trying to stress the application and improve weak points and bottlenecks in our app. With this, we might be testing one part of the app or a new feature we've added recently.</p>
<p>With this test, we are not going to look at how much of users we can handle. But we'll look at some kind of time related measurement like throughput, relative to a resource related metric like CPU or Memory.</p>
<p>Let's look at an example:</p>
<ul>
<li>We've recently created a new feature to display a leaderboard</li>
<li>We are doing a stress test to find our potential issues in that and optimize</li>
<li>For that we'll be sending stress test to that subscription with 10000 subscriptions per minute (SubRate)</li>
<li>Then we'll look for the CPU usage and trying to optimize that</li>
<li>We can take a CPU profile with Kadira and see what's going on under the hood</li>
</ul>
<p>So, in the above example our intention is to improve the performance of the new feature. Not necessoryly to how much of concurrent requests it can handle.</p>
<blockquote>
<p>With stress test, it doesn't matter what hardware you use of how powerful the system is. Our focus is to reduce the resource metric (CPU usage) with a fixed rate of time related metric. (Throughput)</p>
</blockquote>
<h3 id="load-testing">Load Testing</h3>
<p>Load Testing is very similar to stress testing but we try to see how much of load our app can handle. In this, we are trying to use real hardware and mimic actual usage pattern users are following.</p>
<p>Our goal is to find out how much concurrent users we can handle with the current system. Then we'll trying to scale it by adding more server resources.</p>
<p>With load testing, we are not trying to optimize our code. But we try to see how many concurrent requests/session/clients our can handle.</p>
<p>Let's look at an example app:</p>
<ul>
<li>We've an app deployed into an one AWS EC2 server.</li>
<li>In average, a single user subscribes to 10 subscriptions under one minute.</li>
<li>Average time a user use our app is about 10 minutes</li>
</ul>
<p>So, we'll create a test to model this scenario. Let's say, that's our load test case. Then we'll trying to run multiple such cases concurrently until, server resources maxed out.</p>
<p>Then we try to increase server resources and try to see how our app scale. After that, we can see bottlenecks in our app and we can impove that by doing a stress test and optimizing our app. Then we can do a load test again.</p>
<blockquote>
<p>With load test, we are trying to see how many concurrent actual users/session our app can handle with a given set of servers and other resources</p>
</blockquote>
<hr>
<p>Now we know the difference between load testing and stress testing. Let's start practicing.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lessons, we learned how to use <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> to scale and manage a cluster of Meteor apps. Because Cluster is just a Meteor package, it can be used with any hosting provider. But we didn't talk much about how to deploy your Meteor apps, especially in the microservices context.</p>
<p>These days, <a target="_blank" href="https://www.docker.com/">Docker</a> is a very popular way to deploy and manage apps. Basically, Docker is a lightweight virtual machine runtime that lets you run Docker images. A Docker image is a snapshot of a running operating system. So it's possible to wrap your running app into a Docker image and distribute.</p>
<p>Then, those images can be run in any <a target="_blank" href="https://docs.docker.com/installation/">environment</a> that is supported by Docker. Most importantly, it's very easy to build and run these images. That's the key selling point of Docker. </p>
<p>Even though Docker is a new project, a lot of new technologies and tools have emerged around that. One such popular technology is <a target="_blank" href="https://coreos.com/">CoreOS</a>. It's a minimal Linux distribution comes with a set of tools to deploy and manage a cluster of containers, including Docker.</p>
<blockquote>
<p>When we run an image, we call the running image a container.</p>
</blockquote>
<p>In this lesson, you will learn about Docker, and we'll show you how to deploy Meteor apps with Docker at the end. We'll talk about CoreOS and using it to manage a cluster of Meteor instances in the next lesson.</p>
<p>These are the topics we are covering:</p>
<ul>
<li>Installing Docker</li>
<li>Understanding Basic concepts (images, containers, etc.)</li>
<li>Running containers in different ways (named, background services, auto-restart)</li>
<li>Building images (with <code>docker commit</code> and <code>docker build</code>)</li>
<li>Managing Ports</li>
<li>Publishing containers and Docker registries</li>
<li>Exploring ways to run Meteor apps with Docker</li>
</ul>
<p>Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>In this lesson, we are going to use some basic Linux commands. Therefore, we expect that you have some experience in using Linux. Sometimes, we need to edit some content inside a server, so you need to know how to edit a file inside a server using emacs, vim, nano, or some other way.</p>
<h3 id="installation">Installation</h3>
<p>Docker can be installed into your Mac or PC without any issues. But Docker needs a Linux environment to operate. Mac and PC versions are employing a Linux virtual machine (using Virtual Box) behind the scenes. You can follow these instructions to install Docker on your development machine:</p>
<ul>
<li><a target="_blank" href="https://docs.docker.com/installation/mac/">Docker for Mac</a></li>
<li><a target="_blank" href="https://docs.docker.com/installation/windows/">Docker for Windows</a></li>
</ul>
<h3 id="use-a-linux-server">Use a Linux Server</h3>
<p>But for this lesson, we highly recommend that you use a real Linux server. We'll be using an Ubuntu 14.04 64-bit server from Digital Ocean. You can pick a server from your favorite cloud infrastructure provider. </p>
<blockquote>
<p>Docker supports many other <a target="_blank" href="https://docs.docker.com/installation/">operating systems</a>, besides Ubuntu. But we prefer to use Ubuntu.</p>
</blockquote>
<p>Once you have a server, installing Docker is pretty simple. Just apply the following command:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">curl</span> -sSL <span class="hljs-url">https://get.docker.com/ubuntu/</span> | sudo sh
</code></pre>
<p>It'll take care of installing Docker into the Ubuntu server. After the installation, you can verify it by running <code>docker info</code>. Then you'll get something like below:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-constant">Containers</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Images</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Storage</span> <span class="hljs-constant">Driver</span><span class="hljs-symbol">:</span> aufs
 <span class="hljs-constant">Root</span> <span class="hljs-constant">Dir</span><span class="hljs-symbol">:</span> /var/lib/docker/aufs
 <span class="hljs-constant">Backing</span> <span class="hljs-constant">Filesystem</span><span class="hljs-symbol">:</span> extfs
 <span class="hljs-constant">Dirs</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Execution</span> <span class="hljs-constant">Driver</span><span class="hljs-symbol">:</span> native-<span class="hljs-number">0</span>.<span class="hljs-number">2</span>
<span class="hljs-constant">Kernel</span> <span class="hljs-constant">Version</span><span class="hljs-symbol">:</span> <span class="hljs-number">3.13</span>.<span class="hljs-number">0</span>-<span class="hljs-number">43</span>-generic
<span class="hljs-constant">Operating</span> <span class="hljs-constant">System</span><span class="hljs-symbol">:</span> <span class="hljs-constant">Ubuntu</span> <span class="hljs-number">14.04</span>.<span class="hljs-number">1</span> <span class="hljs-constant">LTS</span>
<span class="hljs-constant">CPUs</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>
<span class="hljs-constant">Total</span> <span class="hljs-constant">Memory</span><span class="hljs-symbol">:</span> <span class="hljs-number">490</span> <span class="hljs-constant">MiB</span>
<span class="hljs-constant">Name</span><span class="hljs-symbol">:</span> docker-test
<span class="hljs-constant">ID</span><span class="hljs-symbol">:</span> <span class="hljs-constant">RUVT</span><span class="hljs-symbol">:KK65</span><span class="hljs-symbol">:OVZO</span><span class="hljs-symbol">:VMEH</span><span class="hljs-symbol">:D4QU</span><span class="hljs-symbol">:BG5R</span><span class="hljs-symbol">:</span><span class="hljs-number">5</span><span class="hljs-constant">RIB:</span><span class="hljs-constant">SAG7</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-constant">J4C:</span><span class="hljs-constant">DXGQ</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-constant">WVI:</span><span class="hljs-constant">RYRQ</span>
<span class="hljs-constant">WARNING</span><span class="hljs-symbol">:</span> <span class="hljs-constant">No</span> swap limit support
</code></pre>
<p>Now run this command:</p>
<pre><code class="lang-shell hljs php">docker run ubuntu <span class="hljs-keyword">echo</span> <span class="hljs-string">"docker is nice"</span>
</code></pre>
<p>What did you see on the screen?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It printed "docker is nice" right away.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It asked us to install the Ubuntu image first.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It first downloaded some stuff and then printed "docker is nice".
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It didn't print anything on the server.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It first downloaded some stuff and then printed "docker is nice".
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As you've experienced, it will first download some content and then print "docker is nice" to the terminal.</p>
<p><img src="img/53bwYQbTDY.png" alt="Docker Hello World"></p>
<p>Let's look at what has happened there.</p>
<h2 id="basic-concepts">Basic Concepts</h2>
<p>This is the command we invoked:</p>
<pre><code class="lang-shell hljs php">docker run ubuntu <span class="hljs-keyword">echo</span> <span class="hljs-string">"docker is nice"</span>
</code></pre>
<p>This command asks Docker to run a Ubuntu Docker image and invoke <code>echo "docker is nice"</code> shell command inside that. Initially, it does not have the image. So it'll first download it. Then, it'll start an Ubuntu container from that images and invoke the <code>echo</code> command. </p>
<p>It does a more than that, but this is the high-level picture.</p>
<h3 id="but-why-we-can-simply-invoke-echo-">But why? We can simply invoke "echo ..."</h3>
<p>This is a very good question. Why can't we simply run <code>echo "docker is nice"</code>? Here's the reason. </p>
<p>When we are running a lot of microservices, they need to run in an isolated environment. Otherwise, we may need to face a lot of security and management issues. </p>
<p>There are a lot of tools you can use to implement these kinds of isolation. But Docker is a very nice and simple way to do that. It can easily run any process (or service) in an isolated environment. Furthermore, it won't add any considerable overhead to the host operating system. That means you can run a lot of isolated microservices inside a single host in a very efficient manner.</p>
<p>If you need to know more about why Docker is important, here are some resources for you.</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=Q5POuMHxW-0">Video: Introduction to Docker</a></li>
<li><a target="_blank" href="http://www.slideshare.net/dotCloud/why-docker">Slides: Why Docker</a></li>
</ul>
<hr>
<p>Okay, let's look at some of the core components of Docker:</p>
<h3 id="docker-image">Docker Image</h3>
<p>Docker image is a read-only snapshot of a running operating system. In our example, <code>ubuntu</code> is our Docker image. But it could be anything, such as another operating system like <code>CentOS</code> or one of your microservices. Anyone can build and publish images. </p>
<h3 id="docker-container">Docker Container</h3>
<p>Docker container is a runnable version of an image. Once a container has started, you can make changes to that. Those changes are saved into the disk but in a very efficient way. You can also stop and restart the containers. If you like, you can build a image from the container and publish it to a Docker registry.</p>
<p>So you can think of an image as a snapshot of a container.</p>
<h3 id="docker-registry">Docker Registry</h3>
<p>Docker Registry is a place that holds a set of images. You can pull images from a registry and publish into that. In the example we tried, we pulled the <code>ubuntu</code> image from Docker's main registry. You can also switch into a different registry or host a registry yourself. We'll talk more about this later.</p>
<h3 id="service-process">Service / Process</h3>
<p>This is the service or process that runs inside the container. It could be anything, and the container or Docker runtime doesn't need to know about that.</p>
<h3 id="docker-server">Docker Server</h3>
<p>Docker server is responsible for all of the hard work of managing images, containers, and other relevant tasks. Docker server gets started when we install it on our server.</p>
<h3 id="docker-client">Docker Client</h3>
<p>Docker client is the command line tool(<code>docker</code>) that lets you interact with the Docker server. It communicates using an API exposed by the Docker server. So it's possible to have more <a target="_blank" href="https://docs.docker.com/reference/api/remote_api_client_libraries/">Docker clients</a> rather than the command line tool.</p>
<hr>
<p>Now we've discussed the basics we need to know. Let's try some Docker.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="using-containers">Using Containers</h2>
<p>Run the following Docker commands:</p>
<pre><code class="lang-shell hljs bash">docker run ubuntu <span class="hljs-built_in">echo</span> <span class="hljs-string">"docker is nice."</span>
docker run ubuntu <span class="hljs-built_in">echo</span> <span class="hljs-string">"kadira.io is nice too."</span>
docker run ubuntu hostname
docker run ubuntu uname <span class="hljs-operator">-a</span>
</code></pre>
<p>You can also get into a container with this command:</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -i -t ubuntu bin/bash
</code></pre><blockquote>
<p>In the above command, we've used some options (<code>-i -t</code>). Those options tell Docker to open an interactive terminal for this container. Otherwise, you won't be able to respond to the <a target="_blank" href="http://en.wikipedia.org/wiki/Standard_streams">"stdin"</a> of the container. You can also write these options like <code>-it</code></p>
</blockquote>
<p>Now let's get back to our host server. (You can apply <code>exit</code> to get out from a Docker container.)</p>
<p><strong>Now run <code>docker ps</code></strong></p>
<p>But you won't see any results. That's because we don't have any running containers. This command prints a list of running Docker containers.</p>
<p><strong>Now run <code>docker ps -a</code></strong>. Then you'll get something like this:</p>
<p><img src="img/465c3od_Pf.png" alt="Stopped Containers"></p>
<p>Now we can see all of the containers we've previously run. Note, it lists all our commands with their status and the container ID. You can use this container ID to reference your container.</p>
<p>For example, you can start (again) a container like this:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-prompt">docker start &lt;container ID&gt;</span>
</code></pre>
<p>But it won't show us anything. That's because the container is running in the background. You can get the output of both <code>stdout</code> and <code>stderr</code> with the <code>logs</code> command:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-prompt">docker logs &lt;container ID&gt;</span>
</code></pre>
<h3 id="note">Note</h3>
<p>As you've seen, now every <code>docker run</code> command we invoke creates a new container from the <code>ubuntu</code> image. Any of the actions we apply into the container's filesystem is saved into the disk. But, we haven't done anything like that yet.</p>
<p>Since we've a lot of containers, we may need a bigger disk. Do we?</p>
<p>Actually, we don't need a bigger disk. Docker uses a special file system which only keep changes that happened in the disk. It's very similar to how git works. That's why it can keep a lot of containers without a large disk.</p>
<p>Unfortunately, Docker has no way to clean all of the used containers. But there are some tricks we can use. That's one of the commands from the list below. What is it?</p>
<blockquote>
<p>You can invoke docker -h to see the meaning of these commands and options.</p>
</blockquote>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      docker rm `docker ps --old`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps -ad`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps --used`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps -aq`
    </label>
  </div>
  

  
    <p>
      Correct answer is : docker rm `docker ps -aq`
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="background-services">Background Services</h2>
<p>Running a container with a single command or getting into the container is nice. But we need to run services in the background. This is how you can do that with Docker:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>With the above command, we are starting a Docker container in the background by using the <code>-d</code> option. Additionally, we can also label the container as <code>ping-man</code> by using the <code>--name</code> option. By naming a container, we can easily access it. </p>
<p>For example, this is how we can tail logs of this container.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> logs -f ping-man
</code></pre>
<p>Now invoke <code>docker ps</code>, so you can see the running process:</p>
<p><img src="img/KNtRRFBI3w.png" alt="Running Docker Processes"></p>
<p>Let's do a little experiment. Reboot your server with <code>sudo reboot</code>. Then once it has started, try to look for <code>docker ps</code> again. What are your observations?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-ok text-success"></span>
      
      It doesn't show anything.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see our running container.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see the container, but it's paused.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see the container, but it's locked.
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="auto-restart">Auto Restart</h2>
<p>By default, Docker does not restart its containers when they get killed or when the host server gets rebooted. Docker has the auto-restart support, but it's disabled by default. This is how to enable that:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--restart=always --name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>Oh! You'll get an error like below:</p>
<p><img src="img/9i4PXoSFtf.png" alt="Need to remove existing named containers"></p>
<p>This means that Docker will not allow us to create a container called <code>ping-man</code> again. So before we invoke the above command, we need to remove the current container with the name <code>ping-man</code>.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> rm ping-man
</code></pre><p>So let's try to run our <code>docker run</code> command again:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--restart=always --name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>This time, it works.</p>
<p>Now, try to reload the server again, and check <code>docker ps</code> after it gets reloaded.</p>
<p>Instead of using <code>--restart:always</code> you can call it <code>--restart:on-failure:10</code>. Then, if the process gets killed because of an error, it will get restarted but only 10 times. Even in this mode, our containers get started when the server gets reloaded.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="building-images">Building Images</h2>
<p>We've played a bit with containers. Now it's time to build a Docker image. To try that out, we are going to build a MongoDB image. For that, let's create a container inherited from the <code>ubuntu</code> base image and get into that.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t ubuntu /bin/bash
</code></pre>
<p>Then paste the following commands to the container's shell one by one. It will install MongoDB to the path <code>/mongodb</code>.</p>
<pre><code class="hljs sql">apt-get <span class="hljs-operator"><span class="hljs-keyword">update</span> -y
apt-<span class="hljs-keyword">get</span> <span class="hljs-keyword">install</span> wget -y
<span class="hljs-keyword">VERSION</span>=<span class="hljs-number">2.6</span><span class="hljs-number">.7</span>
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span>.tgz -O mongodb.tar.gz
tar xzf mongodb.tar.gz
mv mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span> /mongodb
rm mongodb.tar.gz
mkdir -p /<span class="hljs-keyword">data</span>/db
</span></code></pre><p>Now, exit this container. Then you can create an image from this container like the one below:</p>
<pre><code class="hljs sql"> docker <span class="hljs-operator"><span class="hljs-keyword">commit</span> <span class="hljs-string">`docker ps -lq`</span> arunoda/mongo-base
</span></code></pre><p>With that, we've create an image called <code>arunoda/mongo-base</code>. You can replace <code>arunoda</code> with your name :). </p>
<p><code>docker ps -lq</code> will gives us the last used container id.</p>
<p>Now we can run a container using the image we've just built:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base /mongodb/bin/mongod
</code></pre>
<h3 id="let-s-add-a-start-script">Let's add a start script</h3>
<p>Now let's add a start script to this image. With that, we don't need to specify the MongoDB binary when starting the container. </p>
<p>First, let's get into the <code>arunoda/mongo-base</code> like this.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base /bin/bash
</code></pre>
<p>Then apply the following commands. (It'll create a filename called <code>start.sh</code> in the root of the file system.)</p>
<pre><code class="lang-shell hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">'#!/bin/bash'</span> &gt; /start.sh
<span class="hljs-keyword">echo</span> <span class="hljs-string">'/mongodb/bin/mongod'</span> &gt;&gt; /start.sh
chmod +x /start.sh
</code></pre>
<p>After that, let's commit the image again.</p>
<pre><code class="hljs sql">docker <span class="hljs-operator"><span class="hljs-keyword">commit</span> <span class="hljs-string">`docker ps -lq`</span> arunoda/mongo-base
</span></code></pre><p>Now we can run the container as:</p>
<pre><code class="hljs sql">docker run -i -t arunoda/mongo-base /<span class="hljs-operator"><span class="hljs-keyword">start</span>.sh
</span></code></pre><p>So, now you get the idea. Here's the whole process we can use to build Docker images.</p>
<ol>
<li>Create a container from a base image (in our case, Ubuntu is the base image)</li>
<li>Make some changes to the container (add some software or your app).</li>
<li>Commit and create an image.</li>
<li>Start again from the created image.</li>
<li>Add some changes.</li>
<li>Commit and create an image.</li>
<li>Go to step 4.</li>
</ol>
<hr>
<p>Now, we've got a little question for you.</p>
<p>If we need to run the image we've built as a background service, how we could do it?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      docker run -d --restart=always arunoda/mongo-base
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run --restart=always arunoda/mongo-base /start.sh
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run -d --restart=onstart arunoda/mongo-base /start.sh
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run -d --restart=always arunoda/mongo-base /start.sh
    </label>
  </div>
  

  
    <p>
      Correct answer is : docker run -d --restart=always arunoda/mongo-base /start.sh
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>It seems like creating an image is not a simple task and it involves a lot of steps. Most importantly, it's hard to automate that task.</p>
<h2 id="using-a-dockerfile">Using a Dockerfile</h2>
<p>But there is an easy way to build Docker images. That's using a <code>Dockerfile</code> and using <code>docker build</code>. Dockerfile is something similar to a shell script, but it automates the image creation task. </p>
<p>Let's recreate the previously created image using a Dockerfile.</p>
<p>First, create a directory in the host server. Let's say it's <code>mongo-base2</code>. Then create a file called <code>install-mongodb.sh</code> and put this content.</p>
<pre><code class="hljs sql">apt-get <span class="hljs-operator"><span class="hljs-keyword">update</span> -y
apt-<span class="hljs-keyword">get</span> <span class="hljs-keyword">install</span> wget -y
<span class="hljs-keyword">VERSION</span>=<span class="hljs-number">2.6</span><span class="hljs-number">.7</span>
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span>.tgz -O mongodb.tar.gz
tar xzf mongodb.tar.gz
mv mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span> /mongodb
rm mongodb.tar.gz
mkdir -p /<span class="hljs-keyword">data</span>/db
</span></code></pre><p>Then create another file called <code>Dockerfile</code> with the following content.</p>
<pre><code class="lang-shell hljs sql">FROM ubuntu
MAINTAINER Arunoda Susiripala - #<span class="hljs-operator"><span class="hljs-keyword">Replace</span> <span class="hljs-keyword">with</span> your name

# <span class="hljs-keyword">install</span> mongodb
COPY <span class="hljs-keyword">install</span>-mongodb.sh /tmp/<span class="hljs-keyword">install</span>-mongodb.sh
RUN /<span class="hljs-keyword">bin</span>/bash /tmp/<span class="hljs-keyword">install</span>-mongodb.sh

ENTRYPOINT /mongodb/<span class="hljs-keyword">bin</span>/mongod
</span></code></pre>
<p>In the above file, we've used few Dockerfile commands. Let's look at them:</p>
<ul>
<li>FROM - specify the base image.</li>
<li>MAINTAINER - mention who is managing this image. This is purely for bookkeeping purposes.</li>
<li>COPY - copy a file or directory from the host system into the container.</li>
<li>RUN - invoke a shell command inside container.</li>
<li>ENTRYPOINT - the first command to run when the container gets started (from the image)</li>
</ul>
<blockquote>
<p>There are a few <a target="_blank" href="https://docs.docker.com/reference/builder/">more commands</a> available, and we can use them to build complex images.</p>
</blockquote>
<p>Now everything is ready. Let's build the image with <code>docker build</code></p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> build -t arunoda/mongo-base2 .
</code></pre><p>With <code>-t</code>, we give the name for the image, and <code>.</code> at the end tells which directory to use as the source directory (context) for <code>docker build</code>.</p>
<p>This way, if we need to change something, we can easily do it by editing the Dockerfile or a script we've used. Then simply invoke <code>docker build</code> to build the image again.</p>
<h3 id="running-the-image">Running the image</h3>
<p>Unlike the image we built with <code>docker commit</code>, this time we don't need to specify the start command when running the container. That's because we've defined it when creating the image via the <code>ENTRYPOINT</code> command. So this is all we have to do.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base2
</code></pre><blockquote>
<p>It's also possible to override the default entry point. Here's how to do it.</p>
<pre><code class="hljs javascript">docker run -i -t --entrypoint=<span class="hljs-regexp">/bin/</span>bash arunoda/mongo-base2
</code></pre></blockquote>
<hr>
<p>We've mentioned that there are some <a target="_blank" href="https://docs.docker.com/reference/builder/">other commands</a> we can use inside a Dockerfile. "ADD" is a one such command. So what's the difference between "ADD" and "COPY"?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      There is no difference. "ADD" is for backward compatibility
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports remote urls
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports wildcard file matching
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports multiple directories at once
    </label>
  </div>
  

  
    <p>
      Correct answer is : "ADD" supports remote urls
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="port-management">Port Management</h2>
<p>Now we've run a few containers and built our own image. But we need to allow other systems to access the running containers. To do that, we need to map ports inside the containers to the outside.</p>
<p>For example, in our MongoDB image, MongoDB is started and bound to the port  27017 (it's the default port of MongoDB) inside the container. So we need to map it to the port 12021 of our host server. Then, other applications can use it. Let's do it.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -d -p <span class="hljs-number">12021</span>:<span class="hljs-number">27017</span> arunoda/mongo-base2
</code></pre><p>Now when you run <code>docker inspect &lt;container-id&gt;</code> you'll be able to see the port mapping. </p>
<p>You can also check the port mapping yourself. Simply try to connect to the MongoDB container using a mongo shell from anywhere.</p>
<pre><code class="hljs ruby"><span class="hljs-prompt">mongo &lt;ip-of-the-server&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">12021</span>
</code></pre><h3 id="linking-containers">Linking Containers</h3>
<p>It's <a target="_blank" href="https://docs.docker.com/articles/dockerfile_best-practices/">recommended</a> to run just a single process inside a container. For example, let's say we need to run a Meteor app and use nginx for serving SSL. </p>
<p>In this case, we can run those two services inside a single container. That's possible. </p>
<p>But the best and the recommended way is to run them separately. When running the SSL container, just ask it to link with the Meteor container.</p>
<p>The SSL container knows the internal IP address/port of the Meteor container, and it can do its job. Linking is very similar to mapping ports, just within the docker containers.</p>
<p>Follow <a target="_blank" href="https://docs.docker.com/userguide/dockerlinks/">this guide</a> to learn about linking containers.</p>
<hr>
<p>Now it's time for a simple question. </p>
<p>What will happen when you try to map a port that is already mapped to a port of another container? Just run <code>docker run -d -p 12021:27017 arunoda/mongo-base2</code> another time to experience that.</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It'll throw an error, but the container will get started.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll throw an error, and the container won’t start.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll work.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll work, but the previous container will have stopped.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It'll throw an error, and the container won’t start.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="publishing-containers">Publishing Containers</h2>
<p>So you've built an image. Congrats. Why don't you share it with others? </p>
<p>That's where the <a target="_blank" href="https://registry.hub.docker.com/">Docker Registry</a> comes in. </p>
<p>It's a place to share and discover images. We've used <code>ubuntu</code> as our base image. That's also pulled from this repository. </p>
<p>Publishing your image is pretty simple. Just type:</p>
<pre><code class="hljs perl">docker <span class="hljs-keyword">push</span> arunoda/mongo-base2
</code></pre><p>So first, it'll ask to create an account or login to your existing account. You can choose a username you like. But your image should be named with the format of <code>&lt;your username&gt;/mongo-base2</code>.</p>
<h3 id="let-s-pull-an-image">Let's pull an image</h3>
<p>Now we've pushed an image. Let's pull that image to verify that it has moved to the registry. </p>
<p>First remove all of our containers and images:</p>
<pre><code class="hljs perl">docker rm -f <span class="hljs-string">`docker ps -aq`</span>
docker rmi -f <span class="hljs-string">`docker images -q`</span>
</code></pre><blockquote>
<p>These commands will remove everything related to Docker except the runtime. So think twice before you apply above on a production system.</p>
</blockquote>
<p>Then let's run our image:</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -d -p <span class="hljs-number">12021</span>:<span class="hljs-number">27017</span> arunoda/mongo-base2
</code></pre><p>Next, it'll pull <code>arunoda/mongo-base2</code> from the registry and run it. You can also just pull the image with <code>docker pull arunoda/mongo-base2</code>.</p>
<p>There are a lot of things you can do with Docker registries and Docker Hub. Refer to the following links:</p>
<ul>
<li><a target="_blank" href="http://docs.docker.com/docker-hub/builds/">Automated builds on Docker Hub</a></li>
<li><a target="_blank" href="https://docs.docker.com/docker-hub/repos/#private-repositories">Docker Hub's private Docker registry</a></li>
<li><a target="_blank" href="http://docs.quay.io/solution/getting-started.html">Quay.io - another Docker registry</a></li>
<li><a target="_blank" href="http://www.activestate.com/blog/2014/01/deploying-your-own-private-docker-registry">Run a Docker registry yourself</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="using-meteor-with-docker">Using Meteor with Docker</h2>
<p>Now you have a pretty solid idea on how to use Docker. Then, let's try to learn how to run Meteor with Docker. </p>
<p>Basically, there are two ways we can do this:</p>
<ol>
<li>Build a Docker image for your app. Just pull the image and run it.</li>
<li>Give a Meteor bundle to a Docker image and it'll run the bundle.</li>
</ol>
<p>Let's look at both of these solutions.</p>
<h3 id="1-build-a-docker-image-for-your-app">1. Build a Docker image for your app</h3>
<p>We can simply build an image for a Meteor app. In that process, we need to create a bundle from the app and make it runnable. </p>
<p>With your current Docker knowledge, you can start working on that scratch. But we've got a better way to do it. We've created a Docker image called <a target="_blank" href="https://github.com/meteorhacks/meteord">meteorhacks/meteord</a> to make your life easier. </p>
<p>Let's see how we can use it.</p>
<p>First create a Meteor app on our server. (You may need to <a target="_blank" href="http://docs.meteor.com/#/full/">install</a> Meteor on the server.)</p>
<p>Then put this Dockerfile in the root of your app.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">FROM</span> meteorhacks/meteord
MAINTAINER Your Name
</code></pre>
<p>After that, invoke <code>docker build -t arunoda/demoapp .</code> </p>
<p>This will create a Docker image, and we can run it with:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    arunoda/demoapp
</code></pre>
<p>Now, your app will run on port 80 inside the container, and it's mapped to the port 8080 of the host server.</p>
<p>You can automate this process and build a container for every git push with <a target="_blank" href="http://docs.docker.com/docker-hub/builds/">automated builds</a> feature in Docker Hub.</p>
<h3 id="2-run-a-meteor-bundle">2. Run a Meteor bundle</h3>
<p>Sometimes, it's a better idea to run the Meteor bundle itself. For that, you can also use MeteorD. </p>
<p>Let's say you've uploaded the bundle (tar.gz file) to AWS S3, and you can get a direct URL for that. Here's how to run that bundle using Docker.</p>
<blockquote>
<p>Make sure to build the bundle for <code>os.linux.x86_64</code> architecture.</p>
</blockquote>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -e BUNDLE_URL=<span class="hljs-url">http://mybundle_url_at_s3.tar.gz</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    meteorhacks/meteord
</code></pre>
<p>If you have the bundle in the host server, you can directly run that, too. Here, we are using Docker's <a target="_blank" href="https://docs.docker.com/userguide/dockervolumes/">volume mounting</a> feature. With volume mounting, we can expose a directory inside our host server into the container. </p>
<p>Now, let's place the Meteor bundle into a directory called <code>/tmp/data</code> in our host system. There is a Meteor bundle called <code>myapp.tar.gz</code> inside that. The name of the bundle could be anything, but it needs to have the <code>tar.gz</code> extension. This is how to generate a Meteor bundle:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-comment"># go to your project root and apply following</span>
<span class="hljs-title">meteor</span> build --architecture=os.linux.x86_64 /tmp/data
</code></pre>
<p>To run this bundle with MeteorD, just apply the following command<br>(focus your attention on the <code>-v</code> option):</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -v /tmp/<span class="hljs-url">data:/bundle</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    meteorhacks/meteord
</code></pre>
<p>Besides these, there are a few more things you can do with <a target="_blank" href="https://github.com/meteorhacks/meteord">MeteorD</a>. Check out the <a target="_blank" href="https://github.com/meteorhacks/meteord">documentation</a> for that.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Now, you have gained enough knowledge to manage a Docker deployment. But you need to learn more. With this knowledge, you can dive into Docker yourself. Here are some links for you: </p>
<ul>
<li><a target="_blank" href="http://docs.docker.com/">Docker documentation</a></li>
<li><a target="_blank" href="http://blog.docker.com/">Docker blog - for news and the latest updates</a></li>
<li><a target="_blank" href="http://www.dockerbook.com/">Docker Book</a></li>
</ul>
<p>We also have another lesson on CoreOS and clustering with Docker. We will learn more about Docker in that lesson, too.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lesson, we learned about <a href="https://www.docker.com/">Docker</a> and how to deploy Meteor apps with Docker. But, Docker is just a runtime and it does not tell you how to manage a cluster of Docker containers.</p>
<p>So, we need to use some other tools to manage a cluster. Here are some of the tools you can use:</p>
<ul>
<li><a href="https://coreos.com/">CoreOS</a> and <a href="https://github.com/coreos/fleet">Fleet</a></li>
<li>Chef, Salt, Ansible like Ops tools</li>
<li><a href="http://kubernetes.io/">Google's Kubernetes</a></li>
<li><a href="http://deis.io/">Deis - a PAAS</a></li>
<li><a href="https://github.com/docker/swarm/">Docker Swarm</a></li>
</ul>
<p>In this lesson, we'll look at Google's Kubernetes. We chose Kubernetes because it provides a declarative interface to interact with a cluster of nodes. We think Kubernetes is the future of cloud hosting. We also hope major cloud service providers will support Kubernetes natively in the near future.</p>
<p>In this lesson, we are <strong>not</strong> going learn in depth about installing and setting up Kubernetes. Instead, we'll look at how to use the features of Kubernetes. We will use <a href="https://github.com/meteorhacks/kube-init">kube-init</a> to deploy a testing cluster for learning purposes.</p>
<p>After you've had a good working experience with Kubernetes, you can deploy it on <a href="https://github.com/GoogleCloudPlatform/kubernetes/tree/master/docs/getting-started-guides">your own</a> or use a service like <a href="https://tectonic.com/">TecTonic</a>.</p>
<p>Here are the list of topics we will cover in this lesson:</p>
<ul>
<li>Introduction to Kubernetes</li>
<li>Deploying and Testing a Kubernetes Cluster</li>
<li>Deploying the Telescope App (as a Pod) into the Cluster</li>
<li>Using a Replication Controller for High Availability and Scalability</li>
<li>Changing Replicas</li>
<li>Load-Balancing Pods using Kubernetes Services</li>
<li>Deploying Our Own MongoDB Service</li>
<li>Deploying a New Version of the app with Rolling Update</li>
<li>Microservices with Kubernetes</li>
</ul>
<p>Let's Get Started!</p>

  </div>

  
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="introduction-to-kubernetes">Introduction to Kubernetes</h2>
<p>So, what is Kubernetes? If you haven't heard of it before, it's Google's answer to manage a set of containers (or simply a cluster). Kubernetes is not the only solution in this space. <a target="_blank" href="https://mesosphere.com/">Mesosphere</a> and <a target="_blank" href="https://github.com/docker/swarm">Docker Swarm</a> are some other solutions. But Kubernetes is different, because it provides a declarative but highly configurable interface to manage the cluster. You simply need to tell it what you need to do, then Kubernetes will do the hard work.</p>
<p>Before we start, let's look at what Kubernetes is. Some of these may seem bit difficult to understand. But don't worry. we'll practice each of these throughout the lesson.</p>
<h3 id="components-of-kubernetes">Components of Kubernetes</h3>
<p><img src="img/YgsLg7gM2L.png" alt="Components of Kubernetes"></p>
<h4 id="kubernetes-master">Kubernetes Master</h4>
<p>Kubernetes Master controls the overall cluster and runs the API for the cluster. Basically, it will take care of everything in the cluster.</p>
<h4 id="node">Node</h4>
<p>A node is a physical server (or a VM) inside the cluster. It will communicate with the master and run containers (actually pods). You can add and remove any number of nodes you like.</p>
<h4 id="pod">Pod</h4>
<p>The pod is the basic building block of Kubernetes. Inside a pod, you can run a set of containers. Most of the time, we only need to run one container. We can allocate CPU, memory, volumes, and other resources to a pod. So, all the containers inside the pod can share them. Kubernetes also assigns a unique network namespace to each pod. Thus, you don't need to worry about conflicting pods because every pod has its own IP address and a hostname.</p>
<p>You can simply ask Kubernetes to run a pod. But you don't normally want to do that. We'll use a replication controller for that.</p>
<h4 id="replication-controller">Replication Controller</h4>
<p>Even though the pod is very powerful, it can't handle failures itself. Let's say the node (server) running our pod crashes. Then our pod will be removed from the cluster. But this is not the behavior we want. Failures are inevitable, but even in that situation, we need to provide service to our customers. That's what replication controller is for.</p>
<p>It watches the cluster and ensures that a given number of pods will be running in the cluster every time. It can launch new pods and remove existing pods. We can also change the number of pods assigned to a replication controller.</p>
<p>In order to this to function, we need to define our pod as a template inside the replication controller. We'll learn how to do that in a moment.</p>
<h4 id="service">Service</h4>
<p>We know that pods get added and removed. So we need a way to load-balance our traffic into these pods. Service is the solution for that. It can act as a dynamic load balancer for a set of pods. It's very efficient as it tries to use IP tables and other techniques to avoid the load-balancing overhead.</p>
<p>Service can also support basic sticky session support. So, we can run Meteor apps without issues inside a Kubernetes cluster.</p>
<p>Additionally, we can access these services via DNS within each pod inside the cluster, essentially acting as a backbone for micro-services. We'll also talk more about this later in the lesson.</p>
<p>There is a lot more we need to know about Kubernetes. We'll learn them while we are practicing.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>Kubernetes does a lot of work for us, but it's quite difficult to install a Kubernetes cluster our own. So, for learning purposes, we'll deploy a Kubernetes cluster inside a single machine.</p>
<p>With that, we can learn how to use Kubernetes without spending a lot of time to configure and deploy a real cluster. At the end of the lesson, we'll show you few options to deploy a real cluster.</p>
<h3 id="setting-up-the-cluster">Setting Up the Cluster</h3>
<p>First, you need a <strong>Ubuntu 64 bit</strong> server. It could be a cloud VM or a vagrant box. Try to select a somewhat large VM because we'll be running a few processes inside this server. </p>
<p>Then we are going to use <a target="_blank" href="https://github.com/meteorhacks/kube-init">kube-init</a> to deploy a Kubernetes cluster inside that.</p>
<p>After you've created the server, SSH into that by applying following command:</p>
<pre><code class="hljs nginx"><span class="hljs-title">wget</span> -qO- <span class="hljs-url">http://git.io/veKlu</span> | sudo sh
</code></pre><p>It will install both the Kubernetes master and a node inside a single server.</p>
<p>When you apply the <code>kubectl get nodes</code> command, you should get an output like this:</p>
<p><img src="img/oCrLC6fr9K.png" alt="Kubernetes get node"></p>
<p>It shows the only node in our cluster, which is the current server.</p>
<h3 id="accessing-the-kubernetes-network">Accessing the Kubernetes Network</h3>
<p>Kubernetes create its own network inside the cluster. Each pod and service gets its own IP address. So, it would be great if we could access those IPs from our local machine. Let's do it.</p>
<p>First, you need to create a SOCKS Proxy with your server. For that, simply apply the following command in a separate terminal.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">ssh</span> -D <span class="hljs-number">8082</span> your-user<span class="hljs-variable">@your</span>-server-ip
</code></pre>
<p>This command will log you into the server. Also, it will create a SOCKS proxy on "localhost" on port "8082".</p>
<p>Then we need to configure our browser for the SOCKS proxy we've just created. We'll show you how to do it for both Chrome and Firefox on a Mac. Instructions for Linux or Windows are the same.</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=QPSYy0vZjw4&amp;feature=youtu.be">For Firefox</a> - (Recommended - This will add proxy only to Firefox)</li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=ASugh1lSmps&amp;feature=youtu.be">For Chrome</a> - (this will add the proxy to your whole machine)</li>
</ul>
<p>Now you can access the network inside your server locally using your browser. Also, if you try to access the Internet, all the requests will proxy through your server. Visit <a target="_blank" href="https://www.whatismyip.com/">website</a> and you can verify that your IP is the server's IP.</p>
<h3 id="editing-files">Editing Files</h3>
<p>We are accessing Kubernetes cluster with the "kubectl" command installed on the server. So, you need to create and edit files inside the server. For that, you can use <a target="_blank" href="http://en.wikipedia.org/wiki/Vim_%28text_editor%29">vim</a>, <a target="_blank" href="http://en.wikipedia.org/wiki/GNU_nano">nano</a> or something like <a target="_blank" href="http://en.wikipedia.org/wiki/Rsync">rsync</a>.</p>
<p>Now we are ready. Let's start playing with Kubernetes.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="deploying-telescope-a-pod-into-the-cluster">Deploying Telescope (a Pod) into the Cluster</h2>
<p>Now let's a deploy our first pod into the cluster. For that we need to create a simple JSON file. </p>
<p>Add following content into a filename called <code>telescope-pod.json</code>.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-pod"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Pod"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
        "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
        "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
        "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
          "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
        </span>}]
      </span>},
      {
        "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
        "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
        "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
          "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
        </span>}]</span>,
        "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
          {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
          {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://localhost:27017/app"</span></span>}
        ]
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>This file may seem a bit complex, but it's not. Basically, this file defines a pod with the name <code>telescope-pod.</code> We have defined two containers inside this pod, a mongo container and a telescope container.</p>
<p>This pod is a fully functioning <a target="_blank" href="http://www.telescopeapp.org/">Telescope</a> app. </p>
<p>In the mongo container, we specify that its port is 27017. Then we've added a few options to make sure that MongoDB starts very quickly without doing any initial data allocation.</p>
<p>Then in the telescope container, we specify that it is using port 80 and provide some usual Meteor specific environment variables to it: <code>ROOT_URL</code> and <code>MONGO_URL</code>. But, first take a look at the value of <code>MONGO_URL</code>. It's something like this:</p>
<pre><code class="hljs javascript">MONGO_URL=mongodb:<span class="hljs-comment">//localhost:27017/app</span>
</code></pre><p>Normally, it's not possible to access the port of other containers within a container. But in this case, we could be able access MongoDB within the telescope container. That's because all the containers in a pod shares a single network namespace.</p>
<h3 id="creating-the-pod">Creating the Pod</h3>
<p>Now that we know how pod definition works, let's create a pod. Simply run following command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-pod.json
</span></code></pre>
<p>This will create a pod in the cluster. You can verify that by entering following command, which give you a list of pods in the cluster:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">kubectl</span> get pod
</code></pre>
<p>First, it will show the pod's state as "Pending". That's because Kubernetes downloads Docker images and does some initialization. Within few minutes you'll be able to see its state as "Running".</p>
<p>You can check also check the logs of the each container by entering following commands:</p>
<pre><code class="lang-shell hljs perl">kubectl <span class="hljs-keyword">log</span> telescope-pod mongo
kubectl <span class="hljs-keyword">log</span> telescope-pod telescope
</code></pre>
<p>Okay, now we know our telescope instance is running, but how can we access it? Let's describe our pod by running this command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">describe</span> pod telescope-pod
</span></code></pre>
<p>Then we'll get something like this:</p>
<p><img src="img/sgdxGhcrr5.png" alt="Kubernetes Pod Info"></p>
<p>Then you can see that our pod has its own IP address. Now try to access that IP from the browser configured with the SOCKS Proxy. You'll be able to access our Telescope app.</p>
<p><img src="img/hqfejMwnFV.png" alt="Telescope Running as a Pod"></p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h3 id="deleting-our-pod">Deleting Our Pod</h3>
<p>In the next section, we are going to launch our telescope pod in a different way. So, it's a good idea to remove the current pod. Apply the following command to remove it.</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> pod telescope-pod
</code></pre>
<p>"telescope-pod" is the name of our pod. Likewise, you can remove any pod you like. The API of Kubernetes is very predictable. Likewise, you can remove other resources as well.</p>
<p>So, here's the generic API for deleting resources:</p>
<pre><code class="lang-shell hljs xml">kubectl delete <span class="hljs-tag">&lt;<span class="hljs-title">resource-type</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">resource-name</span>&gt;</span>
</code></pre>
<p>In this lesson, we are going to learn following key resource types:</p>
<ul>
<li>pod - Kubernetes pod</li>
<li>rc - replication controller</li>
<li>service - Kubernetes service</li>
</ul>
<p>You can delete them as shown below.</p>
<p>Now here's a simple exercise for you. From the following list, select the wrong way of deleting resources:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      kubectl delete rc my-rc
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl delete service my-service
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl delete rc my-rc-2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl service delete my-service2
    </label>
  </div>
  

  
    <p>
      Correct answer is : kubectl service delete my-service2
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="replicate-our-pod-for-high-availability-and-for-scaling">Replicate Our Pod for High Availability and for Scaling</h2>
<p>As you know already, our pod could get destroyed due to several reasons. If a pod gets destroyed, we need to create a new one. But that's not ideal.</p>
<p>That's where <strong>Replication Controller</strong> is going help us. A replication controller will allow us to run multiple pods (knowns as replicas) and maintain the replica count by starting new pods and removing excess pods.</p>
<p>Creating a replication controller is simple. Simply add following content into a filename called "telescope-rc.json".</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
            </span>}]
          </span>},
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://localhost:27017/app"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>In this definition, we need pay attention to few things. Let's discuss.</p>
<h4 id="spec-template-spec">spec.template.spec</h4>
<p>This is very similar to the our previous pod definition. </p>
<h4 id="spec-template-metadata-labels">spec.template.metadata.labels</h4>
<p>Here is something very important: Now we are creating multiple pods. The replication controller and other resources of Kubernetes need to identify these pods. That means we need to filter these pods from others. Labels are the way to do that.</p>
<p>Labels are simply a set of key value pairs. So with <code>spec.template.metadata.labels</code> we ask the replication controller to label our pod with the given set of key value pairs.</p>
<h4 id="spec-selector">spec.selector</h4>
<p>This is the selector where the replication controller selects pods and maintains the number of replicas. Normally, these will be the labels you defined in <code>spec.template.metadata.labels</code>. Then, this replication controller looks for all the matching pods in the cluster and tries to maintain the <code>spec.replicas</code> count.</p>
<h3 id="let-s-deploy-a-replication-controller">Let's Deploy a Replication Controller</h3>
<p>Simply apply the following command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<p>You can call <code>kubectl get rc</code> and confirm whether the replication controller is running or not.</p>
<p>Now try to invoke following command:</p>
<pre><code class="lang-shell hljs bash">kubectl get pods <span class="hljs-operator">-l</span> <span class="hljs-built_in">type</span>=telescope
</code></pre>
<p>Then you'll get a list of pods running with the label "type=telescope". </p>
<p><img src="img/LOnv-fH0kJ.png" alt="Running Kubernetes Pods"></p>
<p>Check their pod names. They are dynamically created with adding a prefix to the replication controller name. As usual, you can access each of these pods with the allocated IP address.<br>(You need invoke <code>kubectl describe pod &lt;pod-name&gt;</code> to see the IP address)</p>
<hr>
<p>So, it's a time for a question.<br>Try to delete our replication controller with following command:</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>So, what will happen to the pods it created before?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      They'll be there with their "Running" status.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      They'll get removed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      They'll be there with their "Pending" status.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Ask us to delete pods first.
    </label>
  </div>
  

  
    <p>
      Correct answer is : They'll get removed.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="scaling-replicas">Scaling Replicas</h2>
<p>We will need scale(or resize) replicas for scaling purposes or to improve the availability.</p>
<p>We can scale the replica count by just using a command. Before that, we need to create the replication controller again (because we removed it in the previous section).</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<p>Now let's resize our replica count to 5.</p>
<pre><code class="lang-shell hljs sql">kubectl scale <span class="hljs-comment">--replicas=5 rc telescope-rc</span>
</code></pre>
<p>You can verify the replica count by running <code>kubectl get pods -l type=telescope</code> again. You can set <code>replicas=0</code> to remove the telescope app from the cluster.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="load-balancing-pods-with-kubernetes-service">Load Balancing Pods with Kubernetes Service</h2>
<p>Now we've got a set of pods running our telescope app. So, we need to load-balance traffic to them. That's where Kubernetes service comes in. It's a network layer load balancer. It also have basic sticky session support using the client's IP and port.</p>
<h3 id="creating-the-service">Creating the Service</h3>
<p>Add following content to a filename called "telescope-service.json".</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]</span>,
    "<span class="hljs-attribute">sessionAffinity</span>": <span class="hljs-value"><span class="hljs-string">"ClientIP"</span>
  </span>}
</span>}
</code></pre>
<p>Let's look at some of these fields.</p>
<ul>
<li>spec.selector - selects a set of pods (backends) based on labels</li>
<li>spec.ports[0].port - external port of the load balancer where users need to send requests</li>
<li>spec.ports[0].targetPort - the port of the pod where service needs to forward requests</li>
<li>spec.sessionAffinity - enabled sticky sessions and select the algorithm. This is disabled by default. <code>ClientIP</code> is the only supported algorithm for now.</li>
</ul>
<p>So, it's time to deploy our service. You can do it with this command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-service.json
</span></code></pre>
<p>You can check it by running following command:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">kubectl</span> get services
</code></pre>
<p>Then it will give you something like this:</p>
<p><img src="img/oTWoVbUEWs.png" alt="List of Services"></p>
<p>You can use the IP assigned to service to access your pod. It will load-balance the traffic in round-robin fashion with the sticky session support.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="deploying-our-own-mongodb-service">Deploying Our Own MongoDB Service</h2>
<p>In the telescope replication controller, we used a separate mongo instance for each telescope instance. But for a real app, we need to use a single database for all instances. Let's try to create a MongoDB service here inside Kubernetes and use it as the database for all of our telescope instances.</p>
<p>So, these are the things we are going to do:</p>
<ol>
<li>Create a Mongo replication controller with one replica.</li>
<li>Create a service targeting the above mongo pods.</li>
</ol>
<p>Here's our replication controller. ("mongo-rc.json")</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
            </span>}]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Create it with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f mongo-rc.json
</span></code></pre>
<p>Here's the definition for our service ("mongo-service.json"):</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">27017</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>Then create the service with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f mongo-service.json
</span></code></pre>
<p>Okay. Now we've a running MongoDB service in our cluster. Nice. </p>
<h3 id="using-the-new-mongo-service">Using the New Mongo Service</h3>
<p>So, first we need delete the existing telescope replication controller (It'll remove created pods as well).</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>Now here's our new replication controller for telescope.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Everything is just as it was, except for two changes:</p>
<ul>
<li>We removed the MongoDB container from the pod</li>
<li>We changed the MONGO_URL environment variable to <code>mongodb://mongo-service:27017/mydb</code>. So, what's "mongo-service:27017"? </li>
</ul>
<p>That's our mongo service's name and the port. By using the above MONGO_URL we can access our running MongoDB service. Similarly, we can access any running service via DNS using similar URLs. That is the beauty of Kubernetes services. This is also the basic building block for Microservices. (We'll talk about Microservices in a moment.)</p>
<p>So, let's create the updated replication controller with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<hr>
<p>So, now let us ask simple question from you?</p>
<p>When defining our mongo replication controller, we've specified only a single replica. Is there any special reason for that?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      No.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, we need to have more RAM to run multiple mongo containers. We specify only one replica because we are not sure about the RAM of your server.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, running multiple mongo containers itself does not scale MongoDB.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, in order to do that we need have at least two physical servers.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Yes, running multiple mongo containers itself does not scale MongoDB.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="deploying-new-versions-with-rolling-updates">Deploying New Versions with Rolling Updates</h2>
<p>Deploying a new version (of the pod) is trickier with Kubernetes. Removing the replication controller does not remove our pods. So, we need to resize it to 0 and resubmit the replication controller. But, when we do that, our app goes down for a few seconds (or minutes). </p>
<p>So, best approach is to do a rolling update, which means that we will add newer versions of pods while removing older ones. We'll add and remove one at a time. With that, we don't need to worry about a service downtime.</p>
<blockquote>
<p>With rolling updates, it's possible to have at least two versions of your app running at the same time. You need to design your app in a way to handle it.</p>
</blockquote>
<p>Fortunately, Kubernetes has a built-in way to do rolling updates. To do that, first we need to track the version of our pod.</p>
<p>Before we do that, let's remove the existing replication controller.</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>Now let's create our new replication controller <code>telescope-rc-v1</code>. Create this file on the server as <code>telescope-rc-v1.json</code> and launch it.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>The above replication controller is just like the previous one, but now it has label field called <strong>version</strong>.</p>
<p>Let's create that:</p>
<pre><code class="hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc-v1.json
</span></code></pre><p>So, let's say now we need to deploy a new version of our telescope app. To do that, first we need to create a new replication controller with a new name. It should contain a different value for the version label as well.</p>
<p>Here it is. Save following content into a file called <code>telescope-rc-v2.json</code> in the server.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc-v2"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v2"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v2"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Doing the rolling update is simple. Invoke the following command:</p>
<pre><code class="lang-shell hljs sql">kubectl rolling-<span class="hljs-operator"><span class="hljs-keyword">update</span> <span class="hljs-comment">--update-period=5s telescope-rc-v1 -f telescope-rc-v2.json</span>
</span></code></pre>
<p>Then it will remove pods from replication controller "telescope-rc-v1" one by one while adding new pods from the replication controller defined at "telescope-rc-v2.json". After removing all the pods of the old replication controller, it will remove the old replication controller as well.</p>
<p>This is the way that Kubernetes allows us to do rolling updates (or rolling deployments). Still, we need to do few things ourselves like creating a new replication controller. Anyway, the "rolling-update" command is very helpful.</p>
<hr>
<p>Now, here's a simple question for you.</p>
<p>With rolling updates, we used different labels. But we didn't need to update our service. Why was that?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Our service "telescope-service" is looking for pods labeled with "type=telescope version=*". The current labeling method satisfy that.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The rolling update command automatically update the service.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Our service "telescope-service" is looking for pods labeled with "type=telescope". The current labeling method satisfy that.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Our service didn't work after the rolling update changes.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Our service "telescope-service" is looking for pods labeled with "type=telescope". The current labeling method satisfy that.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="microservices-with-kubernetes">Microservices With Kubernetes</h2>
<p>In this lesson, we are going to deploy a set of Meteor microservices into the Kubernetes cluster and see how to enable the communication with each other. For that, we assume there is a mongo service running inside the cluster and we can access it via <code>mongodb://mongo-service:27017</code>.</p>
<p>This is the same set of microservices we deployed with our microservices lesson. It's a simple Meteor package search app with following services:</p>
<ul>
<li>search: app performs the search.</li>
<li>logging: app does the logging.</li>
<li>web: front facing app .</li>
</ul>
<p>At the end, we'll have an app like <a target="_blank" href="https://www.youtube.com/watch?v=v2hIDu4uQrU&amp;feature=youtu.be">this (video)</a>.</p>
<p>Here's the web app's core logic:</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> searchConn = DDP.connect(process.env.SEARCH_SERVICE_URL);
<span class="hljs-keyword">var</span> loggingConn = DDP.connect(process.env.LOGGING_SERVICE_URL);

<span class="hljs-comment">// define the source for search using the above search connection.</span>
SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// do the logging with the logging connection.</span>
  loggingConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'searching for package: '</span> + searchText);
  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});

<span class="hljs-comment">// get the top packages from the local db.</span>
Meteor.publish(<span class="hljs-string">'topPackages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// do the logging with the logging connection.</span>
  loggingConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'accessing top packages'</span>);
  <span class="hljs-keyword">var</span> options = {sort: {isoScore: -<span class="hljs-number">1</span>}, limit: <span class="hljs-number">20</span>};
  <span class="hljs-keyword">return</span> Packages.find({}, options);
});
</code></pre>
<p>As you can see, now we simply get the URL of individual service via environment variables and connect to them with "DDP.connect". After that we'll invoke methods on those connections. You can learn more about this app by looking at the <a target="_blank" href="https://github.com/bulletproof-meteor/ms-kube">source code</a>.</p>
<p>All these services reside in a single project. We've published this app to the Docker hub registry (using <a target="_blank" href="https://github.com/meteorhacks/meteord">MeteorD</a>) and we can get individual services via the following Docker images:</p>
<ul>
<li>search - bulletproofmeteor/ms-kube:search</li>
<li>logging - bulletproofmeteor/ms-kube:logging</li>
<li>web - bulletproofmeteor/ms-kube:web</li>
</ul>
<h3 id="launching-services-on-kubernetes">Launching Services on Kubernetes</h3>
<p>Now we are going to launch the above three services on Kubernetes. So, we need a replication controller and a service for each app. Here they are:</p>
<h4 id="search">Search</h4>
<p><strong>search-rc-v1.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:search"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/search"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>search-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<h4 id="logging">Logging</h4>
<p><strong>logging-rc-v1.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:logging"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/logging"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>logging-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<h4 id="web">Web</h4>
<p><strong>web-rc-v1.json</strong></p>
<p>Our web replication controller is just like other two, but it contains environment variables for both logging and search services.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:web"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/web"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"SEARCH_SERVICE_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://search-service"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"LOGGING_SERVICE_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://logging-service"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>web-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>Now that we have all the files we need, let's launch these replication controllers and services.</p>
<p>After all these have been launched, you can get service IPs via <code>kubectl get service</code>.</p>
<p>Then try to visit the IP address of the web service from the browser, and you'll be able to search for packages as shown in this <a target="_blank" href="https://www.youtube.com/watch?v=v2hIDu4uQrU&amp;feature=youtu.be">video</a>.</p>
<hr>
<p>Similarly, you can deploy any meteor service you like and connect to each other via "DDP.connect". Since we always have a static URL/IP for the service, it's safe to even hardcode URLs of these services in your code.</p>
<p>So, here's a simple question for you:</p>
<p>Let's say we need to use our search service on the client. What are the changes we need to make?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Use `meteorhacks:cluster` to register these apps and use it to get the connection. Then change the app accordingly.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Just use the URL of the search service in the client with "DDP.connect" to create a connection. Then change the app accordingly.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can't do that with Kubernetes.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Just use the URL of the search service in the client with "DDP.connect" to create a connection. (Make sure to expose the search to the Internet via the `createExternalLoadBalancer` flag when doing this for real.) Then change the app to search locally.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Just use the URL of the search service in the client with "DDP.connect" to create a connection. (Make sure to expose the search to the Internet via the `createExternalLoadBalancer` flag when doing this for real.) Then change the app to search locally.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="deploying-a-production-kubernetes-cluster">Deploying a Production Kubernetes Cluster</h2>
<p>We've covered a lot of topics related to Kubernetes, and now you can try to deploy a production cluster.</p>
<h3 id="google-container-engine">Google Container Engine</h3>
<p>Your first choice should be Google's <a target="_blank" href="https://cloud.google.com/container-engine/">Google Container Engine</a>, which is a hosted version of Kubernetes on the Google cloud. This service is still in the alpha stage.</p>
<h3 id="tectonic">TecTonic</h3>
<p><a target="_blank" href="https://tectonic.com/">TecTonic</a> is a service that allows you to deploy a Kubernetes cluster into any cloud provider you like. This service is from the <a target="_blank" href="https://coreos.com/">CoreOS</a> team and backed by Google ventures. So, TecTonic will be a pretty solid service. Right now, it's not open for public, but you can sign up for the beta access.</p>
<h3 id="deploy-your-own">Deploy Your Own</h3>
<p>You can also deploy a Kubernetes cluster on your own. There are a lot of guides available to do that. <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/tree/master/docs/getting-started-guides">Start Here</a>.</p>
<hr>
<p>This is just the early stage of Kubernetes. There'll be a lot of tools and services to deploy Kubernetes in the future. So, moving to Kubernetes makes your infrastructure future proof.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="what-next">What Next</h2>
<p>You've learned about almost all the core topics on using a Kubernetes cluster. We haven't discussed deploying and managing a Kubernetes cluster. That's because we don't really need to worry about that.</p>
<p>Kubernetes is the future of the cloud. It's vendor independent and can be used with any cloud provider you like. So, in the future almost all the cloud providers will support Kubernetes and manage the cluster for you. Then your job will be to use it correctly. <strong>That's what we learned in this lesson.</strong></p>
<h3 id="keep-up-with-kubernetes">Keep Up with Kubernetes</h3>
<p>Kubernetes is an evolving technology, and there is a lot of development happening right now. So, expect breaking changes. When any changes happen, we'll update this lesson and notify you. It's a good idea to watch the development of Kubernetes yourself. Here are some useful Kubernetes resources:</p>
<ul>
<li>Official Web Site: <a target="_blank" href="http://kubernetes.io/">http://kubernetes.io/</a></li>
<li>Github Repo: <a target="_blank" href="https://github.com/googlecloudplatform/kubernetes">https://github.com/googlecloudplatform/kubernetes</a></li>
<li>Releases: <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/releases">https://github.com/GoogleCloudPlatform/kubernetes/releases</a></li>
<li>Roadmap: <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/roadmap.md">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/roadmap.md</a></li>
<li>Blog: <a target="_blank" href="http://kubernetesio.blogspot.com/">http://kubernetesio.blogspot.com/</a></li>
<li>Documented API: <a target="_blank" href="http://kubernetes.io/third_party/swagger-ui/">http://kubernetes.io/third_party/swagger-ui/</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Eventloop and Measuring Eventloop</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/nodejs-internals/eventloop-and-measuring-eventloop">
        
          Introduction
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>We've <a href="https://meteorhacks.com/postponing-nodejs-internals-lessons-on-bulletproof-meteor.html">postponed</a> working on these lessons. <a href="https://meteorhacks.com/postponing-nodejs-internals-lessons-on-bulletproof-meteor.html">Here are the reasons</a> for that.</p>

  </div>
</div>

	</body>
</html>
