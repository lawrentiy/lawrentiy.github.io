<html>
	<head>
		<link href="style.css" rel="stylesheet" type="text/css">
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	</head>
	<body>

      <div id="lesson-content">
  <h2 id="additional-resources">Additional Resources</h2>
<p>Scaling is a vast area and there are a lot more techniques we could discuss. We'll cover some of them later in the course. If you are keen to know more, here are some additional resources.</p>
<ul>
<li><a target="_blank" href="https://meteorhacks.com/pro-meteor/">Pro Meteor Guide</a></li>
<li><a target="_blank" href="https://xivilization.net/~marek/blog/2014/08/07/dockerizing-meteor/">Docker and Meteor</a></li>
<li><a target="_blank" href="https://github.com/phusion/passenger/wiki/Phusion-Passenger:-Meteor-tutorial">Using Phusion Passenger with Meteor</a></li>
<li><a target="_blank" href="https://github.com/ongoworks/launchdock">Launch Dock</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>When we are building an app, it's quite common to implement background jobs for certain tasks. It would be better if we could run separate workers for those instances. In this lesson, we're going to build a DDP-based job processing system from scratch.</p>
<p>This is what we are going to build: </p>
<iframe src="//www.youtube.com/embed/fqA0i2artVU" allowfullscreen="1" width="640" frameborder="0" height="480"><br></iframe>

<p>Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>We are going to implement what you just saw on the video. For that, we first need to clone this repo:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-ddb-job-server.git</span>
</code></pre><p>This repo has three Meteor apps located in <code>main</code>, <code>worker1</code>, and <code>worker2</code> directories. You need to start these apps in the following ports:</p>
<ul>
<li>main – port 8005</li>
<li>worker1 – port 7005</li>
<li>worker2 – port 7015</li>
</ul>
<p>As their names imply, the first one is the main app, which does scheduling, and the other two are the workers. Workers only contain a simple method that mimics some real work (like processing a video).</p>
<p>Start the above apps and open the main app in the browser. Then click the "Process Video" button. What's the output you see on the screen?</p>
<h4 id="option-1">Option 1</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">error</span> <span class="hljs-tag">processing</span>: <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[400]</span>
</code></pre><h4 id="option-2">Option 2</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[500]</span>
</code></pre><h4 id="option-3">Option 3</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">error</span> <span class="hljs-tag">processing</span>: <span class="hljs-tag">no</span> <span class="hljs-tag">worker</span> <span class="hljs-tag">to</span> <span class="hljs-tag">process</span> <span class="hljs-attr_selector">[500]</span>
</code></pre><h4 id="option-4">Option 4</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span> <span class="hljs-tag">completed</span>!
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
    <p>
      Correct answer is : Option 3
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="what-s-inside-">What's Inside?</h2>
<p>Let's see what's inside these apps.</p>
<h3 id="workers">Workers</h3>
<p>Both of the workers are identical and contain the following code, which simulates a long-running task:</p>
<pre><code class="hljs javascript">Meteor.methods({
  <span class="hljs-string">"processVideo"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"processing video for 2 seconds"</span>);
    Meteor._sleepForMs(<span class="hljs-number">2000</span>);
    <span class="hljs-keyword">return</span> {done: <span class="hljs-literal">true</span>};
  }
});
</code></pre><h3 id="main-app">Main App</h3>
<p>The main app does the scheduling and has a very simple UI. We are only interested in code that lives inside the <code>server</code> directory.</p>
<p><code>server/main.js</code> has the content shown below, which initializes workers. It also accepts jobs via the <code>processVideo</code> method from the client, and invokes workers.</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> workerUrls = [
  <span class="hljs-string">"http://localhost:7005"</span>,
  <span class="hljs-string">"http://localhost:7015"</span>
];

<span class="hljs-keyword">var</span> workers = <span class="hljs-keyword">new</span> Workers(workerUrls);

Meteor.methods({
  processVideo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();
    <span class="hljs-keyword">return</span> workers.processVideo();
  }
});
</code></pre><p>Let's see what's inside the <code>Workers</code> class. It's located at <code>server/workers.js</code>.</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  <span class="hljs-comment">// You are going to implement the actual connection logic here</span>

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}

Workers.prototype.getNextWorker = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.workers.length == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._nextWorker &gt;= <span class="hljs-keyword">this</span>.workers.length) {
    <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">this</span>.workers[<span class="hljs-keyword">this</span>._nextWorker++];
  <span class="hljs-keyword">return</span> worker;
};

Workers.prototype.processVideo = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  args = _.toArray(args);
  args.unshift(<span class="hljs-string">'processVideo'</span>);
  <span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">this</span>.getNextWorker();
  <span class="hljs-keyword">if</span> (worker) {
    <span class="hljs-keyword">return</span> worker.call.apply(worker, args);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">500</span>, <span class="hljs-string">"no worker to process"</span>);
  }
};
</code></pre><p>Inside the "Workers" class, we are going to make a DDP connection to each worker it's initialized with. The following two methods have been implemented for you:</p>
<ul>
<li><code>getNextWorker</code> method gets a worker from the <code>this.workers</code> array, if there are any.</li>
<li><code>processVideo</code> simply gets a worker and invokes the <code>processVideo</code> Meteor method on that worker.</li>
</ul>
<blockquote>
<p><code>this.workers</code> array contains the DDP connections of connected workers. Currently, it's an empty array.</p>
</blockquote>
<p>Previously, you got an error when trying to invoke "processVideo" from the client. How do you think you should fix it?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Make connections to workers.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Make connections to workers and add them to `this.workers`.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Invoke the `DDP.addWorker()` method for each worker.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Invoke the `DDP.createWorker()` method for each worker.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Make connections to workers and add them to `this.workers`.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="connecting-to-workers">Connecting to Workers</h2>
<p>First of all, make sure our two workers are running on ports 7005 and 7015, respectively.</p>
<p>We are going to use the <code>DDP.connect</code> API to connect to those workers. It's a very simple API with the following syntax:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> meteorAppUrl = <span class="hljs-string">"http://localhost:7005"</span>;
<span class="hljs-keyword">var</span> client = DDP.connect(meteorAppUrl);
</code></pre><p>The <code>client</code> object has all the familiar methods like <code>call</code> and<code>subscribe</code>. They behave in exactly the same way as  they behave in the browser. If you'd like to learn more, check out the <a target="_blank" href="http://docs.meteor.com/#/full/ddp_connect">official docs</a>.</p>
<p>So, your task is simple. Iterate over the <code>workers</code> argument of the constructor. Then connect to those workers and push them into the <code>this.workers</code> array.</p>
<p>After you've done that, try clicking "Process Video" again. What's the message you got?</p>
<h4 id="option-1">Option 1</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processed</span>
</code></pre><h4 id="option-2">Option 2</h4>
<pre><code class="hljs javascript">[jobId: <span class="hljs-number">1</span>] processing
[jobId: <span class="hljs-number">1</span>] processed: {<span class="hljs-string">"done"</span>:<span class="hljs-literal">true</span>}
</code></pre><h4 id="option-3">Option 3</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span> <span class="hljs-tag">completed</span>!
</code></pre><h4 id="option-4">Option 4</h4>
<pre><code class="hljs css"><span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">processing</span>
<span class="hljs-attr_selector">[jobId: 1]</span> <span class="hljs-tag">done</span>
</code></pre>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Option 1
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 3
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Option 4
    </label>
  </div>
  

  
    <p>
      Correct answer is : Option 2
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Great. Here's the actual implementation we are expecting. Compare it with yours.</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  workers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
    <span class="hljs-keyword">var</span> worker = DDP.connect(url);
    self.workers.push(worker);
  });

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}
</code></pre>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>This implementation works, but it does not handle connection status properly. You can try that yourself: close all the workers and click "Process Video". </p>
<p><em>You could able to submit jobs, but nothing happens.</em></p>
<p>In such situations, we need to pick disconnected workers and remove them from the <code>this.workers</code> array. For that, we are going to use the <code>client.status()</code> API. It will give us an object that contains the status of the connection. That object has a field called <code>connected</code>, which indicates the status of the connection.</p>
<pre><code class="hljs javascript"><span class="hljs-built_in">console</span>.log(client.status().connected) <span class="hljs-comment">// true -&gt;</span>
</code></pre><p>This APIs similar to the <code>Meteor.status</code> API. You can learn more about it <a target="_blank" href="http://docs.meteor.com/#/full/meteor_status">here</a>.</p>
<p>If you look at the docs properly, <code>client.status()</code> is a reactive API; we can watch the status with <code>Tracker.autorun()</code>. </p>
<p>Normally, we don't use the <code>Tracker</code> APIs in the server. But we can use Tracker inside the server for this particular purpose—there is nothing wrong with that. You can write something like the code below without any issues.</p>
<pre><code class="hljs javascript">Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(client.status().connected);
});
</code></pre><p>Now you are going to watch the status of each worker and remove any worker that gets disconnected from <code>this.workers</code>. Once  a worker comes back, add it to the <code>this.workers</code> array.</p>
<p>Do that now.</p>
<p>After you've done that, disconnect one worker and click "Process Video" a few times. What's your observation?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      None of them processed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Only half of them processed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      You got a "timeout error" message.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      All of them processed successfully.
    </label>
  </div>
  

  
    <p>
      Correct answer is : All of them processed successfully.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Ideally, This is the implementation you should have written:</p>
<pre><code class="hljs javascript">Workers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(workers)</span> </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.workers = [];

  workers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
    <span class="hljs-keyword">var</span> worker = DDP.connect(url);

    Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> status = worker.status();
      <span class="hljs-keyword">if</span> (status.connected) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"worker connected: "</span> + url);
        self.workers.push(worker);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> index = self.workers.indexOf(worker);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"worker disconnected: "</span> + url);
          self.workers.splice(index, <span class="hljs-number">1</span>);
        }
      }
    });
  });

  <span class="hljs-keyword">this</span>._nextWorker = <span class="hljs-number">0</span>;
}
</code></pre>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="other-approaches-to-job-management">Other Approaches To Job Management</h2>
<p>In this lesson, we've build a Job Management system ourself. Our focus was not to build a perfect "Job Management" system, but to take the first step and learn about server to server DDP.</p>
<p>In the Meteor community there are couple of packages for managing distributed jobs. Let me show you few of them:</p>
<ul>
<li><a target="_blank" href="https://github.com/Differential/meteor-workers/">Workers</a> - This project is similar to what we've done here. It'll manages workers for you.</li>
<li><a target="_blank" href="https://github.com/percolatestudio/meteor-synced-cron">Synched Cron</a> - It's a distributed cron like job management system.</li>
<li><a target="_blank" href="https://github.com/vsivsi/meteor-job-collection">Job Collections</a> - It's another attempt to Job Scheduling for Meteor. It has a rich API compared with the simple API provided by Synched Cron.</li>
</ul>
<p>All of the above solutions are directly coupled with Meteor. But, you can always use dedicated queuing servers and cloud services for Job Management. Let me show you few of them:</p>
<ul>
<li><a target="_blank" href="https://www.rabbitmq.com/">RabbitMQ</a></li>
<li><a target="_blank" href="http://kafka.apache.org/">Kafka</a></li>
<li><a target="_blank" href="http://www.iron.io/mq">Iron MQ</a></li>
<li><a target="_blank" href="https://cloud.google.com/pubsub/docs">Google Cloud Pub/Sub</a></li>
<li><a target="_blank" href="http://aws.amazon.com/sqs/">AWS SQS</a></li>
</ul>
<p>You can easily use most of these with your Meteor app using their nodejs integrations.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Managing Jobs with Meteor (with Server to Server DDP)</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/server-to-server-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/3">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/4">
        
          2
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/server-to-server-ddp/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/server-to-server-ddp/7">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/server-to-server-ddp/8">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="other-use-cases-for-server-to-server-ddp">Other Use Cases for Server To Server DDP</h2>
<p>A job scheduling system is one use case where a server-to server DDP comes in useful. But there are a lot of other things you can do with a server-to-server DDP. Here are some of them:</p>
<ul>
<li>Real-time monitoring endpoints</li>
<li>Building APIs</li>
<li>Gluing your backend systems</li>
<li>Providing a management console for some systems</li>
</ul>
<p>What else could we build with a server-to-server DDP? Do you have some previous experience with them? Share them with us in the comments section.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>When we are building an app, it's a good idea to build it as a set of modules. But up until the recent past, we put all these modules inside a single app. Those modules could include:</p>
<ul>
<li>Business logic processing</li>
<li>Email sending</li>
<li>Dealing with different data sources</li>
<li>Background jobs</li>
<li>User interfaces and user-facing components</li>
<li>APIs for mobile and other devices</li>
</ul>
<p>It's easy for us to put all these things in a single app at first, but that's not a good solution in the long run. You will start to see issues when your app goes into production. Let’s talk about a few of such issues:</p>
<ul>
<li>Scaling issues ‒ some modules of your app need more resources; others don’t, so when you are scaling, you need to scale the whole app, but not the parts that need to be scaled.</li>
<li>Code management issues ‒ there will be a lot of code, and it'll be harder to manage it.</li>
<li>Access control issues ‒ now everyone on your team has access to whole code base, so it's hard to do proper access control.</li>
</ul>
<h2 id="welcome-to-mircoservices">Welcome to Mircoservices</h2>
<p>A lot of people have tried different solutions. One such solution is microservices. With microservices, you can structure your app as a few different services. Each services runs independently.</p>
<p>These services communicate with each other using APIs (normally with HTTP APIs).  There are service discovery solutions to automatically identify these services, so you don't need to worry about keeping track of where those services deployed to.</p>
<p>By using microservices, we can get rid of most of the issues we've discussed earlier.</p>
<ul>
<li>Now you can scale only services which needs more resources</li>
<li>Code management and access control is simple since you can have separate repositories for each service</li>
</ul>
<p>As a result of this architecture your app will be transformed into a set of tiny services. We called it as cluster of services. All these services are very simple and easy to manage, so you can focus more on your business rather than worrying about the app itself.</p>
<h2 id="meteor-and-ddp-for-microservices">Meteor and DDP for Microservices</h2>
<p>Some people argue that Meteor is monolithic and hard to scale. But actually, as with any other platform, you can build apps monolithically with Meteor, too, so it's not a problem with the framework but with how we architect our app.</p>
<p>Meteor and DDP are a perfect match for microservices. Since DDP is a universal protocol, we can build services in different languages and let them communicate with each other.</p>
<p>In this lesson, we are going to transform a monolithic Meteor app into a distributed set of microservices. Let's get started.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As we discussed, we are going to convert a monolithic app into few different services, so we need an app.</p>
<p>Here it is. It's another version of our Meteor package search app. This time, it's slightly different from previous versions.</p>
<p>Let's have a look at it:</p>
<iframe src="//www.youtube.com/embed/ISVfaTuGafw" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<p>You can clone this app with:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-microservices.git</span>
</code></pre><p>Run this app locally and try to look at the codebase. We are going to work on this app in a moment.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="dividing-an-app-into-services">Dividing an App into Services</h2>
<p>Now our task is to divide our package search app into few different services. There is no right or wrong way to do this. For this app, let's try to divide the app into two services along with the main app:</p>
<ul>
<li>Search service ‒ handles the package search functionality</li>
<li>Logging service ‒ accepts logs and manages them</li>
<li>Main service (Web app) ‒ the main service responsible for the UI logic and integration</li>
</ul>
<blockquote>
<p>We are going to use the term "app" and "service" interchangeably to refer to a service that is a Meteor app.</p>
</blockquote>
<p>These three services are available in the <code>three-services</code> branch of our app. You can get them with:</p>
<pre><code class="hljs nginx"><span class="hljs-title">git</span> checkout three-services
</code></pre><p>All three of these services are Meteor apps running with their own DB. You can run them on any port you like, but if possible, try to run them on the following ports:</p>
<ul>
<li>main ‒ port 6001</li>
<li>search ‒ port 7001</li>
<li>logging ‒ port 8001</li>
</ul>
<p>Then try to access the main app via the browser. You'll get data for "Popular Packages," but you won't get any search results after you've entered the search text. That's because we've not yet integrated search and logging services into our main app.</p>
<p>This is our existing server-side logic in the <code>main</code> app: (server/app.js):</p>
<pre><code class="lang-js hljs javascript">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-keyword">return</span> [];
});

Meteor.publish(<span class="hljs-string">'topPackages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> options = {sort: {isoScore: -<span class="hljs-number">1</span>}, limit: <span class="hljs-number">20</span>};
  <span class="hljs-keyword">return</span> Packages.find({}, options);
});
</code></pre>
<h3 id="service-integration">Service Integration</h3>
<p>As we integrate these services, we don't need to worry much. If you look at the search and logging apps, they have exposed two Meteor methods from their apps, so we are going to connect with these services (via DDP) from the main app and call the methods.</p>
<p>Here are the two methods:</p>
<p><strong>From the search app (port 7001)</strong></p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// server/app.js</span>
Packages = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">'packages'</span>);

Meteor.methods({
  <span class="hljs-string">"getPackages"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
    ...
  }
});
</code></pre>
<p><strong>From the logging app (port 8001)</strong></p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// make this a capped collection to rotate logs</span>
<span class="hljs-keyword">var</span> Logs = <span class="hljs-keyword">new</span> Meteor.Collection(<span class="hljs-string">'logs'</span>);

Meteor.methods({
  <span class="hljs-string">"log"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source, message)</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();
    Logs.insert({ source: source, message: message, time: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"[%s] %s"</span>, source, message);
  }
});
</code></pre>
<p>Connecting to these services is very simple. We just need to make a new DDP connection and call particular methods. First, let's try to implement the logging functionality for the <strong>main</strong> app. This is how we can do it. Put the following content into <code>server/app.js</code> in the <strong>main</strong> app.</p>
<blockquote>
<p>For the searching, we are using a special package called <a target="_blank" href="https://github.com/meteorhacks/search-source">search-source</a>. The following code contains the data source definition for the search source. We talk more about this package in <a target="_blank" href="database-modeling/building-a-real-world-search-app-meteor-package-search">"Building a Real-World Search App"</a> lesson. You can also look for the <a target="_blank" href="https://github.com/meteorhacks/search-source">documentation</a> on GitHub as well.</p>
</blockquote>
<pre><code class="hljs javascript"><span class="hljs-comment">// connecting to the logging service</span>
<span class="hljs-keyword">var</span> logConn = DDP.connect(<span class="hljs-string">"http://localhost:8001"</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">var</span> searchResult = [];

  <span class="hljs-keyword">return</span> searchResult;
});
</code></pre><p>Now, when you are typing some keywords in the search box, some messages will be printed in our logging app. This means that our logging service is working pretty well.</p>
<p>Just like we did above, try to connect to the <code>search</code> service and invoke the <code>getPackages</code> method with <code>searchText</code> and <code>options</code> as the arguments. Then assign the output of the method call to <code>searchResults</code>. After that, you'll be able to search from the UI.</p>
<p>Now, we have a question for you:</p>
<p>Stop the search service (on port 7001) and then try to search some packages. After that, start the search service and try to search some packages. Select your observation from the list below:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      When stopped, the search result box shows "disconnected" text, and when it is restarted, I get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows "searching ..." text, and when it is restarted, I get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows "searching ..." text, and I had to restart the main app to get the search results.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      When stopped, the search result box shows nothing, and when it is restarted, I get the search results.
    </label>
  </div>
  

  
    <p>
      Correct answer is : When stopped, the search result box shows "searching ..." text, and when it is restarted, I get the search results.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>As you've noticed, Meteor will automatically reconnect to a DDP endpoint once it's available again, which is nice.</p>
<hr>
<p>This is the our version of <code>server/app.js</code> in  the main app. It could be slightly different from your implementation.</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// connecting to the logging service</span>
<span class="hljs-keyword">var</span> logConn = DDP.connect(<span class="hljs-string">"http://localhost:8001"</span>);
<span class="hljs-comment">// connecting to the search service</span>
<span class="hljs-keyword">var</span> searchConn = DDP.connect(<span class="hljs-string">"http://localhost:7001"</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution and run in the next event loop</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">var</span> searchResult = searchConn.call(<span class="hljs-string">"getPackages"</span>, searchText, options);
  <span class="hljs-keyword">return</span> searchResult;
});
</code></pre>
<p>This version of the app has a little issue. This means that we need to explicitly mention the URLs of both the "search" and "logging" services inside the main app, so that's a kind of management issue. This gets worse when we are using a lot of microservices.</p>
<h2 id="service-discovery">Service Discovery</h2>
<p>This is where service discovery is going to help us, so what is service discovery? Although it's a fancy name, it does something very simple. Let’s explain this with an example:</p>
<ul>
<li>Let's say that our service discovery solution is called a "cluster."</li>
<li>After the search app is loaded, it registers itself as the "search" and sends its URL to the cluster.</li>
<li>Then, the logging app does the same.</li>
<li>Now, when the main app is loaded, it will ask the URLs of both search and logging apps from the cluster.</li>
<li>The cluster gives the logging apps, and the main app can connect with the services.</li>
</ul>
<p>This is the main idea behind service discovery, though it does a lot more than this. With this, none of the services needs to know about the others. They'll get to know each other through the cluster.</p>
<p><strong>Our issue has just been solved!</strong></p>
<p>Actually, Cluster is the name of a service discovery solution that is available for Meteor. Let's integrate it into our app.</p>
<h4 id="adding-cluster">Adding Cluster</h4>
<p>First, we need to install a package called <a target="_blank" href="https://github.com/meteorhacks/cluster"><code>meteorhacks:cluster</code></a> to all our apps.</p>
<pre><code class="hljs css"><span class="hljs-tag">meteor</span> <span class="hljs-tag">add</span> <span class="hljs-tag">meteorhacks</span><span class="hljs-pseudo">:cluster</span>
</code></pre><p>This cluster solution needs a central data repository. It uses MongoDB for that, so you need to connect to the cluster with a MONGO_URL. Therefore, you have to run your local MongoDB instance.</p>
<blockquote>
<p>If you've not installed MongoDB on your machine yet, use these <a target="_blank" href="http://docs.mongodb.org/manual/installation/">instructions</a>.</p>
</blockquote>
<p>This will be our Mongo URL for the cluster.</p>
<pre><code class="hljs javascript">mongodb:<span class="hljs-comment">//localhost:27017/discovery</span>
</code></pre><h4 id="registering-services">Registering Services</h4>
<p>Now we need to register two services (search and logging) and the main with with the cluster.</p>
<p>Let's see how we can do that for the <strong>search</strong> service.</p>
<p>Add the following code to the top of <code>server/app.js</code> in the <strong>search</strong> app.</p>
<pre><code class="lang-js hljs javascript">Cluster.connect(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"search"</span>);
</code></pre>
<p>Then you need to do the same for the logging service and the main app. For the logging service, register it as "logging". For the main app, register it as "web".</p>
<h4 id="discovering-connections">Discovering Connections</h4>
<p>Now, within the main app, we can simply discover connections by name. Let’s how we can do that:</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-comment">// connecting to the logging app</span>
Cluster.connect(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"web"</span>);
<span class="hljs-keyword">var</span> logConn = Cluster.discoverConnection(<span class="hljs-string">'logging'</span>);
<span class="hljs-keyword">var</span> searchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);

SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// we don't need to wait for completing the log method call</span>
  <span class="hljs-comment">// that's why we defer it's execution and run in the next event loop</span>
  Meteor.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    logConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'main-app'</span>, <span class="hljs-string">"searching for: "</span> + searchText);
  });

  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});

<span class="hljs-comment">// there are some other code beyond this</span>
</code></pre>
<p>Now run these three Meteor apps and try to access the main app, and you'll be able to search packages, and logs will also be printed.</p>
<p>Visit <a target="_blank" href="http://localhost:6001">http://localhost:6001</a> and give it a try.</p>
<hr>
<p>Before we proceed to the next section, let's do an experiment.</p>
<p>Stop the search service. Try to search for some packages on the UI. Of course, you can't search them for sure. Then start our search app on another <strong>port</strong>. Can you search now?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      No. I had to restart the main app.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, but only after 1 minute when the new search service became active.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, but I had to restart the local MongoDB server.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Yes.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As you experienced just now, the beauty of <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> and service discovery is that it knows how to connect to a new service started on a completely different URL, so you don't need to worry about managing URLs anymore.</p>
<p>For high availability, you can also start multiple search service instances, and Cluster picks the next available instance if one instance goes down.</p>
<h2 id="how-cluster-works">How Cluster Works</h2>
<p>There is no magic. Let's explain what's going on here. Let's say that you register a service just like this one:</p>
<pre><code class="hljs perl">Cluster.<span class="hljs-keyword">connect</span>(<span class="hljs-string">"mongodb://localhost:27017/discovery"</span>);
Cluster.register(<span class="hljs-string">"search"</span>);
</code></pre><p>Cluster gets the URL of this app from the <code>ROOT_URL</code> env variable. You can also set a custom URL as follows:</p>
<pre><code class="hljs css"><span class="hljs-tag">Cluster</span><span class="hljs-class">.register</span>("<span class="hljs-tag">search</span>", <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">url</span>:<span class="hljs-value"> <span class="hljs-string">"http://some-other-url"</span> </span></span></span>});
</code></pre><p>Then it will update an entry on a MongoDB collection for every 15 seconds for this service. (The time may vary slightly in a real actual scenario). This will ensure that this service is live and can accept requests.</p>
<p>Then comes the discovery part.</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> searchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
</code></pre>
<p>When you are trying to discover a connection as shown above, it will first give you a proxy DDP connection that is not connected to anywhere. Then, behind the scenes, Cluster will query MongoDB and find a URL for the search service. After that, it creates a DDP connection to the URL and assigns it to the proxy connection.</p>
<p>If the DDP connection goes down, it will query again and try to see if there is a new URL for the service. If it finds a new one, Cluster creates a new connection for that URL and assigns it to the proxy connection.</p>
<p>If you've done any operations in between, they will be cached and applied to the new connection so there won't be any data losses.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="is-this-production-ready-">Is This Production Ready?</h2>
<p>We can't give you 100% guarantee on this, but we use cluster internally at Kadira and we are really happy with it. Kadira has a lot of services doing several tasks. Here are some of them:</p>
<ul>
<li>Data accepting</li>
<li>Data processing</li>
<li>Email scheduling</li>
<li>Alerts</li>
<li>Different background tasks</li>
<li>Analytic services</li>
</ul>
<p>Some of the above services run inside cloud infrastructure we manage. Some services runs on Heroku and Modulus. So, cluster is an universal solution works pretty well for us. So, this should be work for you as well.</p>
<blockquote>
<p>If you got any issues, don't forget to submit an <a target="_blank" href="https://github.com/meteorhacks/cluster/issues">issue</a>.</p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>Service discovery is a hot topic, and there are some other solutions out there. All these solutions have their own pros and cons. We'd like to explain why we decided to go with MongoDB and Cluster for Meteor.</p>
<h3 id="peer-to-peer-discovery-solutions">Peer-to-peer Discovery Solutions</h3>
<p>With these solutions, we don't have a central dependency like MongoDB. Individual services can communicate with each other. <a target="_blank" href="https://serfdom.io/">Serf</a> is one such solution.</p>
<p>But most of the time, these solutions are <a target="_blank" href="https://www.serfdom.io/docs/internals/gossip.html">eventually consistent</a>. This means that all the services in the cluster can know each other eventually, but we cannot guarantee when. Another issue is the bandwidth. Every node in the cluster will get all the messages, including heartbeats, so we'll have to face some issues with that.</p>
<h3 id="consul-etcd-and-zookeeper">Consul, Etcd, and ZooKeeper</h3>
<p>These are some great service discovery solutions. <a target="_blank" href="http://zookeeper.apache.org/">ZooKeeper</a> is the oldest and most famous solution (especially in the Java community), but it's very hard to use and access.</p>
<p>There are some new tools, such as <a target="_blank" href="http://www.consul.io/">Consul</a> and <a target="_blank" href="https://github.com/coreos/etcd">Etcd</a>. These two solutions are comparatively easy to run and access. Both these solutions have HTTP APIs.</p>
<p>With all these solutions, we can register a service, and other services can discover them. But unlike peer-to-peer solutions, we need to run a separate cluster of these solutions. For an example, let’s look at Etcd.</p>
<p>For a production Etcd deployment, we need to run a cluster of 5-9 Etcd nodes. We also need to make sure that a quorum (n/2 + 1) of instances is available every time. Otherwise, Etcd can't function well.</p>
<p>But with these solutions, we can be sure about the consistency. This means that, if you register a service, it will be available to others.</p>
<h3 id="cluster-and-mongodb">Cluster and MongoDB</h3>
<p><a target="_blank" href="https://github.com/meteorhacks/cluster">Cluster</a> is a different solution, and it'll manage DDP connections beyond service discovery. Yes, it’s also a Meteor-specific solution. We could've used a solution like Etcd for the back-end data source, but if we look at it closely, it's very similar to running a MongoDB ReplicaSet.</p>
<p>Since we have experience with MongoDB already, deploying a new ReplicaSet is not a big issue. Even services like <a target="_blank" href="https://www.compose.io/">Compose.io</a> can make it super simple and cheap. That's why we decided to go with MongoDB. But in the future, if we need to, we can easily implement connectors for Etcd and Consul.</p>
<p>Now we have a quick question for you.</p>
<p>What's the main difference between Cluster (with MongoDB) and Etcd.</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      We can use Etcd with Meteor, and it'll discover services for us.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Etcd has an eventual consistency property, and Cluster is fully consistent.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Cluster discovers and manages DDP connections for us. It's fully consistent, too.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Etcd is a peer-to-peer solution, and Cluster depends on MongoDB.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Cluster discovers and manages DDP connections for us. It's fully consistent, too.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices with Meteor and DDP</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-with-meteor-and-ddp">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/2">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/3">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/4">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-with-meteor-and-ddp/6">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-with-meteor-and-ddp/7">
        
          10
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="future-is-here">Future Is Here</h2>
<p>Microservices with DDP are the future of Meteor. We'll be able to write different services and we communicate with each other using DDP. We don't need to write all these services in JavaScript. We’ll be able to write them in any language we like, although we can't do it yet.</p>
<p>Discovery solutions like Cluster will help them to discover each other and make things smoother. We will be able connect to services like MailChimp, SendGrid, and MixPanel just using DDP.</p>
<p>Even though this is something fancy, it could be happened. We also think that this is the vision of the <a target="_blank" href="https://www.meteor.com/people">Meteor Development Group (MDG)</a>.</p>
<p>In the next lesson, we are going dive into microservices, and at the end, you'll be able to manage a production-quality cluster of microservices.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lesson, we learned about microservices and how to use them with Meteor.</p>
<p>But that's the basics. Now we will show you how you can use them in a real app. To summarize, here are the things we are going to cover.</p>
<ul>
<li>Connecting to a service from the client</li>
<li>Using subscriptions and collections with a service</li>
<li>Authenticating a service</li>
<li>Production deployments</li>
</ul>
<p>Let's get started!</p>

  </div>

</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>In this lesson, we are going to use the output from the previous lesson. We've added a few helping functionalities for this lesson. </p>
<p>Let’s clone the following repository:</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-microservices-beyond-basics.git</span>
</code></pre><p>Inside the cloned repo, it has three meteor apps. They are <code>main</code>, <code>search</code>, and <code>logging</code>. Before you start them, you need to run your local mongodb instance. We assume that it's running on the default port, which is port 27017.</p>
<p>After that, simply start the apps in whatever ports you like. Yes, our <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> solution will take care of the communication between them.</p>
<p>Now, you can access the main app from the browser and search for Meteor packages.  :)</p>
<blockquote>
<p>This is a subset of Meteor packages as of January 2015, so it won't have all the packages.</p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="connecting-to-services-from-the-client">Connecting to Services from the Client</h2>
<p>In the current app, even though the search has its own service, we get the search results through our main app. But it'll be great if we could connect to the search service directly from the client and get the data. </p>
<p>Fortunately, Meteor allow us to connect to another DDP server from the client very easily. Here's the API for that. (It's very similar to the API available on the server.)</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> conn = DDP.connect(<span class="hljs-string">"http://another-server.com"</span>);
</code></pre><p>This connection is a DDP connection, and you can invoke all the familiar methods, such as <code>.call</code> and <code>subscribe</code>. If you want to learn more, see the official documentation on <a target="_blank" href="http://docs.meteor.com/#/full/ddp_connect">DDP.connect</a>.</p>
<p><strong>If that’s the case, do we need to keep track of the URLs of individual services?</strong></p>
<p>Yes. That's where our <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster</a> package comes in. Just like you discover a connection on the server, you can do the same for the client as well. </p>
<p>However, by default, the cluster does not allow direct connections to services from the client. But you can explicitly allow them as shown below:</p>
<p>Go to the <strong>main</strong> app and apply the following code right after <code>Cluster.connect()</code> in the <code>server/app.js</code> file.</p>
<pre><code class="hljs javascript">Cluster.allowPublicAccess(<span class="hljs-string">'search'</span>);
</code></pre><p>Now you can create a connection to the search app directly from the client. To try it out, open the main app's browser console and type:</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> conn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
</code></pre><p>Then you can check the connection status by invoking:</p>
<pre><code class="hljs">conn.status();
</code></pre><p>It should have a status indicating "connected." Now you can invoke methods and subscriptions against this connection. </p>
<p>Before we proceed, we've got a little task for you.</p>
<p>There is a method in the search app called <code>getTheMagicNumber</code>. Try to invoke it against the above connection to find the answer. Here's the code you need to apply:</p>
<pre><code class="hljs javascript">conn.call(<span class="hljs-string">'getTheMagicNumber'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, answer)</span> </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">arguments</span>);
});
</code></pre><p>What's the magic number?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      4769
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      3980
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      2760
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      1274
    </label>
  </div>
  

  
    <p>
      Correct answer is : 2760
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="using-client-side-connection">Using Client-Side Connection</h2>
<p>Now we know how to create a connection to a service. Let's learn how to use that connection to get data and invoke methods. (We've already done the method invocation part in the previous step.)</p>
<h3 id="subscribing-to-publications">Subscribing to Publications</h3>
<p>To demonstrate that, we are going to implement a new functionality for our search box. See the following image:</p>
<p><img src="img/CjCRqtMX0j.png" alt="Top Searches"></p>
<p>In this image, we can see the top searches just below the search box. We've already added UI components for this feature in the main app. (Check for the <code>topSearches</code> template.) Now, we need to get the data and create the template helper.</p>
<p>To do that, we first need to subscribe to the <code>topSearches</code> publication in the <code>search</code> service. After it is subscribed to, it sends a few documents to a collection called <code>top-searches</code>. This is one such document.</p>
<pre><code class="hljs css"><span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">_id</span>:<span class="hljs-value"> <span class="hljs-string">"&lt;position based on popularity&gt;"</span>,
  text: <span class="hljs-string">"search term"</span>
</span></span></span>}
</code></pre><p>First, we need to make the connection and create the subscription. To do that, add the following code to <code>client/app.js</code> in the main app.</p>
<pre><code class="hljs javascript">SearchConn = Cluster.discoverConnection(<span class="hljs-string">'search'</span>);
SearchConn.subscribe(<span class="hljs-string">'topSearches'</span>);
</code></pre><p>Now we need to create a collection to store the data we received. This is how you can do it. Add it to the file mentioned above.</p>
<pre><code class="hljs javascript">TopSearches = <span class="hljs-keyword">new</span> Mongo.Collection(<span class="hljs-string">'top-searches'</span>, {connection: SearchConn});
</code></pre><p>Here, we created a collection named <code>top-searches</code>. Additionally, we provided the connection object as the second parameter for the <code>Mongo.Collection</code> constructor. Because we did that, this collection will get data from the <code>SearchConn</code> connection. Otherwise, it would default to the connection at <code>Meteor.connection</code>.</p>
<p>The next step is to create the template helper to get the data. To do that, simply paste the following into <code>client/topSearches.js</code> in the main app.</p>
<pre><code class="hljs javascript">Template.topSearches.helpers({
  <span class="hljs-string">"topSearches"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> TopSearches.find();
  }
});
</code></pre><p>Now, everything is ready. You can see the "top searches" as shown in the following image:</p>
<p><img src="img/CjCRqtMX0j.png" alt="Top Searches"></p>
<h3 id="invoking-methods">Invoking Methods</h3>
<p>Currently, our search functionality is still happening through the main app. We don't need to do it that way. We can use our client-side search connection for that. Currently, we are getting data from the search source definition created on the server side of the <strong>main</strong> app.</p>
<p>It's located at <code>server/app.js</code> in the main app. Here's the code:</p>
<pre><code class="hljs javascript">SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});
</code></pre><p>Let's remove that. After that, you won't be able to search packages. You should get a console error.</p>
<p>We need to fix that. Apply the following code in the <code>client/search.js</code> file of the main app.</p>
<pre><code class="hljs javascript">PackageSearch.fetchData = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options, success)</span> </span>{
  SearchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, data)</span> </span>{
    success(err, data);
  });
};
</code></pre><p>Now we are using Search Source's client-side data definition API. Inside that, we simply call our search connection created on the client and forward the results to the search source.</p>
<p>With this, now you'll be able to search again. To search, now you simply send messages to the search service directly from the client. This is all we wanted.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="authentication-for-services">Authentication for Services</h2>
<p>If the service is only used within the cluster, you don't need to worry much about authentication because your services are not exposed to the public. But when you expose them to the public, you need to worry about it.</p>
<p>Our search service is exposed to the public, so we need to work on some sort of authentication. Right now, there is no built-in feature for this, but we can use Meteor's existing authentication system with a few modifications.</p>
<h3 id="meteor-s-current-authentication-system">Meteor's Current Authentication System</h3>
<p>Meteor basically authenticates its DDP connection at <code>Meteor.connection</code>, so when you are logging into the app, it will check the user credentials and authenticate the connected DDP connection. Just after a valid authentication request, it will add a localStorage entry with the key called <code>Meteor.loginToken</code>.</p>
<p>When you visit the app again sometime later, Meteor uses that local storage entry to authenticate the default DDP connection. With that, you don't have to enter the username and password again.</p>
<h3 id="authenticate-our-search-connection">Authenticate Our Search Connection</h3>
<p>We are trying to use the same loginToken used by the <strong>main</strong> app to authenticate the connection that we made to the <code>search</code> service. If you completed the previous section of this lesson, you can follow with the app you are already working on. Otherwise, check out the following branch.</p>
<pre><code class="hljs nginx"><span class="hljs-title">git</span> checkout client-search
</code></pre><p>This is what we are trying to do:</p>
<ul>
<li>Send the existing login token to the search service.</li>
<li>The search service has a connection to the Web service (to our main app), which does the authentication.</li>
<li>Once the search service receives the loginToken, it will get the <code>userId</code> related to the loginToken from the Web service (using the connection created above).</li>
<li>Then, the search service can indicate that the current DDP connection is authorized for that user ID.</li>
</ul>
<p>Let's implement that.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h3 id="create-a-user-account">Create a User Account</h3>
<p>Before we begin, create a user account in the main app. To do that, open the browser terminal and apply the following:<br>(You can change the user credential as you wish.)</p>
<pre><code class="hljs css"><span class="hljs-tag">Accounts</span><span class="hljs-class">.createUser</span>(<span class="hljs-rules">{<span class="hljs-rule"><span class="hljs-attribute">username</span>:<span class="hljs-value"> <span class="hljs-string">"user"</span>, password: <span class="hljs-string">"password"</span></span></span></span>});
</code></pre><p>You can check the login state by entering the following command:</p>
<pre><code class="hljs">Meteor.user()
</code></pre><h3 id="restrict-access">Restrict Access</h3>
<p>Then let's make our search available only for logged-in users. To do that, open <code>server/app.js</code> of the <strong>search</strong> app and apply the following logic.</p>
<pre><code class="hljs javascript">Meteor.methods({
  <span class="hljs-string">"getPackages"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
    <span class="hljs-keyword">this</span>.unblock();

    <span class="hljs-comment">// If that user is not logged in, he'll get an error</span>
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.userId) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">401</span>, <span class="hljs-string">"Unauthorized"</span>);
    }

    <span class="hljs-comment">// rest of the logic</span>
  }
})
</code></pre><p>Then, if you search locally, you won't be able to see anything.</p>
<h3 id="get-the-userid-for-a-given-logintoken">Get the UserId for a Given LoginToken</h3>
<p>Now, we need to add a special method to the main app that gives the <code>userId</code> if we call that method with the <code>loginToken</code>. Here's the method:</p>
<p>(You’ll need to add this method to the <strong>main</strong> app.)</p>
<pre><code class="lang-js hljs javascript">Meteor.methods({
  <span class="hljs-string">"getUserByToken"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(loginToken)</span> </span>{
    <span class="hljs-keyword">var</span> hashedToken = loginToken &amp;&amp; Accounts._hashLoginToken(loginToken);
    <span class="hljs-keyword">var</span> selector = {<span class="hljs-string">'services.resume.loginTokens.hashedToken'</span>: hashedToken};
    <span class="hljs-keyword">var</span> options = {fields: {_id: <span class="hljs-number">1</span>}};

    <span class="hljs-keyword">var</span> user = Meteor.users.findOne(selector, options);
    <span class="hljs-keyword">return</span> (user)? user._id : <span class="hljs-literal">null</span>;
  }
});
</code></pre>
<h3 id="accept-the-logintoken-and-authenticate">Accept the LoginToken and Authenticate</h3>
<p>Then, we need to create a method in the <strong>search</strong> service that accepts a loginToken and invoke the above method. Here it is:<br>(Add this method to <code>server/app.js</code> in your <strong>search</strong> app.)</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> webConn = Cluster.discoverConnection(<span class="hljs-string">'web'</span>);
Meteor.methods({
  <span class="hljs-string">"authenticate"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(loginToken)</span> </span>{
    <span class="hljs-keyword">var</span> userId = webConn.call(<span class="hljs-string">'getUserByToken'</span>, loginToken);
    <span class="hljs-keyword">this</span>.setUserId(userId);
    <span class="hljs-keyword">return</span> userId;
  }
});
</code></pre>
<p>After it gets the userId from the Web service, it will invoke a special method in the Meteor method context called <code>setUserId()</code> with the userId. This will mark the current DDP connection as authenticated for the given userId.</p>
<h3 id="pick-the-logintoken-from-the-local-storage">Pick the LoginToken from the Local Storage</h3>
<p>Let's do the final part, sending the loginToken after a user visit to the page. To do that, we can use the <code>onReconnect</code> hook in the DDP connection. This hook will be called when the DDP connection is connected or reconnected, so it's a good place to send the login token.</p>
<p>To do that, add the following code to <code>client/app.js</code> in the <strong>main</strong> app:</p>
<pre><code class="hljs javascript">SearchConn.onReconnect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> loginToken = Meteor._localStorage.getItem(<span class="hljs-string">'Meteor.loginToken'</span>);
  <span class="hljs-keyword">this</span>.call(<span class="hljs-string">'authenticate'</span>, loginToken);
};
</code></pre><p>This will get the token from local storage and call the <code>authenticate</code> Meteor method. That's all we have to do.</p>
<p>Then you'll be able to search packages again. Go check it out.</p>
<hr>
<p>Now you have to do a quick task.</p>
<p>Log out of the app by invoking <code>Meteor.logout()</code> from the browser console. After that, can you still search?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-ok text-success"></span>
      
      Yes
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      No
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Yes, you can still search. This is bad because, after you've logged out, the search function should not be functional. Here's the reason and the fix for this.</p>
<p>Even though you've logged out of the main app, you did  not log out of the search service. We can easily fix this by applying the following code to <code>/client/app.js</code> in the <strong>main</strong> app.</p>
<pre><code class="hljs javascript">Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  Meteor.userId();
  SearchConn.onReconnect();
});
</code></pre><p>Here, we watch for changes in <code>Meteor.userId()</code> and invoke the <code>onReconnect</code> function of the search connection. Which does triggers the authentication logic again.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Microservices - Beyond Basics</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/microservices-beyond-basics">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/microservices-beyond-basics/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/5">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/microservices-beyond-basics/6">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/microservices-beyond-basics/7">
        
          20
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="production-deployments">Production Deployments</h2>
<p>Now we've played with cluster and microservices a lot. We’ve covered almost everything. But it's a good idea to watch for cluster <a target="_blank" href="https://github.com/meteorhacks/cluster">documentation</a> as well.</p>
<p>It's time to look at production deployments. You don't need to do a lot, but you have to follow some basic steps.</p>
<h3 id="use-a-mongodb-replicaset">Use a MongoDB ReplicaSet</h3>
<p>We are using MongoDB for the service discovery. You specified a Mongo URL when invoking <code>Cluster.connect</code>. Since it's the heart of the cluster, you should use a MongoDB ReplicaSet. It's does <strong>not</strong> need to have support for oplog.</p>
<p>If you don't have the expertise to run a MongoDB ReplicaSet, try to use <a target="_blank" href="https://www.compose.io/">Compose.io</a>.</p>
<h3 id="use-environment-variables">Use Environment Variables</h3>
<p>In this lesson and the previous lesson, we've invoked cluster APIs inside the Meteor app. In a production deployment, that's a task for a system admin. Invoking Cluster APIs is not a task for the developer, and it should not be hardcoded into the app.</p>
<p>Cluster has a functionality called AutoConfig that allows you to invoke its API via environment variables. Let's see how to use AutoConfig:</p>
<pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.connect(&lt;mongoUrl&gt;);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_DISCOVERY_URL=&lt;mongoUrl&gt;
</code></pre><pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.<span class="hljs-keyword">register</span>(<span class="hljs-string">"web"</span>);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_SERVICE=web
</code></pre><pre><code class="hljs cpp"><span class="hljs-comment">// JS API</span>
Cluster.allowPublicAccess([<span class="hljs-string">"search"</span>, <span class="hljs-string">"logging"</span>]);

<span class="hljs-comment">// AutoConfig API</span>
<span class="hljs-keyword">export</span> CLUSTER_PUBLIC_SERVICES=<span class="hljs-string">"search, logging"</span>
</code></pre><h3 id="expose-endpoint-url">Expose Endpoint URL</h3>
<p>In this lesson, we have used only one instance of a given service. But in a production deployment, we may need to use more instances of a single service for high availability or for scaling purposes. If so, every service instance you start needs to have an environment variable called <code>CLUSTER_ENDPOINT_URL</code>.</p>
<pre><code class="hljs java"># <span class="hljs-function"><span class="hljs-keyword">this</span> is the direct URL to your <span class="hljs-title">server</span> <span class="hljs-params">(it could be a <span class="hljs-keyword">private</span> URL)</span>
export CLUSTER_ENDPOINT_URL</span>=http:<span class="hljs-comment">//ipaddress</span>
</code></pre><h3 id="using-multiple-balancers">Using Multiple Balancers</h3>
<p>Currently in this app, we've used only one instance for the <code>Web</code> service where users are going to access your app. It's also the entry point for your cluster, so having a single entry point is not a good idea since it will cause scalability and high availability issues.</p>
<p>Therefore, we need to run more Web service instances. Even though you are running multiple Web instances, all the connections still go through the instance linked to your domain (via DNS).</p>
<p>Cluster solves this issue with a special type of nodes called "balancers." Balancers can accept DDP connections and route them to a given service. They are exposed to the public. A balancer doesn't need to be a Web service, but using a Web service for that is a good choice.</p>
<p>Creating a balancer is easy. Simply use the following environment variable.</p>
<pre><code class="hljs cpp"><span class="hljs-keyword">export</span> CLUSTER_BALANCER_URL=http:<span class="hljs-comment">//domain-name.com</span>
</code></pre><p>This URL is public, and it should point to the correct balancer instance.</p>
<p>Since the balancer is the entry point for all your services, they should be configured with <code>CLUSTER_PUBLIC_SERVICES</code> as well.</p>
<hr>
<p>These are the things you need to focus on when you are doing a production cluster of microservices. In the next lesson, we'll show you how to setup a highly available Meteor deployment in detail, and then you can learn more about deployments.</p>
<p>Before we end this lesson, we'd like to ask you a question.</p>
<p>From the list below, select the <strong>incorrect</strong> statement.</p>
<hr>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It's a good idea to use a Mongo ReplicaSet for cluster discovery.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      If you are running multiple service instances, use `CLUSTER_ENDPOINT_URL`.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It's also a good idea to run the cluster with just one balancer.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Using AutoConfig APIs is a good choice over the JS APIs.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It's also a good idea to run the cluster with just one balancer.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Running a Meteor app is a pretty simple job. You can use <code>meteor deploy</code>, Meteor Up or Modulus.io to deploy your app. </p>
<p>But running an app with high availability is a different story. We should not confuse high availability with scaling or deployment. With high availability, we are trying to keep our service available to customers all the time. Making your app highly available is your job (or your team's job). You can't delegate that task to someone else; why would you want to? Let's discuss this. </p>
<p>There are many common reasons for applications to fail. Here are some examples:</p>
<ul>
<li>Issues with the deployment provider, </li>
<li>Issues with databases,</li>
<li>Issues with the app itself,</li>
<li>DNS failures, and </li>
<li>Attacks on your system.</li>
</ul>
<p>These issues can arise at any time. So, your job is to mitigate them in order  to make your app highly available. Otherwise you lose customers, and it's hard to get them back. That's why you can't delegate this task to someone else. </p>
<p>In this lesson, we will show you how to build a highly available Meteor cluster. Here are  some of the topics we will discuss:</p>
<ul>
<li>Highly available database setup,</li>
<li>Making your Meteor app highly available,</li>
<li>Configuring DNS,</li>
<li>Monitoring app performance, and</li>
<li>Things to do If something goes down.</li>
</ul>
<p>Let’s get started.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="overview">Overview</h2>
<p>In this lesson we are going to deploy a Meteor cluster with two services. It's a Meteor app that can be used to search packages. Each service is a Meteor app. Here are the two services:</p>
<ul>
<li>web - handles all the user interactions,</li>
<li>search - searches Meteor packages.</li>
</ul>
<p>You can clone the following repository to get the above two services.</p>
<pre><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/bulletproof-meteor/bullet-high-availability.git</span>
</code></pre><p>This is the same application we used for the microservices lessons. To run this app, first start your local MongoDB instance. It's used for the service discovery.</p>
<p>Next, start two meteor services in whatever ports you like. Then you'll be able to search packages from the URL of the web service. To start the app, you need to use a special shell script we've provided. </p>
<p>To do that, navigate to the app from your terminal and apply the following command:</p>
<pre><code class="hljs xml">PORT=<span class="hljs-tag">&lt;<span class="hljs-title">port</span> <span class="hljs-attribute">number</span>&gt;</span> sh .devrun.sh
</code></pre><p>Unlike in other lessons, this time we'll be using a few cloud services for different solutions. There are many cloud services that can be used for any single solution, so it's totally okay if you decide to go with something different than the services we use for this lesson.</p>
<p>For example, we are using Digital Ocean for servers in this lesson. But, you might prefer to use AWS or Google Cloud instead.</p>
<p>You may need to purchase paid plans for some of these services. The experience you get is more valuable than the money you may spend on the services.</p>
<p>You will also need a domain name. I recommend that you purchase a new domain name. We are using <a target="_blank" href="https://www.godaddy.com/">GoDaddy</a> for that. We'll introduce you to other services as we proceed.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="highly-available-mongodb-setup">Highly Available MongoDB Setup</h2>
<p>MongoDB is the core part of our cluster. Since we are running two services, each of them requires a MongoDB database. Depending on your requirements, you could use different databases for each of them. But for our search and web apps, it's okay to use the same database.</p>
<p>We are using <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> to manage and scale our cluster. So, we need a database for that as well. For that, we highly recommend that you use a different database, since this is the core of our cluster.</p>
<h3 id="deploy-the-database">Deploy the database</h3>
<p>For high availability, we need to deploy a MongoDB ReplicaSet. You can deploy it yourself if you have the expertise. But we are not going to cover it in BulletProof Meteor since it's a whole different subject.</p>
<p>If you don't want to deploy MongoDB yourself, there are two main options available to you:</p>
<ol>
<li>Use a cloud service like <a target="_blank" href="https://www.compose.io/">Compose.io</a></li>
<li>Use <a target="_blank" href="https://mms.mongodb.com/">MMS Deployment</a> to deploy a replica set into infrastructure you like.</li>
</ol>
<p>For this lesson, we prefer to use Compose.io to create the replica set. It's very easy to deploy a ReplicaSet this way; you won't need any help at all.</p>
<p>However, we'll still demonstrate how to do it. Check out the following screencast.</p>
<iframe src="https://www.youtube.com/embed/vx6iAFHIUXY" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="making-your-meteor-app-highly-available">Making your Meteor App Highly Available</h2>
<p>Now we are trying to deploy our app. So, the first task is to select a hosting provider. We prefer to go with <a target="_blank" href="https://www.digitalocean.com/">Digital Ocean</a>. But, you can follow this lesson even if you select a provider which has Ubuntu Linux servers.</p>
<h2 id="data-center-selection">Data Center Selection</h2>
<p>For high availability, we need to run our services in multiple data centers. But, if we choose to run it in different data centers, we also need to worry about latency issues between the data centers. </p>
<p>So, we need to select two data centers which are close to each other. For this lesson, we are using instances from NY2 and NY3 data centers of Digital Ocean. If you are using AWS EC2, the servers are located in availability zones. So, choose servers from different availability zones of the same data center.</p>
<blockquote>
<p>It is also very important to use the same datacenter for your MongoDB ReplicaSet as well. Otherwise you will face latency issues. </p>
</blockquote>
<p>This is how we distribute servers between our two services.</p>
<p><strong>web</strong></p>
<ul>
<li>two servers from Ny2</li>
<li>one server from Ny3</li>
</ul>
<p><strong>search</strong></p>
<ul>
<li>one server from Ny2</li>
<li>one server from Ny3</li>
</ul>
<h2 id="server-selection">Server Selection</h2>
<p>It's also very important to select the best possible servers for your app. Meteor, by default, can use only one CPU core. So, it will be wise for you to select servers with only one CPU core.</p>
<p>For Meteor, RAM won't be an issue. It's always the CPU. But try to select an instance with RAM below 2 GB, because NodeJS, where Meteor is based, has issues with RAM over 2 GB.</p>
<h2 id="scaling-and-clustering">Scaling and Clustering</h2>
<p>We use <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> for scaling and managing our cluster. If you've followed the microservices lessons, you might be familiar with the cluster already. It's a way to manage your Meteor cluster and load balance it.</p>
<p>Cluster is a Meteor package and has a discovery backend. Currently, it uses MongoDB as the discovery backend. For that you need to use a separate MongoDB replica set. But it doesn't need to have oplog support and does not need to be in the same data center as the server it's being configured with.</p>
<p>In a cluster, there are special type of nodes called balancers. A balancer accepts requests from the public and delivers them to the correct service instance(Meteor app). So, the balancer acts as the entry point for your cluster. I recommend that you read the <a target="_blank" href="https://github.com/meteorhacks/cluster">cluster documentation</a> for more infomation.</p>
<p>For this setup we are going to use two balancers. We don't need separate servers for that. We can use our existing Meteor services as balancers. This is how you select servers for the balancers:</p>
<ul>
<li>One web service instance from Ny2</li>
<li>One web service instance from Ny3</li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>We use <a target="_blank" href="https://github.com/arunoda/meteor-up">Meteor Up</a> to deploy the app. To do that, first we need to install Meteor Up into our development machine:</p>
<pre><code class="hljs sql">npm <span class="hljs-operator"><span class="hljs-keyword">install</span> -g mup
</span></code></pre><p>Next, create a directory in your machine to store configurations. Inside the directory, create two more directories to store configuration for both web and search services. </p>
<p>Visit each directory and invoke <code>mup init</code> and create the configuration script. Then <a target="_blank" href="https://github.com/arunoda/meteor-up">edit</a> those configuration as described in the section. (The set of video tutorials below demonstrate how to do this.)</p>
<p>The next step is to invoke <code>mup setup</code> to setup servers for each service. Then you can use <code>mup deploy</code> to deploy services.</p>
<p>We've created a set of videos to demonstrate this whole process. Here they are:</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=_Cwqi7KkH3o&amp;feature=youtu.be">Generating SSH keys and registering them with Digital Ocean</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=vNMbEVfTyCM&amp;feature=youtu.be">Creating servers</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=3W5vkXHitnY&amp;feature=youtu.be">Creating Meteor Up configuration files</a></li>
<li><a target="_blank" href="https://gist.github.com/arunoda/955e787534fca64d16a1">Sample configuration files</a></li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=Az_Af6KAmoo&amp;feature=youtu.be">Deploying the cluster with Meteor Up</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="dns-configurations">DNS Configurations</h2>
<p>Now we have a running Meteor cluster and everything works pretty well. But, it's not ready for the public yet. That's because we haven't configured the DNS settings yet.</p>
<p>For this app, we are going to use a domain name called "isopacks.com." We also recommend that you purchase a domain name for the purpose of testing.</p>
<blockquote>
<p>You can use <a target="_blank" href="http://www.fatwallet.com/GoDaddy-coupons">FatWallet</a> to get a coupon for Godaddy. With that, you can purchase a domain for less than three dollars.</p>
</blockquote>
<h3 id="cloudflare">Cloudflare</h3>
<p>We are going to use Cloudflare as our DNS provider for this app. We also use Cloudflare as a CDN and to process SSL. Since we are using Cloudflare for SSL, we need to turn off WebSockets support. (Cloudflare currently supports WebSockets for its enterprise plans only.)</p>
<p>To turn off WebSockets support, you need to expose the following environment variable for both our services. You can add this to the mup.json of both services.</p>
<pre><code class="hljs javascript">{
  <span class="hljs-string">"env"</span>: {
    ... other env vars
    <span class="hljs-string">"DISABLE_WEBSOCKETS"</span>: <span class="hljs-string">"1"</span>
  }
}
</code></pre><h3 id="set-up-nameservers">Set Up Nameservers</h3>
<p>By default, Godaddy is hosting DNS for the domain. Now we need to transfer DNS handling to cloudflare. To do that, go to Cloudflare and add the domain. There will be a wizard to help you, and at end of the wizard it'll show you some nameservers, as shown below:</p>
<p><img src="img/F3m5Czs2Tq.png" alt="Cloudflare Nameservers"></p>
<p>Then you need to visit the GoDaddy domain console and add the above nameservers for your domain.</p>
<p><img src="img/Nez0hWYowr.png" alt="Godaddy Nameservers configuration"></p>
<p>It will take up to 24 hours to complete the setup. But, if you've moved your domain into Cloudflare's Pro plan, it'll be configured in minutes.</p>
<blockquote>
<p>In order to SSL to work properly, you need to change the Cloudflare SSL setting to flexible SSL. <a target="_blank" href="https://www.youtube.com/watch?v=zQMhYuoc6BQ&amp;feature=youtu.be">This is</a> how you can do it.</p>
</blockquote>
<h3 id="dns-setup">DNS Setup</h3>
<p>We need to make sure that our DNS setup is highly available too. That's why we chose Cloudflare. With Cloudflare, we can change our DNS in real time. So, if something goes wrong, we can fix it quickly. Let's setup our DNS.</p>
<p><strong>For Main Domain</strong></p>
<p>We can simply use an <a target="_blank" href="http://support.dnsimple.com/articles/a-record/">"A Record"</a> to point our domain name into an IP Address. Let's do that. In this case, we are using two such IP addresses for high availability. We can use the IP addresses of balancers for that.</p>
<p>If you are using multiple balancers, pick two balancers from different data centers. Since we are only using two balancers for this lesson, we can use both of them. </p>
<p>This is how you can add the A records:</p>
<iframe src="https://www.youtube.com/embed/kdmRx3uvCwI" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<p>Now, "isopacks.com" is our app's ROOT_URL. So, go to the "mup.json" of the web service and expose the <code>ROOT_URL</code> environment variable. You may also need to do <code>mup reconfig</code> to apply it the running app.</p>
<blockquote>
<p>Servers behind the IP address are only responsible for delivering static content and normal HTTP Requests. All the DDP traffic will go through balancers. As traffic to your app increases, you can simply add more balancers to meet the demand.</p>
<p>Cloudflare caches static resources, so your servers won't have issues serving static content.</p>
</blockquote>
<p><strong>Balancers</strong></p>
<p>Now we've set up our DNS for the main app. It's time to configure the DNS for our balancers. To do that, you can simply add two subdomains and point your balancer IP addresses as shown below:</p>
<ul>
<li>one.isopacks.com -&gt; balancer Ip-1</li>
<li>two.isopacks.com -&gt; balancer Ip-2</li>
</ul>
<p>Let's see how to do that:</p>
<iframe src="https://www.youtube.com/embed/7RuCpiVlSoE" allowfullscreen="" width="640" frameborder="0" height="480"></iframe>

<hr>
<p>Now, our DNS setup is complete and we've just deployed and configured a highly available Meteor cluster. Give yourself a pat on the back! :)</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up-monitoring">Setting Up Monitoring</h2>
<p>Even though we've successfully deployed the cluster, we still have some other tasks to do. One such important task is monitoring. </p>
<p>Especially in the cloud environment, anything could go down at any time. Therefore we need to stay alert. Let us show you some ways to do that.</p>
<h3 id="app-monitoring">App Monitoring</h3>
<ul>
<li>Add <a target="_blank" href="https://kadira.io">Kadira</a> to both of your services and use <a target="_blank" href="https://kadira.io/blog/stay-alert-with-your-meteor-app/">Kadira Alerts</a> to check whether your app is running or not.</li>
<li>You can also use <a target="_blank" href="https://www.pingdom.com/">PingDom</a>-like services to see whether your app is accessible to users or not.</li>
</ul>
<h3 id="server-monitoring">Server Monitoring</h3>
<ul>
<li>Sometimes, there might be issues with your hosting service provider. For this reason, it's a good idea to subscribe to their status pages if such pages are available. </li>
<li>This is the status page of Digital Ocean - <a target="_blank" href="https://status.digitalocean.com/">https://status.digitalocean.com/</a>.</li>
<li>These providers are also very active on Twitter. So try follow their Twitter accounts as well.</li>
</ul>
<h3 id="cloudflare-monitoring">Cloudflare Monitoring</h3>
<ul>
<li>Sometimes Cloudflare also goes down and slows down your app. So, you need to watch  Cloudfare’s status pages as well.</li>
</ul>
<h3 id="database-monitoring">Database Monitoring</h3>
<ul>
<li>You can use Kadira to see if there is an issue with the database or not.</li>
<li>Sometimes a database may go down completely or queries might get slower.</li>
<li>It's a good idea to subscribe to the database provider's status page as well.</li>
</ul>
<blockquote>
<p><strong>Make sure not to skip this part when you are doing your actual deployment. Otherwise, you'll be in trouble if something goes wrong.</strong></p>
</blockquote>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="things-to-do-if-your-app-goes-down">Things to Do If Your App Goes Down</h2>
<p>Even though we've tried to deploy everything in a highly available manner, things will break. That's life. You'll learn about this from the previously discussed monitoring channels or from your users.</p>
<p>Let's see what we can do when things go down.</p>
<h3 id="notify-your-users">Notify Your Users</h3>
<p>The first thing you should do is to notify your users. You can do this in a couple of ways:</p>
<ol>
<li>Use your app's official Twitter account.</li>
<li>Use your status page, if you have one.</li>
<li>Email your customers directly.</li>
<li>Use Cloudflare's <a target="_blank" href="https://support.cloudflare.com/hc/en-us/articles/200172706-How-do-I-customize-CloudFlare-error-pages-">custom error pages</a>. In those error pages, if possible, try to get your users’ email addresses. Then, you can still do business with them.</li>
</ol>
<h3 id="if-a-server-goes-down">If a Server Goes Down</h3>
<p>If one of your servers goes down, the cluster will take care of that by routing users to a new server. In the meantime, you need to create a new server and add it to the cluster.</p>
<h3 id="if-a-balancer-goes-down">If a Balancer Goes Down</h3>
<p>If one of your balancers goes down, the cluster will take of that also. But you will need to add a new balancer immediately since, it'd be possible to handle all the traffic with other balancers. </p>
<h3 id="if-a-server-behind-an-a-record-goes-down">If a Server Behind an "A Record" Goes Down</h3>
<p>If a server behind a main domain's A records goes down, you need to react quickly. You can either remove that record or update it with another IP address. Cloudflare does not have a way to do health checks and reconfigure its DNS. So, your app will get routed to a non- functioning server in this situation.</p>
<p>AWS <a target="_blank" href="http://aws.amazon.com/route53/">Route 53</a> has a feature that will do health checks and route DNS traffic accordingly. If you decide to go with that, you need to set up SSL and caching yourself.</p>
<h3 id="if-you-had-a-bug-in-your-app">If You Had a Bug in Your App</h3>
<p>Your app might go down due to a bug in your app. If it does, rollback to a previous version while you fix the issue.</p>
<h3 id="if-your-database-goes-down">If Your Database Goes Down</h3>
<p>If your database goes down, your app won't work properly. If so, try to get a previously known backup from Compose.io and deploy a new database from some other provider.</p>
<p>Then use that DB with your app. It won't have the full state of your DB. Therefore, you might not want to use this approach. If so, using <a target="_blank" href="https://mms.mongodb.com/">MMS</a> to deploy your MongoDB Replica Set is the best approach.</p>
<p>MongoDB MMS also has a continuous backup feature, which allows you to back up every write operation in your DB.</p>
<h3 id="if-cloudflare-goes-down">If Cloudflare Goes Down</h3>
<p>If so, this is very bad. Try to have a backup plan to serve your app without using Cloudflare. Maybe you can transfer the name servers to another DNS provider and manage DNS with them.</p>
<p>You can't do this quickly since it might take some time to propagate DNS changes. But you don't need to worry too much about this. A lot of popular sites, such as Reddit and Meetup, are  served through Cloudflare. So, Cloudflare will do everything possible to bring their service back online.</p>
<p>But, it’s a good idea to have a backup plan.</p>
<h3 id="if-the-mongodb-for-the-cluster-goes-down">If the MongoDB for the Cluster Goes Down</h3>
<p>Then, you don't need worry too much. The cluster caches information about the servers available locally in the server. So, even without the connection to the DB, you app may still work for few hours.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying a Highly Available Meteor Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/1">
        
          5
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/4">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/5">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/6">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-a-highly-available-meteor-cluster/7">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="finally">Finally</h2>
<p>Now we know how to deploy a highly availablle Meteor cluster and what to do if something goes wrong. As we said earlier, you can't delegate this task to some other service or to someone else.</p>
<p>You need to manage it yourself or with your team. Now we think that you have a better understanding of how to do it. Let us know if you have any questions or need more information. (Use the following comments section for that.)</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Load and Stress Testing</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/load-and-stress-testing">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/load-and-stress-testing/1">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>Once you've successfully deployed a Meteor app, next you will want to look at how many users it can handle. That's where load testing comes in. Some developers refer also refer to stress testing also as load testing. But it's different.</p>
<p>Stress testing tells us how our app works under a heavy load. But we don’t know in advance how many users it can handle with stress testing. We usually use stress testing for performance tuning.</p>
<p>Luckily, in most cases we can use the same tools for load and stress testing alike. In this lesson, we'll show you how to stress and load test your Meteor app in few different ways:</p>
<ol>
<li>Poor man's load/stress testing using just a browser</li>
<li>Load/stress testing using Meteor Down</li>
</ol>
<p>We'll also show you how to invoke these tests locally on your machine and how to run them for a running app on the cloud. We'll use Heroku to scale our tests in the cloud.</p>
<p>Contents</p>
<ul>
<li>Difference Between Load Testing and Stress Testing</li>
<li>Browser based Stress Testing</li>
<li>Browser based Load Testing</li>
<li>Stress Testing using Meteor Down</li>
<li>Load Testing using Meteor Down and Kadira</li>
<li>Authenticating users with Meteor Down</li>
<li>Scaling Load Tests</li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Load and Stress Testing</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/load-and-stress-testing">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/load-and-stress-testing/1">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="difference-between-load-testing-and-stress-testing">Difference Between Load Testing and Stress Testing</h2>
<p>Sometimes we talk about load testing and stress testing for the same thing and we are quite not sure about the different. Most of the time, we are using the same tool for both Stress and Load testing; that's the main reason for the confusion. It's very important to identify the difference. Otherwise, how we are doing the tests and it's result won't be the actual result we want. Let's have a look at it.</p>
<h3 id="stress-testing">Stress Testing</h3>
<p>As name implies, with stress testing we are trying to stress the application and improve weak points and bottlenecks in our app. With this, we might be testing one part of the app or a new feature we've added recently.</p>
<p>With this test, we are not going to look at how much of users we can handle. But we'll look at some kind of time related measurement like throughput, relative to a resource related metric like CPU or Memory.</p>
<p>Let's look at an example:</p>
<ul>
<li>We've recently created a new feature to display a leaderboard</li>
<li>We are doing a stress test to find our potential issues in that and optimize</li>
<li>For that we'll be sending stress test to that subscription with 10000 subscriptions per minute (SubRate)</li>
<li>Then we'll look for the CPU usage and trying to optimize that</li>
<li>We can take a CPU profile with Kadira and see what's going on under the hood</li>
</ul>
<p>So, in the above example our intention is to improve the performance of the new feature. Not necessoryly to how much of concurrent requests it can handle.</p>
<blockquote>
<p>With stress test, it doesn't matter what hardware you use of how powerful the system is. Our focus is to reduce the resource metric (CPU usage) with a fixed rate of time related metric. (Throughput)</p>
</blockquote>
<h3 id="load-testing">Load Testing</h3>
<p>Load Testing is very similar to stress testing but we try to see how much of load our app can handle. In this, we are trying to use real hardware and mimic actual usage pattern users are following.</p>
<p>Our goal is to find out how much concurrent users we can handle with the current system. Then we'll trying to scale it by adding more server resources.</p>
<p>With load testing, we are not trying to optimize our code. But we try to see how many concurrent requests/session/clients our can handle.</p>
<p>Let's look at an example app:</p>
<ul>
<li>We've an app deployed into an one AWS EC2 server.</li>
<li>In average, a single user subscribes to 10 subscriptions under one minute.</li>
<li>Average time a user use our app is about 10 minutes</li>
</ul>
<p>So, we'll create a test to model this scenario. Let's say, that's our load test case. Then we'll trying to run multiple such cases concurrently until, server resources maxed out.</p>
<p>Then we try to increase server resources and try to see how our app scale. After that, we can see bottlenecks in our app and we can impove that by doing a stress test and optimizing our app. Then we can do a load test again.</p>
<blockquote>
<p>With load test, we are trying to see how many concurrent actual users/session our app can handle with a given set of servers and other resources</p>
</blockquote>
<hr>
<p>Now we know the difference between load testing and stress testing. Let's start practicing.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lessons, we learned how to use <a target="_blank" href="https://github.com/meteorhacks/cluster">meteorhacks:cluster</a> to scale and manage a cluster of Meteor apps. Because Cluster is just a Meteor package, it can be used with any hosting provider. But we didn't talk much about how to deploy your Meteor apps, especially in the microservices context.</p>
<p>These days, <a target="_blank" href="https://www.docker.com/">Docker</a> is a very popular way to deploy and manage apps. Basically, Docker is a lightweight virtual machine runtime that lets you run Docker images. A Docker image is a snapshot of a running operating system. So it's possible to wrap your running app into a Docker image and distribute.</p>
<p>Then, those images can be run in any <a target="_blank" href="https://docs.docker.com/installation/">environment</a> that is supported by Docker. Most importantly, it's very easy to build and run these images. That's the key selling point of Docker. </p>
<p>Even though Docker is a new project, a lot of new technologies and tools have emerged around that. One such popular technology is <a target="_blank" href="https://coreos.com/">CoreOS</a>. It's a minimal Linux distribution comes with a set of tools to deploy and manage a cluster of containers, including Docker.</p>
<blockquote>
<p>When we run an image, we call the running image a container.</p>
</blockquote>
<p>In this lesson, you will learn about Docker, and we'll show you how to deploy Meteor apps with Docker at the end. We'll talk about CoreOS and using it to manage a cluster of Meteor instances in the next lesson.</p>
<p>These are the topics we are covering:</p>
<ul>
<li>Installing Docker</li>
<li>Understanding Basic concepts (images, containers, etc.)</li>
<li>Running containers in different ways (named, background services, auto-restart)</li>
<li>Building images (with <code>docker commit</code> and <code>docker build</code>)</li>
<li>Managing Ports</li>
<li>Publishing containers and Docker registries</li>
<li>Exploring ways to run Meteor apps with Docker</li>
</ul>
<p>Let's get started!</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>In this lesson, we are going to use some basic Linux commands. Therefore, we expect that you have some experience in using Linux. Sometimes, we need to edit some content inside a server, so you need to know how to edit a file inside a server using emacs, vim, nano, or some other way.</p>
<h3 id="installation">Installation</h3>
<p>Docker can be installed into your Mac or PC without any issues. But Docker needs a Linux environment to operate. Mac and PC versions are employing a Linux virtual machine (using Virtual Box) behind the scenes. You can follow these instructions to install Docker on your development machine:</p>
<ul>
<li><a target="_blank" href="https://docs.docker.com/installation/mac/">Docker for Mac</a></li>
<li><a target="_blank" href="https://docs.docker.com/installation/windows/">Docker for Windows</a></li>
</ul>
<h3 id="use-a-linux-server">Use a Linux Server</h3>
<p>But for this lesson, we highly recommend that you use a real Linux server. We'll be using an Ubuntu 14.04 64-bit server from Digital Ocean. You can pick a server from your favorite cloud infrastructure provider. </p>
<blockquote>
<p>Docker supports many other <a target="_blank" href="https://docs.docker.com/installation/">operating systems</a>, besides Ubuntu. But we prefer to use Ubuntu.</p>
</blockquote>
<p>Once you have a server, installing Docker is pretty simple. Just apply the following command:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">curl</span> -sSL <span class="hljs-url">https://get.docker.com/ubuntu/</span> | sudo sh
</code></pre>
<p>It'll take care of installing Docker into the Ubuntu server. After the installation, you can verify it by running <code>docker info</code>. Then you'll get something like below:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-constant">Containers</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Images</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Storage</span> <span class="hljs-constant">Driver</span><span class="hljs-symbol">:</span> aufs
 <span class="hljs-constant">Root</span> <span class="hljs-constant">Dir</span><span class="hljs-symbol">:</span> /var/lib/docker/aufs
 <span class="hljs-constant">Backing</span> <span class="hljs-constant">Filesystem</span><span class="hljs-symbol">:</span> extfs
 <span class="hljs-constant">Dirs</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>
<span class="hljs-constant">Execution</span> <span class="hljs-constant">Driver</span><span class="hljs-symbol">:</span> native-<span class="hljs-number">0</span>.<span class="hljs-number">2</span>
<span class="hljs-constant">Kernel</span> <span class="hljs-constant">Version</span><span class="hljs-symbol">:</span> <span class="hljs-number">3.13</span>.<span class="hljs-number">0</span>-<span class="hljs-number">43</span>-generic
<span class="hljs-constant">Operating</span> <span class="hljs-constant">System</span><span class="hljs-symbol">:</span> <span class="hljs-constant">Ubuntu</span> <span class="hljs-number">14.04</span>.<span class="hljs-number">1</span> <span class="hljs-constant">LTS</span>
<span class="hljs-constant">CPUs</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>
<span class="hljs-constant">Total</span> <span class="hljs-constant">Memory</span><span class="hljs-symbol">:</span> <span class="hljs-number">490</span> <span class="hljs-constant">MiB</span>
<span class="hljs-constant">Name</span><span class="hljs-symbol">:</span> docker-test
<span class="hljs-constant">ID</span><span class="hljs-symbol">:</span> <span class="hljs-constant">RUVT</span><span class="hljs-symbol">:KK65</span><span class="hljs-symbol">:OVZO</span><span class="hljs-symbol">:VMEH</span><span class="hljs-symbol">:D4QU</span><span class="hljs-symbol">:BG5R</span><span class="hljs-symbol">:</span><span class="hljs-number">5</span><span class="hljs-constant">RIB:</span><span class="hljs-constant">SAG7</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-constant">J4C:</span><span class="hljs-constant">DXGQ</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-constant">WVI:</span><span class="hljs-constant">RYRQ</span>
<span class="hljs-constant">WARNING</span><span class="hljs-symbol">:</span> <span class="hljs-constant">No</span> swap limit support
</code></pre>
<p>Now run this command:</p>
<pre><code class="lang-shell hljs php">docker run ubuntu <span class="hljs-keyword">echo</span> <span class="hljs-string">"docker is nice"</span>
</code></pre>
<p>What did you see on the screen?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It printed "docker is nice" right away.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It asked us to install the Ubuntu image first.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It first downloaded some stuff and then printed "docker is nice".
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It didn't print anything on the server.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It first downloaded some stuff and then printed "docker is nice".
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>As you've experienced, it will first download some content and then print "docker is nice" to the terminal.</p>
<p><img src="img/53bwYQbTDY.png" alt="Docker Hello World"></p>
<p>Let's look at what has happened there.</p>
<h2 id="basic-concepts">Basic Concepts</h2>
<p>This is the command we invoked:</p>
<pre><code class="lang-shell hljs php">docker run ubuntu <span class="hljs-keyword">echo</span> <span class="hljs-string">"docker is nice"</span>
</code></pre>
<p>This command asks Docker to run a Ubuntu Docker image and invoke <code>echo "docker is nice"</code> shell command inside that. Initially, it does not have the image. So it'll first download it. Then, it'll start an Ubuntu container from that images and invoke the <code>echo</code> command. </p>
<p>It does a more than that, but this is the high-level picture.</p>
<h3 id="but-why-we-can-simply-invoke-echo-">But why? We can simply invoke "echo ..."</h3>
<p>This is a very good question. Why can't we simply run <code>echo "docker is nice"</code>? Here's the reason. </p>
<p>When we are running a lot of microservices, they need to run in an isolated environment. Otherwise, we may need to face a lot of security and management issues. </p>
<p>There are a lot of tools you can use to implement these kinds of isolation. But Docker is a very nice and simple way to do that. It can easily run any process (or service) in an isolated environment. Furthermore, it won't add any considerable overhead to the host operating system. That means you can run a lot of isolated microservices inside a single host in a very efficient manner.</p>
<p>If you need to know more about why Docker is important, here are some resources for you.</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=Q5POuMHxW-0">Video: Introduction to Docker</a></li>
<li><a target="_blank" href="http://www.slideshare.net/dotCloud/why-docker">Slides: Why Docker</a></li>
</ul>
<hr>
<p>Okay, let's look at some of the core components of Docker:</p>
<h3 id="docker-image">Docker Image</h3>
<p>Docker image is a read-only snapshot of a running operating system. In our example, <code>ubuntu</code> is our Docker image. But it could be anything, such as another operating system like <code>CentOS</code> or one of your microservices. Anyone can build and publish images. </p>
<h3 id="docker-container">Docker Container</h3>
<p>Docker container is a runnable version of an image. Once a container has started, you can make changes to that. Those changes are saved into the disk but in a very efficient way. You can also stop and restart the containers. If you like, you can build a image from the container and publish it to a Docker registry.</p>
<p>So you can think of an image as a snapshot of a container.</p>
<h3 id="docker-registry">Docker Registry</h3>
<p>Docker Registry is a place that holds a set of images. You can pull images from a registry and publish into that. In the example we tried, we pulled the <code>ubuntu</code> image from Docker's main registry. You can also switch into a different registry or host a registry yourself. We'll talk more about this later.</p>
<h3 id="service-process">Service / Process</h3>
<p>This is the service or process that runs inside the container. It could be anything, and the container or Docker runtime doesn't need to know about that.</p>
<h3 id="docker-server">Docker Server</h3>
<p>Docker server is responsible for all of the hard work of managing images, containers, and other relevant tasks. Docker server gets started when we install it on our server.</p>
<h3 id="docker-client">Docker Client</h3>
<p>Docker client is the command line tool(<code>docker</code>) that lets you interact with the Docker server. It communicates using an API exposed by the Docker server. So it's possible to have more <a target="_blank" href="https://docs.docker.com/reference/api/remote_api_client_libraries/">Docker clients</a> rather than the command line tool.</p>
<hr>
<p>Now we've discussed the basics we need to know. Let's try some Docker.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="using-containers">Using Containers</h2>
<p>Run the following Docker commands:</p>
<pre><code class="lang-shell hljs bash">docker run ubuntu <span class="hljs-built_in">echo</span> <span class="hljs-string">"docker is nice."</span>
docker run ubuntu <span class="hljs-built_in">echo</span> <span class="hljs-string">"kadira.io is nice too."</span>
docker run ubuntu hostname
docker run ubuntu uname <span class="hljs-operator">-a</span>
</code></pre>
<p>You can also get into a container with this command:</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -i -t ubuntu bin/bash
</code></pre><blockquote>
<p>In the above command, we've used some options (<code>-i -t</code>). Those options tell Docker to open an interactive terminal for this container. Otherwise, you won't be able to respond to the <a target="_blank" href="http://en.wikipedia.org/wiki/Standard_streams">"stdin"</a> of the container. You can also write these options like <code>-it</code></p>
</blockquote>
<p>Now let's get back to our host server. (You can apply <code>exit</code> to get out from a Docker container.)</p>
<p><strong>Now run <code>docker ps</code></strong></p>
<p>But you won't see any results. That's because we don't have any running containers. This command prints a list of running Docker containers.</p>
<p><strong>Now run <code>docker ps -a</code></strong>. Then you'll get something like this:</p>
<p><img src="img/465c3od_Pf.png" alt="Stopped Containers"></p>
<p>Now we can see all of the containers we've previously run. Note, it lists all our commands with their status and the container ID. You can use this container ID to reference your container.</p>
<p>For example, you can start (again) a container like this:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-prompt">docker start &lt;container ID&gt;</span>
</code></pre>
<p>But it won't show us anything. That's because the container is running in the background. You can get the output of both <code>stdout</code> and <code>stderr</code> with the <code>logs</code> command:</p>
<pre><code class="lang-shell hljs ruby"><span class="hljs-prompt">docker logs &lt;container ID&gt;</span>
</code></pre>
<h3 id="note">Note</h3>
<p>As you've seen, now every <code>docker run</code> command we invoke creates a new container from the <code>ubuntu</code> image. Any of the actions we apply into the container's filesystem is saved into the disk. But, we haven't done anything like that yet.</p>
<p>Since we've a lot of containers, we may need a bigger disk. Do we?</p>
<p>Actually, we don't need a bigger disk. Docker uses a special file system which only keep changes that happened in the disk. It's very similar to how git works. That's why it can keep a lot of containers without a large disk.</p>
<p>Unfortunately, Docker has no way to clean all of the used containers. But there are some tricks we can use. That's one of the commands from the list below. What is it?</p>
<blockquote>
<p>You can invoke docker -h to see the meaning of these commands and options.</p>
</blockquote>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      docker rm `docker ps --old`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps -ad`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps --used`
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker rm `docker ps -aq`
    </label>
  </div>
  

  
    <p>
      Correct answer is : docker rm `docker ps -aq`
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="background-services">Background Services</h2>
<p>Running a container with a single command or getting into the container is nice. But we need to run services in the background. This is how you can do that with Docker:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>With the above command, we are starting a Docker container in the background by using the <code>-d</code> option. Additionally, we can also label the container as <code>ping-man</code> by using the <code>--name</code> option. By naming a container, we can easily access it. </p>
<p>For example, this is how we can tail logs of this container.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> logs -f ping-man
</code></pre>
<p>Now invoke <code>docker ps</code>, so you can see the running process:</p>
<p><img src="img/KNtRRFBI3w.png" alt="Running Docker Processes"></p>
<p>Let's do a little experiment. Reboot your server with <code>sudo reboot</code>. Then once it has started, try to look for <code>docker ps</code> again. What are your observations?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-ok text-success"></span>
      
      It doesn't show anything.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see our running container.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see the container, but it's paused.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can see the container, but it's locked.
    </label>
  </div>
  

  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="auto-restart">Auto Restart</h2>
<p>By default, Docker does not restart its containers when they get killed or when the host server gets rebooted. Docker has the auto-restart support, but it's disabled by default. This is how to enable that:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--restart=always --name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>Oh! You'll get an error like below:</p>
<p><img src="img/9i4PXoSFtf.png" alt="Need to remove existing named containers"></p>
<p>This means that Docker will not allow us to create a container called <code>ping-man</code> again. So before we invoke the above command, we need to remove the current container with the name <code>ping-man</code>.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> rm ping-man
</code></pre><p>So let's try to run our <code>docker run</code> command again:</p>
<pre><code class="lang-shell hljs sql">docker run -d <span class="hljs-comment">--restart=always --name=ping-man ubuntu ping kadira.io</span>
</code></pre>
<p>This time, it works.</p>
<p>Now, try to reload the server again, and check <code>docker ps</code> after it gets reloaded.</p>
<p>Instead of using <code>--restart:always</code> you can call it <code>--restart:on-failure:10</code>. Then, if the process gets killed because of an error, it will get restarted but only 10 times. Even in this mode, our containers get started when the server gets reloaded.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="building-images">Building Images</h2>
<p>We've played a bit with containers. Now it's time to build a Docker image. To try that out, we are going to build a MongoDB image. For that, let's create a container inherited from the <code>ubuntu</code> base image and get into that.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t ubuntu /bin/bash
</code></pre>
<p>Then paste the following commands to the container's shell one by one. It will install MongoDB to the path <code>/mongodb</code>.</p>
<pre><code class="hljs sql">apt-get <span class="hljs-operator"><span class="hljs-keyword">update</span> -y
apt-<span class="hljs-keyword">get</span> <span class="hljs-keyword">install</span> wget -y
<span class="hljs-keyword">VERSION</span>=<span class="hljs-number">2.6</span><span class="hljs-number">.7</span>
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span>.tgz -O mongodb.tar.gz
tar xzf mongodb.tar.gz
mv mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span> /mongodb
rm mongodb.tar.gz
mkdir -p /<span class="hljs-keyword">data</span>/db
</span></code></pre><p>Now, exit this container. Then you can create an image from this container like the one below:</p>
<pre><code class="hljs sql"> docker <span class="hljs-operator"><span class="hljs-keyword">commit</span> <span class="hljs-string">`docker ps -lq`</span> arunoda/mongo-base
</span></code></pre><p>With that, we've create an image called <code>arunoda/mongo-base</code>. You can replace <code>arunoda</code> with your name :). </p>
<p><code>docker ps -lq</code> will gives us the last used container id.</p>
<p>Now we can run a container using the image we've just built:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base /mongodb/bin/mongod
</code></pre>
<h3 id="let-s-add-a-start-script">Let's add a start script</h3>
<p>Now let's add a start script to this image. With that, we don't need to specify the MongoDB binary when starting the container. </p>
<p>First, let's get into the <code>arunoda/mongo-base</code> like this.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base /bin/bash
</code></pre>
<p>Then apply the following commands. (It'll create a filename called <code>start.sh</code> in the root of the file system.)</p>
<pre><code class="lang-shell hljs php"><span class="hljs-keyword">echo</span> <span class="hljs-string">'#!/bin/bash'</span> &gt; /start.sh
<span class="hljs-keyword">echo</span> <span class="hljs-string">'/mongodb/bin/mongod'</span> &gt;&gt; /start.sh
chmod +x /start.sh
</code></pre>
<p>After that, let's commit the image again.</p>
<pre><code class="hljs sql">docker <span class="hljs-operator"><span class="hljs-keyword">commit</span> <span class="hljs-string">`docker ps -lq`</span> arunoda/mongo-base
</span></code></pre><p>Now we can run the container as:</p>
<pre><code class="hljs sql">docker run -i -t arunoda/mongo-base /<span class="hljs-operator"><span class="hljs-keyword">start</span>.sh
</span></code></pre><p>So, now you get the idea. Here's the whole process we can use to build Docker images.</p>
<ol>
<li>Create a container from a base image (in our case, Ubuntu is the base image)</li>
<li>Make some changes to the container (add some software or your app).</li>
<li>Commit and create an image.</li>
<li>Start again from the created image.</li>
<li>Add some changes.</li>
<li>Commit and create an image.</li>
<li>Go to step 4.</li>
</ol>
<hr>
<p>Now, we've got a little question for you.</p>
<p>If we need to run the image we've built as a background service, how we could do it?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      docker run -d --restart=always arunoda/mongo-base
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run --restart=always arunoda/mongo-base /start.sh
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run -d --restart=onstart arunoda/mongo-base /start.sh
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      docker run -d --restart=always arunoda/mongo-base /start.sh
    </label>
  </div>
  

  
    <p>
      Correct answer is : docker run -d --restart=always arunoda/mongo-base /start.sh
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <p>It seems like creating an image is not a simple task and it involves a lot of steps. Most importantly, it's hard to automate that task.</p>
<h2 id="using-a-dockerfile">Using a Dockerfile</h2>
<p>But there is an easy way to build Docker images. That's using a <code>Dockerfile</code> and using <code>docker build</code>. Dockerfile is something similar to a shell script, but it automates the image creation task. </p>
<p>Let's recreate the previously created image using a Dockerfile.</p>
<p>First, create a directory in the host server. Let's say it's <code>mongo-base2</code>. Then create a file called <code>install-mongodb.sh</code> and put this content.</p>
<pre><code class="hljs sql">apt-get <span class="hljs-operator"><span class="hljs-keyword">update</span> -y
apt-<span class="hljs-keyword">get</span> <span class="hljs-keyword">install</span> wget -y
<span class="hljs-keyword">VERSION</span>=<span class="hljs-number">2.6</span><span class="hljs-number">.7</span>
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span>.tgz -O mongodb.tar.gz
tar xzf mongodb.tar.gz
mv mongodb-linux-x86_64-$<span class="hljs-keyword">VERSION</span> /mongodb
rm mongodb.tar.gz
mkdir -p /<span class="hljs-keyword">data</span>/db
</span></code></pre><p>Then create another file called <code>Dockerfile</code> with the following content.</p>
<pre><code class="lang-shell hljs sql">FROM ubuntu
MAINTAINER Arunoda Susiripala - #<span class="hljs-operator"><span class="hljs-keyword">Replace</span> <span class="hljs-keyword">with</span> your name

# <span class="hljs-keyword">install</span> mongodb
COPY <span class="hljs-keyword">install</span>-mongodb.sh /tmp/<span class="hljs-keyword">install</span>-mongodb.sh
RUN /<span class="hljs-keyword">bin</span>/bash /tmp/<span class="hljs-keyword">install</span>-mongodb.sh

ENTRYPOINT /mongodb/<span class="hljs-keyword">bin</span>/mongod
</span></code></pre>
<p>In the above file, we've used few Dockerfile commands. Let's look at them:</p>
<ul>
<li>FROM - specify the base image.</li>
<li>MAINTAINER - mention who is managing this image. This is purely for bookkeeping purposes.</li>
<li>COPY - copy a file or directory from the host system into the container.</li>
<li>RUN - invoke a shell command inside container.</li>
<li>ENTRYPOINT - the first command to run when the container gets started (from the image)</li>
</ul>
<blockquote>
<p>There are a few <a target="_blank" href="https://docs.docker.com/reference/builder/">more commands</a> available, and we can use them to build complex images.</p>
</blockquote>
<p>Now everything is ready. Let's build the image with <code>docker build</code></p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> build -t arunoda/mongo-base2 .
</code></pre><p>With <code>-t</code>, we give the name for the image, and <code>.</code> at the end tells which directory to use as the source directory (context) for <code>docker build</code>.</p>
<p>This way, if we need to change something, we can easily do it by editing the Dockerfile or a script we've used. Then simply invoke <code>docker build</code> to build the image again.</p>
<h3 id="running-the-image">Running the image</h3>
<p>Unlike the image we built with <code>docker commit</code>, this time we don't need to specify the start command when running the container. That's because we've defined it when creating the image via the <code>ENTRYPOINT</code> command. So this is all we have to do.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -i -t arunoda/mongo-base2
</code></pre><blockquote>
<p>It's also possible to override the default entry point. Here's how to do it.</p>
<pre><code class="hljs javascript">docker run -i -t --entrypoint=<span class="hljs-regexp">/bin/</span>bash arunoda/mongo-base2
</code></pre></blockquote>
<hr>
<p>We've mentioned that there are some <a target="_blank" href="https://docs.docker.com/reference/builder/">other commands</a> we can use inside a Dockerfile. "ADD" is a one such command. So what's the difference between "ADD" and "COPY"?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      There is no difference. "ADD" is for backward compatibility
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports remote urls
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports wildcard file matching
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      "ADD" supports multiple directories at once
    </label>
  </div>
  

  
    <p>
      Correct answer is : "ADD" supports remote urls
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="port-management">Port Management</h2>
<p>Now we've run a few containers and built our own image. But we need to allow other systems to access the running containers. To do that, we need to map ports inside the containers to the outside.</p>
<p>For example, in our MongoDB image, MongoDB is started and bound to the port  27017 (it's the default port of MongoDB) inside the container. So we need to map it to the port 12021 of our host server. Then, other applications can use it. Let's do it.</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -d -p <span class="hljs-number">12021</span>:<span class="hljs-number">27017</span> arunoda/mongo-base2
</code></pre><p>Now when you run <code>docker inspect &lt;container-id&gt;</code> you'll be able to see the port mapping. </p>
<p>You can also check the port mapping yourself. Simply try to connect to the MongoDB container using a mongo shell from anywhere.</p>
<pre><code class="hljs ruby"><span class="hljs-prompt">mongo &lt;ip-of-the-server&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">12021</span>
</code></pre><h3 id="linking-containers">Linking Containers</h3>
<p>It's <a target="_blank" href="https://docs.docker.com/articles/dockerfile_best-practices/">recommended</a> to run just a single process inside a container. For example, let's say we need to run a Meteor app and use nginx for serving SSL. </p>
<p>In this case, we can run those two services inside a single container. That's possible. </p>
<p>But the best and the recommended way is to run them separately. When running the SSL container, just ask it to link with the Meteor container.</p>
<p>The SSL container knows the internal IP address/port of the Meteor container, and it can do its job. Linking is very similar to mapping ports, just within the docker containers.</p>
<p>Follow <a target="_blank" href="https://docs.docker.com/userguide/dockerlinks/">this guide</a> to learn about linking containers.</p>
<hr>
<p>Now it's time for a simple question. </p>
<p>What will happen when you try to map a port that is already mapped to a port of another container? Just run <code>docker run -d -p 12021:27017 arunoda/mongo-base2</code> another time to experience that.</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      It'll throw an error, but the container will get started.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll throw an error, and the container won’t start.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll work.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      It'll work, but the previous container will have stopped.
    </label>
  </div>
  

  
    <p>
      Correct answer is : It'll throw an error, and the container won’t start.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="publishing-containers">Publishing Containers</h2>
<p>So you've built an image. Congrats. Why don't you share it with others? </p>
<p>That's where the <a target="_blank" href="https://registry.hub.docker.com/">Docker Registry</a> comes in. </p>
<p>It's a place to share and discover images. We've used <code>ubuntu</code> as our base image. That's also pulled from this repository. </p>
<p>Publishing your image is pretty simple. Just type:</p>
<pre><code class="hljs perl">docker <span class="hljs-keyword">push</span> arunoda/mongo-base2
</code></pre><p>So first, it'll ask to create an account or login to your existing account. You can choose a username you like. But your image should be named with the format of <code>&lt;your username&gt;/mongo-base2</code>.</p>
<h3 id="let-s-pull-an-image">Let's pull an image</h3>
<p>Now we've pushed an image. Let's pull that image to verify that it has moved to the registry. </p>
<p>First remove all of our containers and images:</p>
<pre><code class="hljs perl">docker rm -f <span class="hljs-string">`docker ps -aq`</span>
docker rmi -f <span class="hljs-string">`docker images -q`</span>
</code></pre><blockquote>
<p>These commands will remove everything related to Docker except the runtime. So think twice before you apply above on a production system.</p>
</blockquote>
<p>Then let's run our image:</p>
<pre><code class="hljs nginx"><span class="hljs-title">docker</span> run -d -p <span class="hljs-number">12021</span>:<span class="hljs-number">27017</span> arunoda/mongo-base2
</code></pre><p>Next, it'll pull <code>arunoda/mongo-base2</code> from the registry and run it. You can also just pull the image with <code>docker pull arunoda/mongo-base2</code>.</p>
<p>There are a lot of things you can do with Docker registries and Docker Hub. Refer to the following links:</p>
<ul>
<li><a target="_blank" href="http://docs.docker.com/docker-hub/builds/">Automated builds on Docker Hub</a></li>
<li><a target="_blank" href="https://docs.docker.com/docker-hub/repos/#private-repositories">Docker Hub's private Docker registry</a></li>
<li><a target="_blank" href="http://docs.quay.io/solution/getting-started.html">Quay.io - another Docker registry</a></li>
<li><a target="_blank" href="http://www.activestate.com/blog/2014/01/deploying-your-own-private-docker-registry">Run a Docker registry yourself</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="using-meteor-with-docker">Using Meteor with Docker</h2>
<p>Now you have a pretty solid idea on how to use Docker. Then, let's try to learn how to run Meteor with Docker. </p>
<p>Basically, there are two ways we can do this:</p>
<ol>
<li>Build a Docker image for your app. Just pull the image and run it.</li>
<li>Give a Meteor bundle to a Docker image and it'll run the bundle.</li>
</ol>
<p>Let's look at both of these solutions.</p>
<h3 id="1-build-a-docker-image-for-your-app">1. Build a Docker image for your app</h3>
<p>We can simply build an image for a Meteor app. In that process, we need to create a bundle from the app and make it runnable. </p>
<p>With your current Docker knowledge, you can start working on that scratch. But we've got a better way to do it. We've created a Docker image called <a target="_blank" href="https://github.com/meteorhacks/meteord">meteorhacks/meteord</a> to make your life easier. </p>
<p>Let's see how we can use it.</p>
<p>First create a Meteor app on our server. (You may need to <a target="_blank" href="http://docs.meteor.com/#/full/">install</a> Meteor on the server.)</p>
<p>Then put this Dockerfile in the root of your app.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">FROM</span> meteorhacks/meteord
MAINTAINER Your Name
</code></pre>
<p>After that, invoke <code>docker build -t arunoda/demoapp .</code> </p>
<p>This will create a Docker image, and we can run it with:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    arunoda/demoapp
</code></pre>
<p>Now, your app will run on port 80 inside the container, and it's mapped to the port 8080 of the host server.</p>
<p>You can automate this process and build a container for every git push with <a target="_blank" href="http://docs.docker.com/docker-hub/builds/">automated builds</a> feature in Docker Hub.</p>
<h3 id="2-run-a-meteor-bundle">2. Run a Meteor bundle</h3>
<p>Sometimes, it's a better idea to run the Meteor bundle itself. For that, you can also use MeteorD. </p>
<p>Let's say you've uploaded the bundle (tar.gz file) to AWS S3, and you can get a direct URL for that. Here's how to run that bundle using Docker.</p>
<blockquote>
<p>Make sure to build the bundle for <code>os.linux.x86_64</code> architecture.</p>
</blockquote>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -e BUNDLE_URL=<span class="hljs-url">http://mybundle_url_at_s3.tar.gz</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    meteorhacks/meteord
</code></pre>
<p>If you have the bundle in the host server, you can directly run that, too. Here, we are using Docker's <a target="_blank" href="https://docs.docker.com/userguide/dockervolumes/">volume mounting</a> feature. With volume mounting, we can expose a directory inside our host server into the container. </p>
<p>Now, let's place the Meteor bundle into a directory called <code>/tmp/data</code> in our host system. There is a Meteor bundle called <code>myapp.tar.gz</code> inside that. The name of the bundle could be anything, but it needs to have the <code>tar.gz</code> extension. This is how to generate a Meteor bundle:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-comment"># go to your project root and apply following</span>
<span class="hljs-title">meteor</span> build --architecture=os.linux.x86_64 /tmp/data
</code></pre>
<p>To run this bundle with MeteorD, just apply the following command<br>(focus your attention on the <code>-v</code> option):</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">docker</span> run -d \
    -e ROOT_URL=<span class="hljs-url">http://yourapp.com</span> \
    -e MONGO_URL=<span class="hljs-url">mongodb://url</span> \
    -e MONGO_OPLOG_URL=<span class="hljs-url">mongodb://oplog_url</span> \
    -v /tmp/<span class="hljs-url">data:/bundle</span> \
    -p <span class="hljs-number">8080</span>:<span class="hljs-number">80</span> \
    meteorhacks/meteord
</code></pre>
<p>Besides these, there are a few more things you can do with <a target="_blank" href="https://github.com/meteorhacks/meteord">MeteorD</a>. Check out the <a target="_blank" href="https://github.com/meteorhacks/meteord">documentation</a> for that.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Using Meteor with Docker</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/docker-and-meteor">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/5">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/6">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/7">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/docker-and-meteor/8">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/9">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/docker-and-meteor/10">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/docker-and-meteor/11">
        
          5
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <p>Now, you have gained enough knowledge to manage a Docker deployment. But you need to learn more. With this knowledge, you can dive into Docker yourself. Here are some links for you: </p>
<ul>
<li><a target="_blank" href="http://docs.docker.com/">Docker documentation</a></li>
<li><a target="_blank" href="http://blog.docker.com/">Docker blog - for news and the latest updates</a></li>
<li><a target="_blank" href="http://www.dockerbook.com/">Docker Book</a></li>
</ul>
<p>We also have another lesson on CoreOS and clustering with Docker. We will learn more about Docker in that lesson, too.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>In the previous lesson, we learned about <a href="https://www.docker.com/">Docker</a> and how to deploy Meteor apps with Docker. But, Docker is just a runtime and it does not tell you how to manage a cluster of Docker containers.</p>
<p>So, we need to use some other tools to manage a cluster. Here are some of the tools you can use:</p>
<ul>
<li><a href="https://coreos.com/">CoreOS</a> and <a href="https://github.com/coreos/fleet">Fleet</a></li>
<li>Chef, Salt, Ansible like Ops tools</li>
<li><a href="http://kubernetes.io/">Google's Kubernetes</a></li>
<li><a href="http://deis.io/">Deis - a PAAS</a></li>
<li><a href="https://github.com/docker/swarm/">Docker Swarm</a></li>
</ul>
<p>In this lesson, we'll look at Google's Kubernetes. We chose Kubernetes because it provides a declarative interface to interact with a cluster of nodes. We think Kubernetes is the future of cloud hosting. We also hope major cloud service providers will support Kubernetes natively in the near future.</p>
<p>In this lesson, we are <strong>not</strong> going learn in depth about installing and setting up Kubernetes. Instead, we'll look at how to use the features of Kubernetes. We will use <a href="https://github.com/meteorhacks/kube-init">kube-init</a> to deploy a testing cluster for learning purposes.</p>
<p>After you've had a good working experience with Kubernetes, you can deploy it on <a href="https://github.com/GoogleCloudPlatform/kubernetes/tree/master/docs/getting-started-guides">your own</a> or use a service like <a href="https://tectonic.com/">TecTonic</a>.</p>
<p>Here are the list of topics we will cover in this lesson:</p>
<ul>
<li>Introduction to Kubernetes</li>
<li>Deploying and Testing a Kubernetes Cluster</li>
<li>Deploying the Telescope App (as a Pod) into the Cluster</li>
<li>Using a Replication Controller for High Availability and Scalability</li>
<li>Changing Replicas</li>
<li>Load-Balancing Pods using Kubernetes Services</li>
<li>Deploying Our Own MongoDB Service</li>
<li>Deploying a New Version of the app with Rolling Update</li>
<li>Microservices with Kubernetes</li>
</ul>
<p>Let's Get Started!</p>

  </div>

  
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="introduction-to-kubernetes">Introduction to Kubernetes</h2>
<p>So, what is Kubernetes? If you haven't heard of it before, it's Google's answer to manage a set of containers (or simply a cluster). Kubernetes is not the only solution in this space. <a target="_blank" href="https://mesosphere.com/">Mesosphere</a> and <a target="_blank" href="https://github.com/docker/swarm">Docker Swarm</a> are some other solutions. But Kubernetes is different, because it provides a declarative but highly configurable interface to manage the cluster. You simply need to tell it what you need to do, then Kubernetes will do the hard work.</p>
<p>Before we start, let's look at what Kubernetes is. Some of these may seem bit difficult to understand. But don't worry. we'll practice each of these throughout the lesson.</p>
<h3 id="components-of-kubernetes">Components of Kubernetes</h3>
<p><img src="img/YgsLg7gM2L.png" alt="Components of Kubernetes"></p>
<h4 id="kubernetes-master">Kubernetes Master</h4>
<p>Kubernetes Master controls the overall cluster and runs the API for the cluster. Basically, it will take care of everything in the cluster.</p>
<h4 id="node">Node</h4>
<p>A node is a physical server (or a VM) inside the cluster. It will communicate with the master and run containers (actually pods). You can add and remove any number of nodes you like.</p>
<h4 id="pod">Pod</h4>
<p>The pod is the basic building block of Kubernetes. Inside a pod, you can run a set of containers. Most of the time, we only need to run one container. We can allocate CPU, memory, volumes, and other resources to a pod. So, all the containers inside the pod can share them. Kubernetes also assigns a unique network namespace to each pod. Thus, you don't need to worry about conflicting pods because every pod has its own IP address and a hostname.</p>
<p>You can simply ask Kubernetes to run a pod. But you don't normally want to do that. We'll use a replication controller for that.</p>
<h4 id="replication-controller">Replication Controller</h4>
<p>Even though the pod is very powerful, it can't handle failures itself. Let's say the node (server) running our pod crashes. Then our pod will be removed from the cluster. But this is not the behavior we want. Failures are inevitable, but even in that situation, we need to provide service to our customers. That's what replication controller is for.</p>
<p>It watches the cluster and ensures that a given number of pods will be running in the cluster every time. It can launch new pods and remove existing pods. We can also change the number of pods assigned to a replication controller.</p>
<p>In order to this to function, we need to define our pod as a template inside the replication controller. We'll learn how to do that in a moment.</p>
<h4 id="service">Service</h4>
<p>We know that pods get added and removed. So we need a way to load-balance our traffic into these pods. Service is the solution for that. It can act as a dynamic load balancer for a set of pods. It's very efficient as it tries to use IP tables and other techniques to avoid the load-balancing overhead.</p>
<p>Service can also support basic sticky session support. So, we can run Meteor apps without issues inside a Kubernetes cluster.</p>
<p>Additionally, we can access these services via DNS within each pod inside the cluster, essentially acting as a backbone for micro-services. We'll also talk more about this later in the lesson.</p>
<p>There is a lot more we need to know about Kubernetes. We'll learn them while we are practicing.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="setting-up">Setting Up</h2>
<p>Kubernetes does a lot of work for us, but it's quite difficult to install a Kubernetes cluster our own. So, for learning purposes, we'll deploy a Kubernetes cluster inside a single machine.</p>
<p>With that, we can learn how to use Kubernetes without spending a lot of time to configure and deploy a real cluster. At the end of the lesson, we'll show you few options to deploy a real cluster.</p>
<h3 id="setting-up-the-cluster">Setting Up the Cluster</h3>
<p>First, you need a <strong>Ubuntu 64 bit</strong> server. It could be a cloud VM or a vagrant box. Try to select a somewhat large VM because we'll be running a few processes inside this server. </p>
<p>Then we are going to use <a target="_blank" href="https://github.com/meteorhacks/kube-init">kube-init</a> to deploy a Kubernetes cluster inside that.</p>
<p>After you've created the server, SSH into that by applying following command:</p>
<pre><code class="hljs nginx"><span class="hljs-title">wget</span> -qO- <span class="hljs-url">http://git.io/veKlu</span> | sudo sh
</code></pre><p>It will install both the Kubernetes master and a node inside a single server.</p>
<p>When you apply the <code>kubectl get nodes</code> command, you should get an output like this:</p>
<p><img src="img/oCrLC6fr9K.png" alt="Kubernetes get node"></p>
<p>It shows the only node in our cluster, which is the current server.</p>
<h3 id="accessing-the-kubernetes-network">Accessing the Kubernetes Network</h3>
<p>Kubernetes create its own network inside the cluster. Each pod and service gets its own IP address. So, it would be great if we could access those IPs from our local machine. Let's do it.</p>
<p>First, you need to create a SOCKS Proxy with your server. For that, simply apply the following command in a separate terminal.</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">ssh</span> -D <span class="hljs-number">8082</span> your-user<span class="hljs-variable">@your</span>-server-ip
</code></pre>
<p>This command will log you into the server. Also, it will create a SOCKS proxy on "localhost" on port "8082".</p>
<p>Then we need to configure our browser for the SOCKS proxy we've just created. We'll show you how to do it for both Chrome and Firefox on a Mac. Instructions for Linux or Windows are the same.</p>
<ul>
<li><a target="_blank" href="https://www.youtube.com/watch?v=QPSYy0vZjw4&amp;feature=youtu.be">For Firefox</a> - (Recommended - This will add proxy only to Firefox)</li>
<li><a target="_blank" href="https://www.youtube.com/watch?v=ASugh1lSmps&amp;feature=youtu.be">For Chrome</a> - (this will add the proxy to your whole machine)</li>
</ul>
<p>Now you can access the network inside your server locally using your browser. Also, if you try to access the Internet, all the requests will proxy through your server. Visit <a target="_blank" href="https://www.whatismyip.com/">website</a> and you can verify that your IP is the server's IP.</p>
<h3 id="editing-files">Editing Files</h3>
<p>We are accessing Kubernetes cluster with the "kubectl" command installed on the server. So, you need to create and edit files inside the server. For that, you can use <a target="_blank" href="http://en.wikipedia.org/wiki/Vim_%28text_editor%29">vim</a>, <a target="_blank" href="http://en.wikipedia.org/wiki/GNU_nano">nano</a> or something like <a target="_blank" href="http://en.wikipedia.org/wiki/Rsync">rsync</a>.</p>
<p>Now we are ready. Let's start playing with Kubernetes.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="deploying-telescope-a-pod-into-the-cluster">Deploying Telescope (a Pod) into the Cluster</h2>
<p>Now let's a deploy our first pod into the cluster. For that we need to create a simple JSON file. </p>
<p>Add following content into a filename called <code>telescope-pod.json</code>.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-pod"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Pod"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
        "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
        "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
        "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
          "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
        </span>}]
      </span>},
      {
        "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
        "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
        "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
          "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
        </span>}]</span>,
        "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
          {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
          {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://localhost:27017/app"</span></span>}
        ]
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>This file may seem a bit complex, but it's not. Basically, this file defines a pod with the name <code>telescope-pod.</code> We have defined two containers inside this pod, a mongo container and a telescope container.</p>
<p>This pod is a fully functioning <a target="_blank" href="http://www.telescopeapp.org/">Telescope</a> app. </p>
<p>In the mongo container, we specify that its port is 27017. Then we've added a few options to make sure that MongoDB starts very quickly without doing any initial data allocation.</p>
<p>Then in the telescope container, we specify that it is using port 80 and provide some usual Meteor specific environment variables to it: <code>ROOT_URL</code> and <code>MONGO_URL</code>. But, first take a look at the value of <code>MONGO_URL</code>. It's something like this:</p>
<pre><code class="hljs javascript">MONGO_URL=mongodb:<span class="hljs-comment">//localhost:27017/app</span>
</code></pre><p>Normally, it's not possible to access the port of other containers within a container. But in this case, we could be able access MongoDB within the telescope container. That's because all the containers in a pod shares a single network namespace.</p>
<h3 id="creating-the-pod">Creating the Pod</h3>
<p>Now that we know how pod definition works, let's create a pod. Simply run following command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-pod.json
</span></code></pre>
<p>This will create a pod in the cluster. You can verify that by entering following command, which give you a list of pods in the cluster:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">kubectl</span> get pod
</code></pre>
<p>First, it will show the pod's state as "Pending". That's because Kubernetes downloads Docker images and does some initialization. Within few minutes you'll be able to see its state as "Running".</p>
<p>You can check also check the logs of the each container by entering following commands:</p>
<pre><code class="lang-shell hljs perl">kubectl <span class="hljs-keyword">log</span> telescope-pod mongo
kubectl <span class="hljs-keyword">log</span> telescope-pod telescope
</code></pre>
<p>Okay, now we know our telescope instance is running, but how can we access it? Let's describe our pod by running this command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">describe</span> pod telescope-pod
</span></code></pre>
<p>Then we'll get something like this:</p>
<p><img src="img/sgdxGhcrr5.png" alt="Kubernetes Pod Info"></p>
<p>Then you can see that our pod has its own IP address. Now try to access that IP from the browser configured with the SOCKS Proxy. You'll be able to access our Telescope app.</p>
<p><img src="img/hqfejMwnFV.png" alt="Telescope Running as a Pod"></p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h3 id="deleting-our-pod">Deleting Our Pod</h3>
<p>In the next section, we are going to launch our telescope pod in a different way. So, it's a good idea to remove the current pod. Apply the following command to remove it.</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> pod telescope-pod
</code></pre>
<p>"telescope-pod" is the name of our pod. Likewise, you can remove any pod you like. The API of Kubernetes is very predictable. Likewise, you can remove other resources as well.</p>
<p>So, here's the generic API for deleting resources:</p>
<pre><code class="lang-shell hljs xml">kubectl delete <span class="hljs-tag">&lt;<span class="hljs-title">resource-type</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">resource-name</span>&gt;</span>
</code></pre>
<p>In this lesson, we are going to learn following key resource types:</p>
<ul>
<li>pod - Kubernetes pod</li>
<li>rc - replication controller</li>
<li>service - Kubernetes service</li>
</ul>
<p>You can delete them as shown below.</p>
<p>Now here's a simple exercise for you. From the following list, select the wrong way of deleting resources:</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      kubectl delete rc my-rc
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl delete service my-service
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl delete rc my-rc-2
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      kubectl service delete my-service2
    </label>
  </div>
  

  
    <p>
      Correct answer is : kubectl service delete my-service2
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="replicate-our-pod-for-high-availability-and-for-scaling">Replicate Our Pod for High Availability and for Scaling</h2>
<p>As you know already, our pod could get destroyed due to several reasons. If a pod gets destroyed, we need to create a new one. But that's not ideal.</p>
<p>That's where <strong>Replication Controller</strong> is going help us. A replication controller will allow us to run multiple pods (knowns as replicas) and maintain the replica count by starting new pods and removing excess pods.</p>
<p>Creating a replication controller is simple. Simply add following content into a filename called "telescope-rc.json".</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
            </span>}]
          </span>},
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://localhost:27017/app"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>In this definition, we need pay attention to few things. Let's discuss.</p>
<h4 id="spec-template-spec">spec.template.spec</h4>
<p>This is very similar to the our previous pod definition. </p>
<h4 id="spec-template-metadata-labels">spec.template.metadata.labels</h4>
<p>Here is something very important: Now we are creating multiple pods. The replication controller and other resources of Kubernetes need to identify these pods. That means we need to filter these pods from others. Labels are the way to do that.</p>
<p>Labels are simply a set of key value pairs. So with <code>spec.template.metadata.labels</code> we ask the replication controller to label our pod with the given set of key value pairs.</p>
<h4 id="spec-selector">spec.selector</h4>
<p>This is the selector where the replication controller selects pods and maintains the number of replicas. Normally, these will be the labels you defined in <code>spec.template.metadata.labels</code>. Then, this replication controller looks for all the matching pods in the cluster and tries to maintain the <code>spec.replicas</code> count.</p>
<h3 id="let-s-deploy-a-replication-controller">Let's Deploy a Replication Controller</h3>
<p>Simply apply the following command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<p>You can call <code>kubectl get rc</code> and confirm whether the replication controller is running or not.</p>
<p>Now try to invoke following command:</p>
<pre><code class="lang-shell hljs bash">kubectl get pods <span class="hljs-operator">-l</span> <span class="hljs-built_in">type</span>=telescope
</code></pre>
<p>Then you'll get a list of pods running with the label "type=telescope". </p>
<p><img src="img/LOnv-fH0kJ.png" alt="Running Kubernetes Pods"></p>
<p>Check their pod names. They are dynamically created with adding a prefix to the replication controller name. As usual, you can access each of these pods with the allocated IP address.<br>(You need invoke <code>kubectl describe pod &lt;pod-name&gt;</code> to see the IP address)</p>
<hr>
<p>So, it's a time for a question.<br>Try to delete our replication controller with following command:</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>So, what will happen to the pods it created before?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      They'll be there with their "Running" status.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      They'll get removed.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      They'll be there with their "Pending" status.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Ask us to delete pods first.
    </label>
  </div>
  

  
    <p>
      Correct answer is : They'll get removed.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="scaling-replicas">Scaling Replicas</h2>
<p>We will need scale(or resize) replicas for scaling purposes or to improve the availability.</p>
<p>We can scale the replica count by just using a command. Before that, we need to create the replication controller again (because we removed it in the previous section).</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<p>Now let's resize our replica count to 5.</p>
<pre><code class="lang-shell hljs sql">kubectl scale <span class="hljs-comment">--replicas=5 rc telescope-rc</span>
</code></pre>
<p>You can verify the replica count by running <code>kubectl get pods -l type=telescope</code> again. You can set <code>replicas=0</code> to remove the telescope app from the cluster.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="load-balancing-pods-with-kubernetes-service">Load Balancing Pods with Kubernetes Service</h2>
<p>Now we've got a set of pods running our telescope app. So, we need to load-balance traffic to them. That's where Kubernetes service comes in. It's a network layer load balancer. It also have basic sticky session support using the client's IP and port.</p>
<h3 id="creating-the-service">Creating the Service</h3>
<p>Add following content to a filename called "telescope-service.json".</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]</span>,
    "<span class="hljs-attribute">sessionAffinity</span>": <span class="hljs-value"><span class="hljs-string">"ClientIP"</span>
  </span>}
</span>}
</code></pre>
<p>Let's look at some of these fields.</p>
<ul>
<li>spec.selector - selects a set of pods (backends) based on labels</li>
<li>spec.ports[0].port - external port of the load balancer where users need to send requests</li>
<li>spec.ports[0].targetPort - the port of the pod where service needs to forward requests</li>
<li>spec.sessionAffinity - enabled sticky sessions and select the algorithm. This is disabled by default. <code>ClientIP</code> is the only supported algorithm for now.</li>
</ul>
<p>So, it's time to deploy our service. You can do it with this command:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-service.json
</span></code></pre>
<p>You can check it by running following command:</p>
<pre><code class="lang-shell hljs nginx"><span class="hljs-title">kubectl</span> get services
</code></pre>
<p>Then it will give you something like this:</p>
<p><img src="img/oTWoVbUEWs.png" alt="List of Services"></p>
<p>You can use the IP assigned to service to access your pod. It will load-balance the traffic in round-robin fashion with the sticky session support.</p>
<hr>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="deploying-our-own-mongodb-service">Deploying Our Own MongoDB Service</h2>
<p>In the telescope replication controller, we used a separate mongo instance for each telescope instance. But for a real app, we need to use a single database for all instances. Let's try to create a MongoDB service here inside Kubernetes and use it as the database for all of our telescope instances.</p>
<p>So, these are the things we are going to do:</p>
<ol>
<li>Create a Mongo replication controller with one replica.</li>
<li>Create a service targeting the above mongo pods.</li>
</ol>
<p>Here's our replication controller. ("mongo-rc.json")</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span></span>,
            "<span class="hljs-attribute">command</span>": <span class="hljs-value">[<span class="hljs-string">"mongod"</span>, <span class="hljs-string">"--smallfiles"</span>, <span class="hljs-string">"--nojournal"</span>]</span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
            </span>}]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Create it with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f mongo-rc.json
</span></code></pre>
<p>Here's the definition for our service ("mongo-service.json"):</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"mongo-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"mongo"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">27017</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">27017</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>Then create the service with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f mongo-service.json
</span></code></pre>
<p>Okay. Now we've a running MongoDB service in our cluster. Nice. </p>
<h3 id="using-the-new-mongo-service">Using the New Mongo Service</h3>
<p>So, first we need delete the existing telescope replication controller (It'll remove created pods as well).</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>Now here's our new replication controller for telescope.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Everything is just as it was, except for two changes:</p>
<ul>
<li>We removed the MongoDB container from the pod</li>
<li>We changed the MONGO_URL environment variable to <code>mongodb://mongo-service:27017/mydb</code>. So, what's "mongo-service:27017"? </li>
</ul>
<p>That's our mongo service's name and the port. By using the above MONGO_URL we can access our running MongoDB service. Similarly, we can access any running service via DNS using similar URLs. That is the beauty of Kubernetes services. This is also the basic building block for Microservices. (We'll talk about Microservices in a moment.)</p>
<p>So, let's create the updated replication controller with:</p>
<pre><code class="lang-shell hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc.json
</span></code></pre>
<hr>
<p>So, now let us ask simple question from you?</p>
<p>When defining our mongo replication controller, we've specified only a single replica. Is there any special reason for that?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      No.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, we need to have more RAM to run multiple mongo containers. We specify only one replica because we are not sure about the RAM of your server.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, running multiple mongo containers itself does not scale MongoDB.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Yes, in order to do that we need have at least two physical servers.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Yes, running multiple mongo containers itself does not scale MongoDB.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="deploying-new-versions-with-rolling-updates">Deploying New Versions with Rolling Updates</h2>
<p>Deploying a new version (of the pod) is trickier with Kubernetes. Removing the replication controller does not remove our pods. So, we need to resize it to 0 and resubmit the replication controller. But, when we do that, our app goes down for a few seconds (or minutes). </p>
<p>So, best approach is to do a rolling update, which means that we will add newer versions of pods while removing older ones. We'll add and remove one at a time. With that, we don't need to worry about a service downtime.</p>
<blockquote>
<p>With rolling updates, it's possible to have at least two versions of your app running at the same time. You need to design your app in a way to handle it.</p>
</blockquote>
<p>Fortunately, Kubernetes has a built-in way to do rolling updates. To do that, first we need to track the version of our pod.</p>
<p>Before we do that, let's remove the existing replication controller.</p>
<pre><code class="lang-shell hljs javascript">kubectl <span class="hljs-keyword">delete</span> rc telescope-rc
</code></pre>
<p>Now let's create our new replication controller <code>telescope-rc-v1</code>. Create this file on the server as <code>telescope-rc-v1.json</code> and launch it.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>The above replication controller is just like the previous one, but now it has label field called <strong>version</strong>.</p>
<p>Let's create that:</p>
<pre><code class="hljs sql">kubectl <span class="hljs-operator"><span class="hljs-keyword">create</span> -f telescope-rc-v1.json
</span></code></pre><p>So, let's say now we need to deploy a new version of our telescope app. To do that, first we need to create a new replication controller with a new name. It should contain a different value for the version label as well.</p>
<p>Here it is. Save following content into a file called <code>telescope-rc-v2.json</code> in the server.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope-rc-v2"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">2</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v2"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v2"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"telescope"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"meteorhacks/telescope"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/mydb"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p>Doing the rolling update is simple. Invoke the following command:</p>
<pre><code class="lang-shell hljs sql">kubectl rolling-<span class="hljs-operator"><span class="hljs-keyword">update</span> <span class="hljs-comment">--update-period=5s telescope-rc-v1 -f telescope-rc-v2.json</span>
</span></code></pre>
<p>Then it will remove pods from replication controller "telescope-rc-v1" one by one while adding new pods from the replication controller defined at "telescope-rc-v2.json". After removing all the pods of the old replication controller, it will remove the old replication controller as well.</p>
<p>This is the way that Kubernetes allows us to do rolling updates (or rolling deployments). Still, we need to do few things ourselves like creating a new replication controller. Anyway, the "rolling-update" command is very helpful.</p>
<hr>
<p>Now, here's a simple question for you.</p>
<p>With rolling updates, we used different labels. But we didn't need to update our service. Why was that?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Our service "telescope-service" is looking for pods labeled with "type=telescope version=*". The current labeling method satisfy that.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      The rolling update command automatically update the service.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Our service "telescope-service" is looking for pods labeled with "type=telescope". The current labeling method satisfy that.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Our service didn't work after the rolling update changes.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Our service "telescope-service" is looking for pods labeled with "type=telescope". The current labeling method satisfy that.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    
      <div id="lesson-content">
  <h2 id="microservices-with-kubernetes">Microservices With Kubernetes</h2>
<p>In this lesson, we are going to deploy a set of Meteor microservices into the Kubernetes cluster and see how to enable the communication with each other. For that, we assume there is a mongo service running inside the cluster and we can access it via <code>mongodb://mongo-service:27017</code>.</p>
<p>This is the same set of microservices we deployed with our microservices lesson. It's a simple Meteor package search app with following services:</p>
<ul>
<li>search: app performs the search.</li>
<li>logging: app does the logging.</li>
<li>web: front facing app .</li>
</ul>
<p>At the end, we'll have an app like <a target="_blank" href="https://www.youtube.com/watch?v=v2hIDu4uQrU&amp;feature=youtu.be">this (video)</a>.</p>
<p>Here's the web app's core logic:</p>
<pre><code class="lang-js hljs javascript"><span class="hljs-keyword">var</span> searchConn = DDP.connect(process.env.SEARCH_SERVICE_URL);
<span class="hljs-keyword">var</span> loggingConn = DDP.connect(process.env.LOGGING_SERVICE_URL);

<span class="hljs-comment">// define the source for search using the above search connection.</span>
SearchSource.defineSource(<span class="hljs-string">'packages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(searchText, options)</span> </span>{
  <span class="hljs-comment">// do the logging with the logging connection.</span>
  loggingConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'searching for package: '</span> + searchText);
  <span class="hljs-keyword">return</span> searchConn.call(<span class="hljs-string">'getPackages'</span>, searchText, options);
});

<span class="hljs-comment">// get the top packages from the local db.</span>
Meteor.publish(<span class="hljs-string">'topPackages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// do the logging with the logging connection.</span>
  loggingConn.call(<span class="hljs-string">'log'</span>, <span class="hljs-string">'accessing top packages'</span>);
  <span class="hljs-keyword">var</span> options = {sort: {isoScore: -<span class="hljs-number">1</span>}, limit: <span class="hljs-number">20</span>};
  <span class="hljs-keyword">return</span> Packages.find({}, options);
});
</code></pre>
<p>As you can see, now we simply get the URL of individual service via environment variables and connect to them with "DDP.connect". After that we'll invoke methods on those connections. You can learn more about this app by looking at the <a target="_blank" href="https://github.com/bulletproof-meteor/ms-kube">source code</a>.</p>
<p>All these services reside in a single project. We've published this app to the Docker hub registry (using <a target="_blank" href="https://github.com/meteorhacks/meteord">MeteorD</a>) and we can get individual services via the following Docker images:</p>
<ul>
<li>search - bulletproofmeteor/ms-kube:search</li>
<li>logging - bulletproofmeteor/ms-kube:logging</li>
<li>web - bulletproofmeteor/ms-kube:web</li>
</ul>
<h3 id="launching-services-on-kubernetes">Launching Services on Kubernetes</h3>
<p>Now we are going to launch the above three services on Kubernetes. So, we need a replication controller and a service for each app. Here they are:</p>
<h4 id="search">Search</h4>
<p><strong>search-rc-v1.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:search"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/search"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>search-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"search-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"search"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<h4 id="logging">Logging</h4>
<p><strong>logging-rc-v1.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:logging"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/logging"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>logging-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"logging-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"logging"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<h4 id="web">Web</h4>
<p><strong>web-rc-v1.json</strong></p>
<p>Our web replication controller is just like other two, but it contains environment variables for both logging and search services.</p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web-rc-v1"</span>
  </span>}</span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"ReplicationController"</span></span>,
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">replicas</span>": <span class="hljs-value"><span class="hljs-number">1</span></span>,
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{"<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span></span>}</span>,
    "<span class="hljs-attribute">template</span>": <span class="hljs-value">{
      "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">labels</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>, "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"v1"</span> </span>}
      </span>}</span>,
      "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">containers</span>": <span class="hljs-value">[
          {
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web"</span></span>,
            "<span class="hljs-attribute">image</span>": <span class="hljs-value"><span class="hljs-string">"bulletproofmeteor/ms-kube:web"</span></span>,
            "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[{
              "<span class="hljs-attribute">containerPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
            </span>}]</span>,
            "<span class="hljs-attribute">env</span>": <span class="hljs-value">[
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"ROOT_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://mydomain.com"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"MONGO_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"mongodb://mongo-service:27017/web"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"SEARCH_SERVICE_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://search-service"</span></span>},
              {"<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"LOGGING_SERVICE_URL"</span></span>, "<span class="hljs-attribute">value</span>": <span class="hljs-value"><span class="hljs-string">"http://logging-service"</span></span>}
            ]
          </span>}
        ]
      </span>}
    </span>}
  </span>}
</span>}
</code></pre>
<p><strong>web-service.json</strong></p>
<pre><code class="lang-json hljs">{
  "<span class="hljs-attribute">apiVersion</span>": <span class="hljs-value"><span class="hljs-string">"v1beta3"</span></span>,
  "<span class="hljs-attribute">kind</span>": <span class="hljs-value"><span class="hljs-string">"Service"</span></span>,
  "<span class="hljs-attribute">metadata</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"web-service"</span>
  </span>}</span>,
  "<span class="hljs-attribute">spec</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">selector</span>": <span class="hljs-value">{ "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"web"</span> </span>}</span>,
    "<span class="hljs-attribute">ports</span>": <span class="hljs-value">[
      {
        "<span class="hljs-attribute">port</span>": <span class="hljs-value"><span class="hljs-number">80</span></span>,
        "<span class="hljs-attribute">targetPort</span>": <span class="hljs-value"><span class="hljs-number">80</span>
      </span>}
    ]
  </span>}
</span>}
</code></pre>
<p>Now that we have all the files we need, let's launch these replication controllers and services.</p>
<p>After all these have been launched, you can get service IPs via <code>kubectl get service</code>.</p>
<p>Then try to visit the IP address of the web service from the browser, and you'll be able to search for packages as shown in this <a target="_blank" href="https://www.youtube.com/watch?v=v2hIDu4uQrU&amp;feature=youtu.be">video</a>.</p>
<hr>
<p>Similarly, you can deploy any meteor service you like and connect to each other via "DDP.connect". Since we always have a static URL/IP for the service, it's safe to even hardcode URLs of these services in your code.</p>
<p>So, here's a simple question for you:</p>
<p>Let's say we need to use our search service on the client. What are the changes we need to make?</p>

  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove text-danger"></span>
      
      Use `meteorhacks:cluster` to register these apps and use it to get the connection. Then change the app accordingly.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Just use the URL of the search service in the client with "DDP.connect" to create a connection. Then change the app accordingly.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      We can't do that with Kubernetes.
    </label>
  </div>
  

  <div class="radio">
    <label>
      
        <span class="glyphicon glyphicon-remove invisible"></span>
      
      Just use the URL of the search service in the client with "DDP.connect" to create a connection. (Make sure to expose the search to the Internet via the `createExternalLoadBalancer` flag when doing this for real.) Then change the app to search locally.
    </label>
  </div>
  

  
    <p>
      Correct answer is : Just use the URL of the search service in the client with "DDP.connect" to create a connection. (Make sure to expose the search to the Internet via the `createExternalLoadBalancer` flag when doing this for real.) Then change the app to search locally.
    </p>
  
  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto disabled" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="deploying-a-production-kubernetes-cluster">Deploying a Production Kubernetes Cluster</h2>
<p>We've covered a lot of topics related to Kubernetes, and now you can try to deploy a production cluster.</p>
<h3 id="google-container-engine">Google Container Engine</h3>
<p>Your first choice should be Google's <a target="_blank" href="https://cloud.google.com/container-engine/">Google Container Engine</a>, which is a hosted version of Kubernetes on the Google cloud. This service is still in the alpha stage.</p>
<h3 id="tectonic">TecTonic</h3>
<p><a target="_blank" href="https://tectonic.com/">TecTonic</a> is a service that allows you to deploy a Kubernetes cluster into any cloud provider you like. This service is from the <a target="_blank" href="https://coreos.com/">CoreOS</a> team and backed by Google ventures. So, TecTonic will be a pretty solid service. Right now, it's not open for public, but you can sign up for the beta access.</p>
<h3 id="deploy-your-own">Deploy Your Own</h3>
<p>You can also deploy a Kubernetes cluster on your own. There are a lot of guides available to do that. <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/tree/master/docs/getting-started-guides">Start Here</a>.</p>
<hr>
<p>This is just the early stage of Kubernetes. There'll be a lot of tools and services to deploy Kubernetes in the future. So, moving to Kubernetes makes your infrastructure future proof.</p>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Deploying Meteor Apps into a Kubernetes Cluster</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster">
        
          Introduction
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/1">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/2">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/3">
        
          25
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/4">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/5">
        
          35
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/6">
        
          10
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/7">
        
          20
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/8">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/9">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto incorrect" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/10">
        
          30
        
      </a>
    
      <a class="btn btn-default step-goto correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/11">
        
          15
        
      </a>
    
      <a class="btn btn-default step-goto active correct" type="button" href="/architecture/deploying-meteor-apps-into-a-kubernetes-cluster/12">
        
          15
        
      </a>
    
    
  </div>

  

    

    

    
      <div id="lesson-content">
  <h2 id="what-next">What Next</h2>
<p>You've learned about almost all the core topics on using a Kubernetes cluster. We haven't discussed deploying and managing a Kubernetes cluster. That's because we don't really need to worry about that.</p>
<p>Kubernetes is the future of the cloud. It's vendor independent and can be used with any cloud provider you like. So, in the future almost all the cloud providers will support Kubernetes and manage the cluster for you. Then your job will be to use it correctly. <strong>That's what we learned in this lesson.</strong></p>
<h3 id="keep-up-with-kubernetes">Keep Up with Kubernetes</h3>
<p>Kubernetes is an evolving technology, and there is a lot of development happening right now. So, expect breaking changes. When any changes happen, we'll update this lesson and notify you. It's a good idea to watch the development of Kubernetes yourself. Here are some useful Kubernetes resources:</p>
<ul>
<li>Official Web Site: <a target="_blank" href="http://kubernetes.io/">http://kubernetes.io/</a></li>
<li>Github Repo: <a target="_blank" href="https://github.com/googlecloudplatform/kubernetes">https://github.com/googlecloudplatform/kubernetes</a></li>
<li>Releases: <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/releases">https://github.com/GoogleCloudPlatform/kubernetes/releases</a></li>
<li>Roadmap: <a target="_blank" href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/roadmap.md">https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/roadmap.md</a></li>
<li>Blog: <a target="_blank" href="http://kubernetesio.blogspot.com/">http://kubernetesio.blogspot.com/</a></li>
<li>Documented API: <a target="_blank" href="http://kubernetes.io/third_party/swagger-ui/">http://kubernetes.io/third_party/swagger-ui/</a></li>
</ul>

  </div>
</div>
		</div><div><div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
      
    <h2 class="lesson-name">Eventloop and Measuring Eventloop</h2>
  
  <div class="btn-group">
    
      <a class="btn btn-default step-goto active" type="button" href="/nodejs-internals/eventloop-and-measuring-eventloop">
        
          Introduction
        
      </a>
    
    
  </div>

  

    
      <div id="lesson-content">
    <p>We've <a href="https://meteorhacks.com/postponing-nodejs-internals-lessons-on-bulletproof-meteor.html">postponed</a> working on these lessons. <a href="https://meteorhacks.com/postponing-nodejs-internals-lessons-on-bulletproof-meteor.html">Here are the reasons</a> for that.</p>

  </div>
</div>

	</body>
</html>
